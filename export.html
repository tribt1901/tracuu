<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê·ªÅ c∆∞∆°ng m√¥n h·ªçc</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <style>
    body { padding-top: 70px; font-family: Roboto, Arial, sans-serif; }
    .subject-btns .btn { margin-right: 6px; }
    .nav-link, .navbar-brand { font-family: Roboto, Arial, sans-serif; }
    .subject-title-icon { font-size: 1.15em; margin-right: 6px; }
    #pdf-content { display: none; }
    #pdf-content .pdf-title {
      text-align: center; font-size: 22px; font-weight: 700;
      margin-bottom: 12px; margin-top: 10px; font-family: Roboto, Arial, sans-serif;
    }
    #pdf-content .pdf-table-wrap {
      width: 100%; max-width: 100%; box-sizing: border-box; display: flex; justify-content: center;
    }
    #pdf-content table {
      border: 2px solid #222; border-collapse: collapse; margin: 0 auto;
      width: 100%; max-width: 690px; min-width: 300px;
      table-layout: fixed; background: #fff; font-size: 15px; box-sizing: border-box;
      word-break: break-word; overflow-wrap: break-word;
      page-break-inside: auto;
    }
    #pdf-content td, #pdf-content th {
      border: 1.5px solid #222 !important;
      padding: 6px 8px;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      white-space: pre-line !important;
      vertical-align: middle;
      background: #fff;
      box-sizing: border-box !important;
      max-width: 360px;
      overflow: hidden;
      page-break-inside: avoid !important;
      page-break-after: auto !important;
    }
    #pdf-content th {
      background: #fff; font-weight: 700; text-align: center;
    }
    #pdf-content td.stt, #pdf-content th.stt {
      width: 10%; min-width: 38px; max-width: 60px; text-align: center; font-size: 13px;
    }
    #pdf-content td.question, #pdf-content th.question {
      width: 49%; min-width: 110px; max-width: 380px; word-break: break-word; overflow-wrap: break-word;
    }
    #pdf-content td.answer, #pdf-content th.answer {
      width: 41%; min-width: 100px; max-width: 250px; word-break: break-word; overflow-wrap: break-word;
    }
    #pdf-content tr { height: 1px; page-break-inside: avoid !important;}
    #pdf-content table, #pdf-content td, #pdf-content th, #pdf-content tr {
      page-break-inside: avoid !important; break-inside: avoid !important;
    }
    .loading-math { color: #4caf50; font-weight: 700; margin: 8px 0; text-align: center; }
    @media print {
      #pdf-content, .pdf-table-wrap, body, html, table {
        width: 100% !important; max-width: 100% !important; margin: 0; padding: 0; box-sizing: border-box;
      }
      #pdf-content table { max-width: 690px !important; }
    }
  </style>
</head>
<body class="bg-light">
<header id="navbar-placeholder"></header>
<div class="container py-4">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">üìÇ T·∫£i c√¢u h·ªèi & ƒë√°p √°n theo m√¥n</h5>
      <div id="subjectList"><div>ƒêang t·∫£i...</div></div>
    </div>
  </div>
</div>
<div id="pdf-content"></div>
<div id="loading-mathjax" class="loading-math" style="display:none">ƒêang render c√¥ng th·ª©c to√°n h·ªçc, vui l√≤ng ch·ªù...</div>

<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
// ==== FIREBASE CONFIG ====
const firebaseConfig = {
  apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92c",
  authDomain: "tracuu-d3ee9.firebaseapp.com",
  projectId: "tracuu-d3ee9",
  storageBucket: "tracuu-d3ee9.appspot.com",
  messagingSenderId: "593568604435",
  appId: "1:593568604435:web:9a5145457a8ee734143ae6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ==== UTILS ====
function getFirstWord(html) {
  if (!html) return "";
  const n = document.createElement("div");
  n.innerHTML = html;
  const text = n.textContent?.trim() || "";
  const preset = ["ƒê·∫∑t", "Cho", "H√†m"];
  for (const t of preset) if (text.startsWith(t)) return t;
  const i = text.indexOf(" ");
  return i === -1 ? text : text.slice(0, i);
}
function stripHTML(html) {
  if (!html) return "";
  const n = document.createElement("div");
  n.innerHTML = html;
  return n.textContent?.trim() || "";
}
function getAnswer(q) {
  if (!q || !q.lua_chon || q.dap_an_dung === undefined || q.dap_an_dung === null) return "";
  const n = String(q.dap_an_dung);
  return n in q.lua_chon ? q.lua_chon[n] : "";
}
async function getSubjects() {
  return (await db.collection("mon_hoc").get()).docs.map(doc => ({ id: doc.id, ...doc.data() }));
}
async function getQuestionsBySubject(subjId) {
  return (await db.collection("cau_hoi").where("mon_hoc_id", "==", subjId).get()).docs.map(doc => doc.data());
}

// ==== LOAD SUBJECTS ====
async function loadSubjects() {
  const t = document.getElementById("subjectList");
  t.innerHTML = "<div>ƒêang t·∫£i...</div>";
  const n = await getSubjects();
  if (n.length !== 0) {
    t.innerHTML = "";
    n.forEach(subject => {
      const e = document.createElement("div");
      e.className = "d-flex align-items-center justify-content-between border-bottom py-2";
      e.innerHTML = `
        <span class="fw-bold"><span class="subject-title-icon">üìò</span>${subject.ten_mon}</span>
        <div class="subject-btns">
          <button class="btn btn-sm btn-outline-secondary" data-type="txt" data-id="${subject.id}" data-name="${subject.ten_mon}">üìù TXT</button>
          <button class="btn btn-sm btn-outline-success" data-type="xlsx" data-id="${subject.id}" data-name="${subject.ten_mon}">üìä Excel</button>
          <button class="btn btn-sm btn-outline-primary" data-type="pdf" data-id="${subject.id}" data-name="${subject.ten_mon}">üìÑ PDF</button>
        </div>
      `;
      e.querySelector('[data-type="txt"]').addEventListener("click", () => exportTXT(subject.id, subject.ten_mon));
      e.querySelector('[data-type="xlsx"]').addEventListener("click", () => exportXLSX(subject.id, subject.ten_mon));
      e.querySelector('[data-type="pdf"]').addEventListener("click", () => exportPDF(subject.id, subject.ten_mon));
      t.appendChild(e);
    });
  } else {
    t.innerHTML = "<div>Kh√¥ng c√≥ d·ªØ li·ªáu m√¥n h·ªçc.</div>";
  }
}

// ==== EXPORT TXT ====
async function exportTXT(subjectId, subjectName) {
  const e = await getQuestionsBySubject(subjectId);
  if (!e.length) return void alert("Kh√¥ng c√≥ d·ªØ li·ªáu c√¢u h·ªèi cho m√¥n n√†y.");
  const a = e.map(q => ({
    stt: getFirstWord(q.noi_dung),
    question: stripHTML(q.noi_dung),
    answer: stripHTML(getAnswer(q))
  }));
  a.sort((x, y) => x.stt.localeCompare(y.stt, "vi"));
  let i = `ƒê·ªÅ c∆∞∆°ng m√¥n: ${subjectName}\n\n`;
  a.forEach((t, index) => {
    i += `C√¢u ${index + 1}\nKEY: ${t.stt}\nC√¢u h·ªèi: ${t.question}\nƒê√°p √°n ƒë√∫ng: ${t.answer}\n\n`;
  });
  const s = new Blob([i], { type: "text/plain;charset=utf-8" });
  saveAs(s, `DeCuong_${subjectName.replace(/\s+/g, "_")}.txt`);
}

// ==== THAY ƒê·ªîI TO√ÄN B·ªò: H√†m xu·∫•t EXCEL s·ª≠ d·ª•ng ExcelJS ƒë·ªÉ ƒë·ªãnh d·∫°ng ====
async function exportXLSX(subjectId, subjectName) {
    alert('ƒêang chu·∫©n b·ªã file Excel, vui l√≤ng ch·ªù...');
    try {
        const questions = await getQuestionsBySubject(subjectId);
        if (!questions || questions.length === 0) {
            return alert("Kh√¥ng c√≥ d·ªØ li·ªáu c√¢u h·ªèi cho m√¥n n√†y.");
        }

        const dataForSheet = questions.map(q => ({
            key: getFirstWord(q.noi_dung),
            question: stripHTML(q.noi_dung),
            answer: stripHTML(getAnswer(q))
        }));
        dataForSheet.sort((a, b) => a.key.localeCompare(b.key, "vi"));

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("ƒê·ªÅ c∆∞∆°ng");

        // --- B·∫Øt ƒë·∫ßu ƒë·ªãnh d·∫°ng ---

        // 1. Th√™m ti√™u ƒë·ªÅ ch√≠nh v√† g·ªôp √¥
        const titleRow = worksheet.addRow([`ƒê·ªÅ c∆∞∆°ng m√¥n: ${subjectName}`]);
        titleRow.font = { name: 'Roboto', size: 16, bold: true };
        worksheet.mergeCells('A1:C1');
        titleRow.getCell(1).alignment = { vertical: 'middle', horizontal: 'center' };
        worksheet.getRow(1).height = 30;

        // Th√™m m·ªôt h√†ng tr·ªëng
        worksheet.addRow([]);

        // 2. Th√™m h√†ng ti√™u ƒë·ªÅ c·ªôt (header)
        const headerRow = worksheet.addRow(['KEY', 'C√¢u h·ªèi', 'ƒê√°p √°n ƒë√∫ng']);
        headerRow.eachCell((cell) => {
            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF3B5C94' } // M√†u xanh gi·ªëng navbar
            };
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
        });
        worksheet.getRow(3).height = 25;


        // 3. Th√™m d·ªØ li·ªáu c√¢u h·ªèi v√† ƒë·ªãnh d·∫°ng t·ª´ng √¥
        dataForSheet.forEach(d => {
            const row = worksheet.addRow([d.key, d.question, d.answer]);
            row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
                cell.alignment = { 
                    vertical: 'middle', 
                    horizontal: colNumber === 1 ? 'center' : 'left', // CƒÉn gi·ªØa c·ªôt KEY
                    wrapText: true 
                };
            });
        });

        // 4. Thi·∫øt l·∫≠p ƒë·ªô r·ªông c·ªôt
        worksheet.getColumn('A').width = 15;
        worksheet.getColumn('B').width = 70;
        worksheet.getColumn('C').width = 50;

        // --- K·∫øt th√∫c ƒë·ªãnh d·∫°ng ---

        // 5. T·∫°o file v√† k√≠ch ho·∫°t t·∫£i v·ªÅ
        workbook.xlsx.writeBuffer().then((buffer) => {
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, `DeCuong_${subjectName.replace(/\s+/g, "_")}.xlsx`);
        });

    } catch (error) {
        console.error("L·ªói khi xu·∫•t Excel:", error);
        alert("ƒê√£ c√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh xu·∫•t file Excel.");
    }
}


// ==== KaTeX RENDER ====
function renderKatexForElement(el) {
  if (el && window.renderMathInElement) {
    window.renderMathInElement(el, {
      delimiters: [
        { left: "\\[", right: "\\]", display: true },
        { left: "\\(", right: "\\)", display: false }
      ],
      throwOnError: false
    });
  }
}

// ==== EXPORT PDF ====
async function exportPDF(subjectId, subjectName) {
  const e = await getQuestionsBySubject(subjectId);
  if (!e || !e.length) return void alert("Kh√¥ng c√≥ d·ªØ li·ªáu c√¢u h·ªèi cho m√¥n n√†y.");
  document.getElementById("loading-mathjax").style.display = "block";
  const a = e.map(q => ({
    stt: getFirstWord(q.noi_dung),
    question: q.noi_dung ? String(q.noi_dung) : "",
    answer: getAnswer(q) ? String(getAnswer(q)) : ""
  }));
  a.sort((x, y) => x.stt.localeCompare(y.stt, "vi"));
  let rows = '';
  a.forEach(t => {
    rows += `<tr>
      <td class="stt">${t.stt}</td>
      <td class="question">${t.question}</td>
      <td class="answer"><div>${t.answer}</div></td>
    </tr>`;
  });
  const s = document.getElementById("pdf-content");
  s.innerHTML = `<div class="pdf-title">ƒê·ªÅ c∆∞∆°ng m√¥n: ${subjectName}</div>
    <div class="pdf-table-wrap">
    <table>
      <thead>
        <tr>
          <th class="stt">KEY</th>
          <th class="question">C√¢u h·ªèi</th>
          <th class="answer">ƒê√°p √°n ƒë√∫ng</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
    </div>`;
  s.style.display = "block";
  renderKatexForElement(s);
  setTimeout(async () => {
    const opt = {
      margin: [10, 10, 10, 10],
      filename: `DeCuong_${subjectName.replace(/\s+/g, "_")}.pdf`,
      html2canvas: {
        scale: 3,
        useCORS: true,
        dpi: 192,
        logging: false,
        scrollY: 0
      },
      jsPDF: {
        unit: "mm",
        format: "a4",
        orientation: "portrait"
      },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };
    await html2pdf().set(opt).from(s).save();
    s.style.display = "none";
    document.getElementById("loading-mathjax").style.display = "none";
  }, 700);
}

// ==== INIT ====
loadSubjects();
</script>
  <script>
  // T·∫£i n·ªôi dung c·ªßa file nav.html
  fetch('/menu.html') // Quan tr·ªçng: ƒê∆∞·ªùng d·∫´n n√†y ph·∫£i tr·ªè ƒë√∫ng file nav.html
    .then(response => response.text())
    .then(data => {
      // Ch√®n n·ªôi dung menu v√†o th·∫ª "navbar-placeholder"
      document.getElementById('navbar-placeholder').innerHTML = data;
    });
  </script>
</body>
</html>
