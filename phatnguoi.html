<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra cứu phạt nguội — Tra cứu phạt nguội toàn quốc 2025</title>
  <meta name="description" content="Tra cứu phạt nguội ô tô, xe máy toàn quốc. Hướng dẫn lấy captcha và gửi yêu cầu tra cứu qua proxy (Vercel)." />
  <meta name="robots" content="index,follow" />

  <style>
    :root{
      --accent:#E10054;
      --primary:#0ea5ff;
      --bg:#f6f8fb;
      --card:#fff;
      --muted:#6b7280;
      --maxw:980px;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, Helvetica, sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:var(--maxw);margin:28px auto;padding:18px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(16,24,40,.06)}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .brand{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700}
    h1{font-size:20px;margin:0}
    form{display:grid;grid-template-columns:1fr 240px;gap:12px;align-items:end}
    @media(max-width:720px){form{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text], select{width:100%;padding:10px;border:1px solid #e6e9ee;border-radius:8px;font-size:15px;box-sizing:border-box}
    .radios{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;padding:12px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .note{font-size:13px;color:var(--muted);margin-top:10px}
    #result{margin-top:14px;border-radius:10px;padding:14px;background:#fbfdff;border:1px solid #eef2f7;min-height:120px}
    .violation{padding:10px;border-radius:8px;background:#fff;margin-bottom:10px;border:1px solid #f0f3f8;display:flex;justify-content:space-between;gap:12px}
    .muted{color:var(--muted)}
    .links{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .linkbtn{background:#fff;border:1px solid #e6e9ee;padding:8px 10px;border-radius:8px;text-decoration:none;color:#111;font-size:14px}
    .small{font-size:13px;color:var(--muted)}
    pre.debug{background:#111;color:#fff;padding:8px;border-radius:6px;overflow:auto;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-labelledby="title">
      <header>
        <div class="brand" aria-hidden="true">PN</div>
        <div>
          <h1 id="title">Tra cứu phạt nguội — Toàn quốc 2025</h1>
          <div class="muted small">Giao diện demo: hỗ trợ luồng lấy captcha và gửi yêu cầu qua proxy server (Vercel)</div>
        </div>
      </header>

      <form id="searchForm" onsubmit="return false;" aria-label="Form tra cứu phạt nguội">
        <div style="grid-column:1/-1;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <div style="flex:1;min-width:220px">
            <label for="bsx">Biển kiểm soát</label>
            <input id="bsx" name="bsx" type="text" placeholder="Ví dụ: 30A12345 hoặc 51F-777.77" inputmode="text" aria-describedby="bsxHelp" oninput="this.value = this.value.toUpperCase()">
            <div id="bsxHelp" class="muted" style="font-size:12px;margin-top:6px">Nhập biển số (chữ in hoa). Bạn sẽ được yêu cầu nhập mã bảo mật (captcha).</div>
          </div>

          <div style="min-width:180px">
            <label for="veh">Loại phương tiện</label>
            <select id="veh" name="veh" aria-label="Chọn loại phương tiện">
              <option value="1">Ô tô</option>
              <option value="2">Xe máy</option>
              <option value="3">Xe máy điện</option>
            </select>
          </div>
        </div>

        <div style="grid-column:1/-1;display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px">
          <div class="radios" aria-hidden="false">
            <label><input type="radio" name="source" value="csgt" checked> Cục CSGT</label>
            <label><input type="radio" name="source" value="sogt"> Sở GTVT</label>
            <label><input type="radio" name="source" value="registry"> Đăng kiểm</label>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button id="btnCaptcha" class="linkbtn" type="button" title="Lấy mã bảo mật">Lấy mã bảo mật</button>
            <button id="btnSearch" class="btn" type="button">Tra cứu</button>
          </div>
        </div>
      </form>

      <div id="result" role="status" aria-live="polite">
        <div id="intro" class="muted">Kết quả sẽ hiển thị ở đây. Nếu bạn chưa cấu hình proxy, trang sẽ hiển thị kết quả mẫu.</div>
      </div>

      <div class="note">
        Lưu ý: phần tra cứu thực tế cần một proxy backend (ví dụ Vercel function) để lấy captcha và gửi form do CORS/captcha/session. Nếu bạn dùng api/tracuu.js trên Vercel, đặt BASE_PROXY thành URL deploy của bạn. Không cố gắng bypass captcha tự động.
        <div class="links">
          <a class="linkbtn" href="https://www.csgt.vn/" target="_blank" rel="noopener">CSGT (chính thức)</a>
          <a class="linkbtn" href="https://phatnguoi.vn/" target="_blank" rel="noopener">phatnguoi.vn</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * Frontend client for tra cứu.
     * Flow:
     * 1) GET  {BASE_PROXY}/api/tracuu?op=captcha&debug=1 => returns { ok, image (dataUrl), cookies, _debug? }
     * 2) Display captcha image to user, prompt to enter code.
     * 3) POST {BASE_PROXY}/api/tracuu with JSON { bsx, type, captcha, cookies } => returns { ok, type:'json'|'html', data|html }
     *
     * IMPORTANT:
     * - Set BASE_PROXY to your deployed proxy origin (no trailing slash) if backend is deployed.
     * - If BACKEND not set, the page uses demo sample data.
     */
    const BASE_PROXY = ''; // <-- REPLACE with your deployed proxy origin, e.g. 'https://your-app.vercel.app'
    const ENDPOINT = '/api/tracuu';

    const bsxInput = document.getElementById('bsx');
    const vehInput = document.getElementById('veh');
    const btnSearch = document.getElementById('btnSearch');
    const btnCaptcha = document.getElementById('btnCaptcha');
    const result = document.getElementById('result');

    // helper to format currency
    function formatCurrency(x){
      try{
        if(typeof x === 'number') return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' ₫';
        return x;
      }catch(e){return x}
    }

    // render structured result (expects object similar to demo)
    function renderResultJson(json) {
      if (!json) {
        result.innerHTML = '<div class="muted">Không có dữ liệu.</div>';
        return;
      }
      const vehicle = json.vehicle || bsxInput.value.toUpperCase() || '—';
      const type = json.type || json.vehicle_type || (vehInput.options[vehInput.selectedIndex] && vehInput.options[vehInput.selectedIndex].text) || '';
      const violations = json.violations || json.data || [];

      if (!violations || violations.length === 0) {
        result.innerHTML = `<div><strong>${vehicle}</strong> — <div style="margin-top:8px;color:#059669;font-weight:700">Không tìm thấy lỗi phạt nguội</div><div class="muted" style="margin-top:8px">Kết quả chỉ mang tính tham khảo.</div></div>`;
        return;
      }

      let html = `<div><strong>${vehicle}</strong> — <span class="muted">${type}</span></div>`;
      html += `<div style="margin-top:10px"><strong style="color:#b91c1c">${violations.length}</strong> lỗi được tìm thấy:</div>`;
      html += '<div style="margin-top:8px">';
      for (const v of violations) {
        const code = v.code || v.rule || v.violation_code || 'LỖI';
        const place = v.place || v.location || v.address || 'Địa điểm không rõ';
        const fine = v.fine || v.fee || '';
        const time = v.time || v.detected_at || '';
        html += `<div class="violation">
                  <div>
                    <div style="font-weight:700">${code}</div>
                    <div class="muted">${place}</div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-weight:700">${fine ? formatCurrency(fine) : ''}</div>
                    <div class="muted">${time}</div>
                  </div>
                </div>`;
      }
      html += '</div>';
      result.innerHTML = html;
    }

    // demo fallback sample result
    function renderSample(bsx) {
      const demo = {
        status:'ok',
        vehicle: bsx || '30A12345',
        type: vehInput.options[vehInput.selectedIndex].text,
        violations:[
          { time:'2025-09-01 07:42', place:'Hà Nội - Nguyễn Trãi', code:'VĐ01', fine:1200000 },
          { time:'2025-08-11 16:20', place:'TP.HCM - Lê Duẩn', code:'VĐ02', fine:800000 }
        ]
      };
      renderResultJson(demo);
    }

    // show modal to get captcha input from user
    function showCaptchaModal(imageDataUrl) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style = 'position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999';
        const box = document.createElement('div');
        box.style = 'background:#fff;padding:18px;border-radius:8px;max-width:420px;width:92%;box-sizing:border-box;text-align:center';
        const title = document.createElement('div');
        title.innerText = 'Nhập mã bảo mật';
        title.style = 'font-weight:700;margin-bottom:8px';
        const img = document.createElement('img');
        img.src = imageDataUrl;
        img.alt = 'Captcha';
        img.style = 'max-width:100%;height:auto;border:1px solid #ddd;padding:6px;border-radius:6px';
        const input = document.createElement('input');
        input.placeholder = 'Nhập mã captcha';
        input.style = 'width:100%;margin-top:10px;padding:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box';
        const ok = document.createElement('button');
        ok.textContent = 'Gửi';
        ok.style = 'margin-top:10px;background:var(--accent);padding:8px 12px;color:#fff;border:0;border-radius:6px;cursor:pointer';
        const cancel = document.createElement('button');
        cancel.textContent = 'Hủy';
        cancel.style = 'margin-top:10px;margin-left:8px;background:#eee;padding:8px 12px;border:0;border-radius:6px;cursor:pointer;color:#333';
        const btnWrap = document.createElement('div');
        btnWrap.style = 'margin-top:8px';
        btnWrap.appendChild(ok);
        btnWrap.appendChild(cancel);
        box.appendChild(title);
        box.appendChild(img);
        box.appendChild(input);
        box.appendChild(btnWrap);
        overlay.appendChild(box);
        document.body.appendChild(overlay);
        input.focus();

        ok.onclick = () => {
          const v = input.value.trim();
          document.body.removeChild(overlay);
          resolve(v || null);
        };
        cancel.onclick = () => {
          document.body.removeChild(overlay);
          resolve(null);
        };
      });
    }

    // fetch captcha from proxy (debug)
    async function fetchCaptcha() {
      const base = BASE_PROXY || '';
      const url = `${base}${ENDPOINT}?op=captcha&debug=1`;
      const r = await fetch(url, { method: 'GET' });
      if (!r.ok) throw new Error(`GET captcha failed: ${r.status}`);
      return r.json();
    }

    // main flow: get captcha, ask user, post with cookies
    async function doSearchWithCaptcha(bsx, type) {
      try {
        btnSearch.disabled = true;
        result.innerHTML = '<div class="muted">Chuẩn bị lấy mã bảo mật (captcha)...</div>';

        const j = await fetchCaptcha();
        if (!j.ok) {
          result.innerHTML = `<div style="color:#b91c1c">Lỗi khi lấy captcha: ${j.error || JSON.stringify(j)}</div>`;
          return;
        }
        const image = j.image;
        const cookies = j.cookies || '';
        const userCode = await showCaptchaModal(image);
        if (!userCode) {
          result.innerHTML = '<div class="muted">Bạn đã hủy thao tác.</div>';
          return;
        }

        result.innerHTML = '<div class="muted">Đang gửi yêu cầu tra cứu, xin chờ...</div>';

        const postUrl = (BASE_PROXY || '') + ENDPOINT;
        const payload = { bsx, type, captcha: userCode, cookies };

        const r2 = await fetch(postUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!r2.ok) {
          const txt = await r2.text().catch(()=>'');
          result.innerHTML = `<div style="color:#b91c1c">Lỗi proxy: ${r2.status} ${r2.statusText}<pre class="debug">${txt}</pre></div>`;
          return;
        }
        const resObj = await r2.json();
        // handle response variants
        if (resObj.ok && resObj.type === 'json') {
          renderResultJson(resObj.data);
        } else if (resObj.ok && resObj.type === 'html') {
          // If server returns HTML, show it (or parse as needed)
          result.innerHTML = resObj.html;
        } else if (resObj.ok && resObj.data) {
          renderResultJson(resObj.data);
        } else {
          result.innerHTML = `<pre class="debug">${JSON.stringify(resObj, null, 2)}</pre>`;
        }
      } catch (err) {
        result.innerHTML = `<div style="color:#b91c1c">Lỗi: ${err.message}</div>`;
      } finally {
        btnSearch.disabled = false;
      }
    }

    // attach events
    btnCaptcha.addEventListener('click', async () => {
      // quick manual fetch to show captcha (no immediate search)
      if (!BASE_PROXY) {
        alert('BASE_PROXY chưa được cấu hình. Set BASE_PROXY = your-proxy-origin để sử dụng captcha thực tế.');
        return;
      }
      try {
        btnCaptcha.disabled = true;
        result.innerHTML = '<div class="muted">Lấy mã bảo mật...</div>';
        const j = await fetchCaptcha();
        if (j.ok && j.image) {
          // show modal to allow user to copy code (do not trigger search automatically)
          const code = await showCaptchaModal(j.image);
          if (code) {
            result.innerHTML = `<div class="muted">Bạn đã nhập mã: <strong>${code}</strong>. Bấm Tra cứu để gửi.</div>`;
            // store cookies in a temporary attribute for later if desired
            result.dataset.lastCookies = j.cookies || '';
            result.dataset.lastCaptcha = code;
          } else {
            result.innerHTML = '<div class="muted">Đã hủy.</div>';
          }
        } else {
          result.innerHTML = `<div style="color:#b91c1c">Lỗi lấy captcha: ${j.error || JSON.stringify(j)}</div>`;
        }
      } catch (e) {
        result.innerHTML = `<div style="color:#b91c1c">Lỗi khi lấy captcha: ${e.message}</div>`;
      } finally {
        btnCaptcha.disabled = false;
      }
    });

    btnSearch.addEventListener('click', () => {
      const bsx = bsxInput.value.trim().toUpperCase();
      const type = vehInput.value;
      if (!bsx) {
        result.innerHTML = '<div style="color:#b91c1c;font-weight:700">Vui lòng nhập biển số.</div>';
        bsxInput.focus();
        return;
      }
      if (!BASE_PROXY) {
        // demo
        result.innerHTML = '<div class="muted">Không có proxy — hiển thị kết quả mẫu (demo).</div>';
        setTimeout(()=> renderSample(bsx), 400);
        return;
      }
      doSearchWithCaptcha(bsx, type);
    });

    // keyboard: Enter triggers search
    bsxInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnSearch.click();
      }
    });
  </script>
</body>
</html>
