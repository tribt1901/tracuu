<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="UTF-8">
Â  <title>ğŸ§  OCR + Excel + Nháº­p/Äá»c CÃ¢u Há»i</title>

Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â Â 
Â  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
Â Â 
Â  <style>
Â  Â  body { font-family: "Segoe UI", sans-serif; background: #f5f7fb; margin: 0; padding: 20px; padding-top: 70px; }
Â  Â  .container { background: white; border-radius: 14px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 25px; max-width: 900px; margin: auto; }
Â  Â  h1 { text-align: center; color: #0078d7; margin-bottom: 30px; }
Â  Â  fieldset { border: 2px solid #0078d7; border-radius: 10px; margin-top: 15px; padding: 15px; }
Â  Â  legend { color: #0078d7; font-weight: bold; padding: 0 10px; }
Â  Â  input[type="file"], textarea, button, select { margin-top: 10px; font-size: 15px; }
Â  Â  textarea { width: 100%; height: 90px; border-radius: 8px; border: 1px solid #ccc; padding: 10px; }
Â  Â  select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
Â  Â  button { background: #0078d7; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; margin-top: 10px; }
Â  Â  button:hover { background: #005fa3; }
Â  Â  #output, #answer { background: #f1f1f1; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 50px; white-space: pre-wrap; }
Â  Â  #similarityBar { height: 12px; background: #ccc; border-radius: 10px; overflow: hidden; margin-top: 10px; }
Â  Â  #similarityFill { height: 100%; width: 0%; background: #0078d7; transition: width 0.4s; }
Â  </style>
</head>
Â  <body class="bg-light">
<header id="navbar-placeholder"></header>
<body>
Â  <div class="container">
Â  Â  <h1>ğŸ§  OCR + Excel + Nháº­p/Äá»c CÃ¢u Há»i</h1>

Â  Â  <fieldset>
Â  Â  Â  <legend>1ï¸âƒ£ Chá»n Nguá»“n Dá»¯ Liá»‡u ÄÃ¡p ÃN:</legend>
      Â  Â  Â  <label><input type="radio" name="dataSource" value="firebase"> â˜ï¸ CSDL Tra cá»©u HG</label>
Â  Â  Â  <label><input type="radio" name="dataSource" value="excel" checked> ğŸ“‚ File Excel (.xlsx)</label>
Â  Â  Â  <label><input type="radio" name="dataSource" value="text"> ğŸ“„ File Text (.txt)</label>

      Â  Â  Â  <div id="firebaseDataSourceArea" style="display:none;">
Â  Â  Â  Â  <select id="subjectSelect">
Â  Â  Â  Â  Â  <option value="">-- Äang táº£i danh sÃ¡ch mÃ´n... --</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <button id="loadFirebaseBtn">âš¡ Náº¡p dá»¯ liá»‡u CSDL</button>
Â  Â  Â  Â  <p id="firebaseStatus">ChÆ°a náº¡p dá»¯ liá»‡u CSDL.</p>
Â  Â  Â  </div>

Â  Â  Â  <div id="excelDataSourceArea" style="display:block;">
Â  Â  Â  Â  <input type="file" id="excelInput" accept=".xlsx">
Â  Â  Â  Â  <p id="excelStatus">ChÆ°a táº£i file Excel.</p>
Â  Â  Â  </div>

Â  Â  Â  <div id="textDataSourceArea" style="display:none;">
Â  Â  Â  Â  <input type="file" id="textInput" accept=".txt">
Â  Â  Â  Â  <p id="textStatus">ChÆ°a táº£i file Text (.txt).</p>
Â  Â  Â  </div>
Â  Â  </fieldset>

Â  Â  <fieldset>
Â  Â  Â  <legend>2ï¸âƒ£ Chá»n cÃ¡ch nháº­p cÃ¢u há»i:</legend>
Â  Â  Â  <label><input type="radio" name="inputMode" value="image" checked> ğŸ–¼ï¸ áº¢nh (OCR)</label>
Â  Â  Â  <label><input type="radio" name="inputMode" value="text"> âœï¸ Nháº­p vÄƒn báº£n</label>
Â  Â  Â  <label><input type="radio" name="inputMode" value="voice"> ğŸ¤ Äá»c báº±ng giá»ng nÃ³i</label>
Â  Â  Â  <div id="imageInputArea">
Â  Â  Â  Â  <input type="file" id="imageInput" accept="image/*">
Â  Â  Â  Â  <p id="imageStatus">ChÆ°a chá»n áº£nh.</p>
Â  Â  Â  </div>
Â  Â  Â  <div id="textInputArea" style="display:none;">
Â  Â  Â  Â  <textarea id="manualText" placeholder="Nháº­p cÃ¢u há»i táº¡i Ä‘Ã¢y..."></textarea>
Â  Â  Â  Â  <button id="searchTextBtn">ğŸ” Tra Ä‘Ã¡p Ã¡n</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="voiceInputArea" style="display:none;">
Â  Â  Â  Â  <button id="startVoice">ğŸ™ï¸ Báº¯t Ä‘áº§u nÃ³i</button>
Â  Â  Â  Â  <p id="voiceStatus">ChÆ°a nÃ³i gÃ¬...</p>
Â  Â  Â  </div>
Â  Â  </fieldset>
Â  Â Â 
Â  Â  <fieldset>
Â  Â  Â  <legend>ğŸ“‹ CÃ¢u há»i nháº­n Ä‘Æ°á»£c:</legend>
Â  Â  Â  <div id="output">ChÆ°a nháº­n dáº¡ng.</div>
Â  Â  </fieldset>

Â  Â  <fieldset>
Â  Â  Â  <legend>ğŸ’¡ ÄÃ¡p Ã¡n tÃ¬m Ä‘Æ°á»£c:</legend>
Â  Â  Â  <div id="answer">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>
Â  Â  Â  <div id="similarityBar"><div id="similarityFill"></div></div>
Â  Â  Â  <button id="speakBtn" disabled>ğŸ”Š Äá»c Ä‘Ã¡p Ã¡n</button>
Â  Â  </fieldset>
Â  </div>

Â  <script>
Â  Â  let excelData = [];Â 
Â  Â  const output = document.getElementById("output");
Â  Â  const answer = document.getElementById("answer");
Â  Â  const imageStatus = document.getElementById("imageStatus");
Â  Â  const excelStatus = document.getElementById("excelStatus");
Â  Â  const firebaseStatus = document.getElementById("firebaseStatus");
Â  Â  const textStatus = document.getElementById("textStatus");
Â  Â  const similarityFill = document.getElementById("similarityFill");

Â  Â  // --- Khá»Ÿi táº¡o Firebase ---
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92M",
Â  Â  Â  authDomain: "tracuu-d3ee9.firebaseapp.com",
Â  Â  Â  projectId: "tracuu-d3ee9",
Â  Â  Â  storageBucket: "tracuu-d3ee9.appspot.com",
Â  Â  Â  messagingSenderId: "593568604435",
Â  Â  Â  appId: "1:593568604435:web:9a5145457a8ee734143ae6",
Â  Â  Â  measurementId: "G-R0M6Y502NP"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore();Â 

Â  Â  // --- Chuyá»ƒn Ä‘á»•i khu vá»±c nháº­p ---
Â  Â  document.querySelectorAll('input[name="inputMode"]').forEach(r => {
Â  Â  Â  r.addEventListener('change', () => {
Â  Â  Â  Â  document.getElementById("imageInputArea").style.display = r.value === "image" ? "block" : "none";
Â  Â  Â  Â  document.getElementById("textInputArea").style.display = r.value === "text" ? "block" : "none";
Â  Â  Â  Â  document.getElementById("voiceInputArea").style.display = r.value === "voice" ? "block" : "none";
Â  Â  Â  });
Â  Â  });

Â  Â  // --- Chuyá»ƒn Ä‘á»•i NGUá»’N Dá»® LIá»†U ---
Â  Â  document.querySelectorAll('input[name="dataSource"]').forEach(r => {
Â  Â  Â  r.addEventListener('change', () => {
Â  Â  Â  Â  const val = r.value;
Â  Â  Â  Â  document.getElementById("firebaseDataSourceArea").style.display = val === "firebase" ? "block" : "none";
Â  Â  Â  Â  document.getElementById("excelDataSourceArea").style.display = val === "excel" ? "block" : "none";
Â  Â  Â  Â  document.getElementById("textDataSourceArea").style.display = val === "text" ? "block" : "none";
Â  Â  Â  Â Â 
Â  Â  Â  Â  excelData = [];
Â  Â  Â  Â  firebaseStatus.textContent = "ChÆ°a náº¡p dá»¯ liá»‡u CSDL.";
Â  Â  Â  Â  excelStatus.textContent = "ChÆ°a táº£i file Excel.";
Â  Â  Â  Â  textStatus.textContent = "ChÆ°a táº£i file Text (.txt).";
Â  Â  Â  Â  answer.textContent = "ChÆ°a cÃ³ dá»¯ liá»‡u.";
Â  Â  Â  });
Â  Â  });

Â  Â  // --- Táº£i danh sÃ¡ch mÃ´n há»c tá»« FIRESTORE ---
Â  Â  function loadSubjects() {
Â  Â  Â  const subjectSelect = document.getElementById("subjectSelect");
Â  Â  Â  const subjectsRef = db.collection("mon_hoc");Â 
Â  Â  Â Â 
Â  Â  Â  subjectsRef.get().then(snapshot => {
Â  Â  Â  Â  if (!snapshot.empty) {
Â  Â  Â  Â  Â  subjectSelect.innerHTML = '<option value="">-- Chá»n mÃ´n há»c --</option>';
Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  const subjectKey = doc.id;
Â  Â  Â  Â  Â  Â  const subjectName = doc.data().ten_mon; 
Â  Â  Â  Â  Â  Â  if (subjectName) {
Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  option.value = subjectKey;Â 
Â  Â  Â  Â  Â  Â  Â  option.textContent = subjectName;Â 
Â  Â  Â  Â  Â  Â  Â  subjectSelect.appendChild(option);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  subjectSelect.innerHTML = '<option value="">-- KhÃ´ng tÃ¬m tháº¥y mÃ´n há»c --</option>';
Â  Â  Â  Â  }
Â  Â  Â  }).catch(error => {
Â  Â  Â  Â  console.error("Lá»—i táº£i danh sÃ¡ch mÃ´n há»c:", error);
Â  Â  Â  Â  subjectSelect.innerHTML = '<option value="">-- Lá»—i táº£i CSDL --</option>';
Â  Â  Â  });
Â  Â  }
Â  Â  // Sá»­a lá»—i nhá»: Chá»‰ táº£i mÃ´n há»c, khÃ´ng tá»± Ä‘á»™ng chuyá»ƒn sang Firebase
Â  Â  document.addEventListener('DOMContentLoaded', loadSubjects);


Â  Â  // --- NÃºt Náº¡p dá»¯ liá»‡u tá»« FIRESTORE ---
Â  Â  document.getElementById("loadFirebaseBtn").addEventListener("click", () => {
Â  Â  Â  const subjectKey = document.getElementById("subjectSelect").value;Â 
Â  Â  Â  if (!subjectKey) {
Â  Â  Â  Â  firebaseStatus.textContent = "âš ï¸ Vui lÃ²ng chá»n má»™t mÃ´n há»c.";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  firebaseStatus.textContent = "ğŸ”„ Äang táº£i dá»¯ liá»‡u...";
Â  Â  Â  excelData = [];Â 
Â  Â  Â  const questionsRef = db.collection("cau_hoi").where("mon_hoc_id", "==", subjectKey);
Â  Â  Â Â 
Â  Â  Â  questionsRef.get().then(snapshot => {
Â  Â  Â  Â  if (!snapshot.empty) {
Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  const question = data.noi_dung;Â 
Â  Â  Â  Â  Â  Â  const correctKey = data.dap_an_dung;Â 
Â  Â  Â  Â  Â  Â  const choices = data.lua_chon;Â 
Â  Â  Â  Â  Â  Â  let answerText = "KhÃ´ng cÃ³ Ä‘Ã¡p Ã¡n";Â 
Â  Â  Â  Â  Â  Â  if (choices && correctKey && choices[correctKey]) {
Â  Â  Â  Â  Â  Â  Â  answerText = choices[correctKey];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  excelData.push({ question: question || "", answer: answerText });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  firebaseStatus.textContent = `âœ… ÄÃ£ náº¡p ${excelData.length} cÃ¢u há»i tá»« CSDL.`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  firebaseStatus.textContent = "âš ï¸ KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i nÃ o cho mÃ´n nÃ y.";
Â  Â  Â  Â  }
Â  Â  Â  }).catch(error => {
Â  Â  Â  Â  console.error("Lá»—i táº£i cÃ¢u há»i:", error);
Â  Â  Â  Â  firebaseStatus.textContent = "âŒ Lá»—i khi táº£i dá»¯ liá»‡u CSDL.";
Â  Â  Â  });
Â  Â  });


Â  Â  // --- Äá»c Excel ---
Â  Â  document.getElementById("excelInput").addEventListener("change", e => {
Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  if (!file) return;
Â  Â  Â  excelStatus.textContent = "ğŸ”„ Äang Ä‘á»c file Excel...";
Â  Â  Â  const reader = new FileReader();
Â  Â  Â Â 
Â  Â  Â  reader.onload = evt => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const wb = XLSX.read(evt.target.result, { type: "array" });Â 
Â  Â  Â  Â  Â  const sheetName = wb.SheetNames[0];
Â  Â  Â  Â  Â  const sheet = wb.Sheets[sheetName];
Â  Â  Â  Â  Â  const text = XLSX.utils.sheet_to_csv(sheet);
Â  Â  Â  Â  Â  const count = parseTextData(text);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  Â  Â  excelStatus.textContent = `âœ… ÄÃ£ náº¡p ${count} cÃ¢u há»i tá»« Excel.`;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  excelStatus.textContent = "âŒ KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u (hÃ£y kiá»ƒm tra Ä‘á»‹nh dáº¡ng file).";
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error("Lá»—i Ä‘á»c file Excel:", err);
Â  Â  Â  Â  Â  excelStatus.textContent = "âŒ Lá»—i khi Ä‘á»c file Excel.";
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  Â  reader.onerror = () => {
Â  Â  Â  Â  Â excelStatus.textContent = "âŒ Lá»—i khi Ä‘á»c file.";
Â  Â  Â  };
Â  Â  Â  reader.readAsArrayBuffer(file);
Â  Â  });

Â  Â Â 
    // *** Sá»¬A Lá»–I: Thay tháº¿ hoÃ n toÃ n hÃ m parseTextData ***
Â  Â  function parseTextData(text) {
Â  Â  Â  Â  excelData = []; // XÃ³a dá»¯ liá»‡u cÅ©
Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  const lines = text.split('\n'); // TÃ¡ch file thÃ nh tá»«ng dÃ²ng

Â  Â  Â  Â  // --- CHUáº¨N 1: Dáº¡ng CSV/Báº£ng (Cho file Excel Dáº¡ng 2) ---
Â  Â  Â  Â  let headerLine = lines.find(line =>Â 
Â  Â  Â  Â  Â  Â  line.toUpperCase().includes("CÃ‚U Há»I") &&Â 
Â  Â  Â  Â  Â  Â  line.toUpperCase().includes("ÄÃP ÃN")
Â  Â  Â  Â  );

Â  Â  Â  Â  if (headerLine) {
Â  Â  Â  Â  Â  Â  const csvSeparator = headerLine.includes(',') ? ',' : '\t';
Â  Â  Â  Â  Â  Â  const headers = headerLine.split(csvSeparator).map(h => h.trim().toUpperCase());
Â  Â  Â  Â  Â  Â  const qIndex = headers.indexOf("CÃ‚U Há»I");
Â  Â  Â  Â  Â  Â  const aIndex = headers.indexOf("ÄÃP ÃN");

Â  Â  Â  Â  Â  Â  if (qIndex !== -1 && aIndex !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  for (const line of lines) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (line === headerLine || line.trim() === "") continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parts = line.split(csvSeparator);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parts.length > Math.max(qIndex, aIndex)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const question = parts[qIndex].trim().replace(/"/g, '');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const answer = parts.slice(aIndex).join(csvSeparator).trim().replace(/"/g, '');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (question && answer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  excelData.push({ question, answer });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  HÃ m Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- CHUáº¨N 2: Dáº¡ng "CÃ¢u há»i:" (Láº·p tá»«ng dÃ²ng) ---
Â  Â  Â  Â  if (count === 0) { // Chá»‰ cháº¡y náº¿u Chuáº©n 1 khÃ´ng tÃ¬m tháº¥y gÃ¬
            let currentQuestion = "";
            const clean = (s) => s.trim().replace(/^"|"$|,$|:$/g, '').trim(); // HÃ m dá»n dáº¹p

Â  Â  Â  Â  Â  Â  for (const line of lines) {
                let trimmedLine = line.trim();
                
                // Xá»­ lÃ½ cÃ¡c dÃ²ng CSV (thÆ°á»ng cÃ³ dáº¡ng "Ná»™i dung",,,)
                if (trimmedLine.startsWith('"')) {
                    trimmedLine = trimmedLine.split('",')[0].substring(1); // Láº¥y pháº§n ná»™i dung
                }

Â  Â  Â  Â  Â  Â  Â  Â  if (trimmedLine.startsWith("CÃ¢u há»i:")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentQuestion = clean(trimmedLine.substring("CÃ¢u há»i:".length));
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
                else if (trimmedLine.startsWith("ÄÃ¡p Ã¡n Ä‘Ãºng:") && currentQuestion) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let answer = clean(trimmedLine.substring("ÄÃ¡p Ã¡n Ä‘Ãºng:".length));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentQuestion && answer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  excelData.push({ question: currentQuestion, answer: answer });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentQuestion = ""; // Reset Ä‘á»ƒ chá» cÃ¢u há»i tiáº¿p theo
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return count; // Tráº£ vá» sá»‘ cÃ¢u há»i náº¡p Ä‘Æ°á»£c
Â  Â  }

Â  Â  // --- Äá»c File Text (.txt) ---
Â  Â  document.getElementById("textInput").addEventListener("change", e => {
Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  textStatus.textContent = "ğŸ”„ Äang Ä‘á»c file Text...";
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = evt => {
Â  Â  Â  Â  Â  Â  const text = evt.target.result;
Â  Â  Â  Â  Â  Â  const count = parseTextData(text); // DÃ¹ng hÃ m thÃ´ng minh
Â  Â  Â  Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  Â  Â  Â  textStatus.textContent = `âœ… ÄÃ£ náº¡p ${count} cÃ¢u há»i tá»« Text.`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  textStatus.textContent = "âŒ KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u (hÃ£y kiá»ƒm tra Ä‘á»‹nh dáº¡ng file).";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.onerror = () => {
Â  Â  Â  Â  Â  Â  Â textStatus.textContent = "âŒ Lá»—i khi Ä‘á»c file .txt";
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  });

Â  Â  // --- OCR áº¢nh ---
Â  Â  document.getElementById("imageInput").addEventListener("change", async e => {
Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  if (!file) return;
Â  Â  Â  imageStatus.textContent = "ğŸ” Äang nháº­n dáº¡ng áº£nh...";
Â  Â  Â  output.textContent = "";
Â  Â  Â  answer.textContent = "";

Â  Â  Â  const result = await Tesseract.recognize(file, "vie+eng", {
Â  Â  Â  Â  logger: m => { if (m.status === "recognizing text") imageStatus.textContent = `ğŸ§  OCR: ${Math.round(m.progress * 100)}%`; }
Â  Â  Â  });

Â  Â  Â  const text = result.data.text.trim();
Â  Â  Â  output.textContent = text || "(KhÃ´ng nháº­n Ä‘Æ°á»£c chá»¯)";
Â  Â  Â  imageStatus.textContent = "âœ… HoÃ n táº¥t OCR.";
Â  Â  Â  if (text) findAnswer(text);
Â  Â  });

Â  Â  // --- Tra theo text ---
Â  Â  document.getElementById("searchTextBtn").addEventListener("click", () => {
Â  Â  Â  const text = document.getElementById("manualText").value.trim();
Â  Â  Â  if (!text) return alert("Nháº­p cÃ¢u há»i trÆ°á»›c!");
Â  Â  Â  output.textContent = text;
Â  Â  Â  findAnswer(text);
Â  Â  });

Â  Â  // --- Voice Recognition ---
Â  Â  let recognition;
Â  Â  if ('webkitSpeechRecognition' in window) {
Â  Â  Â  recognition = new webkitSpeechRecognition();
Â  Â  Â  recognition.lang = "vi-VN";
Â  Â  Â  recognition.continuous = false;
Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  recognition.onresult = e => {
Â  Â  Â  Â  const text = e.results[0][0].transcript;
Â  Â  Â  Â  document.getElementById("voiceStatus").textContent = "âœ… Nghe Ä‘Æ°á»£c: " + text;
Â  Â  Â  Â  output.textContent = text;
Â  Â  Â  Â  findAnswer(text);
Â  Â  Â  };
Â  Â  Â  recognition.onend = () => document.getElementById("voiceStatus").textContent = "â¹ï¸ ÄÃ£ dá»«ng ghi Ã¢m.";
Â  Â  } else {
Â  Â  Â  document.getElementById("voiceStatus").textContent = "âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ giá»ng nÃ³i.";
Â  Â  Â  document.getElementById("startVoice").disabled = true;
Â  Â  }
Â  Â  document.getElementById("startVoice").onclick = () => {
Â  Â  Â  recognition.start();
Â  Â  Â  document.getElementById("voiceStatus").textContent = "ğŸ™ï¸ Äang nghe...";
Â  Â  };

Â  Â  // --- HÃ m tÃ¬m Ä‘Ã¡p Ã¡n ---
Â  Â  function findAnswer(questionText) {
Â  Â  Â  if (!excelData.length) {
Â  Â  Â  Â  answer.textContent = "âš ï¸ Vui lÃ²ng náº¡p dá»¯ liá»‡u (CSDL, Excel, Text) trÆ°á»›c.";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const normalize = s => s.toLowerCase().replace(/\s+/g, " ").trim();
Â  Â  Â  const normalizedOcrText = normalize(questionText);

Â  Â  Â  let best = { score: 0, ans: "KhÃ´ng tÃ¬m tháº¥y cÃ¢u tráº£ lá»i." };

Â  Â  Â  for (let row of excelData) {
Â  Â  Â  Â  const q = row.question || "";Â 
Â  Â  Â  Â  if (!q) continue;Â 
Â  Â  Â  Â  const normalizedDbQuestion = normalize(q);

Â  Â  Â  Â  if (normalizedDbQuestion.length > 5 && normalizedOcrText.includes(normalizedDbQuestion)) {
Â  Â  Â  Â  Â  if (normalizedDbQuestion.length > best.score) {
Â  Â  Â  Â  Â  Â  best = {
Â  Â  Â  Â  Â  Â  Â  score: normalizedDbQuestion.length,
Â  Â  Â  Â  Â  Â  Â  ans: row.answer || ""
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  if (best.score > 0) {
Â  Â  Â  Â  answer.textContent = `âœ… Khá»›p â†’ ${best.ans}`;
Â  Â  Â  Â  similarityFill.style.width = "100%";Â 
Â  Â  Â  Â  similarityFill.style.background = "#28a745";
Â  Â  Â  } else {
Â  Â  Â  Â  answer.textContent = `âŒ KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i khá»›p trong CSDL.`;
Â  Â  Â  Â  similarityFill.style.width = "0%";
Â  Â  Â  Â  similarityFill.style.background = "#dc3545";
Â  Â  Â  }
Â  Â  Â  document.getElementById("speakBtn").disabled = best.score === 0;
Â  Â  }

Â  Â  // --- Äá»c Ä‘Ã¡p Ã¡n ---
Â  Â  document.getElementById("speakBtn").onclick = () => {
Â  Â  Â  const utter = new SpeechSynthesisUtterance(answer.textContent);
Â  Â  Â  utter.lang = "vi-VN";
Â  Â  Â  speechSynthesis.speak(utter);
Â  Â  };
Â  </script>
Â Â 
Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
Â Â 
Â  <script>
Â  fetch('menu.html')Â 
Â  Â  .then(response => response.text())
Â  Â  .then(data => {
Â  Â  Â  document.getElementById('navbar-placeholder').innerHTML = data;
Â  Â  });
Â  </script>
</body>
</html>
