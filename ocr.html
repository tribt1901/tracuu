<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§  OCR + Excel + Nháº­p/Äá»c CÃ¢u Há»i</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase v8 compat (Giá»¯ compat Ä‘á»ƒ dÃ¹ng firebase.firestore() nhÆ° mÃ£ gá»‘c) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    .online-counter-box {
      background-color: #e8f5e9;
      color: #2e7d32;
      border-left: 5px solid #4caf50;
      padding: 10px 16px;
      margin: 20px auto 10px;
      border-radius: 6px;
      max-width: 600px;
      font-weight: 500;
      text-align: center;
    }
    body { font-family: "Segoe UI", sans-serif; background: #f5f7fb; margin: 0; padding: 20px; padding-top: 70px; }
    .container-card { background: white; border-radius: 14px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 25px; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #0078d7; margin-bottom: 30px; }
    fieldset { border: 2px solid #0078d7; border-radius: 10px; margin-top: 15px; padding: 15px; }
    legend { color: #0078d7; font-weight: bold; padding: 0 10px; }
    textarea { width: 100%; height: 90px; border-radius: 8px; border: 1px solid #ccc; padding: 10px; }
    button { background: #0078d7; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #005fa3; }
    #output, #answer { background: #f1f1f1; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 50px; white-space: pre-wrap; }
    #similarityBar { height: 12px; background: #ccc; border-radius: 10px; overflow: hidden; margin-top: 10px; }
    #similarityFill { height: 100%; width: 0%; background: #0078d7; transition: width 0.4s; }
  </style>
</head>
<body class="bg-light">
  <header id="navbar-placeholder"></header>

  <div class="online-counter-box">
    ğŸŸ¢ Hiá»‡n cÃ³ Báº¡n vÃ  <span id="online-counter">0</span> ngÆ°á»i ná»¯a Ä‘ang truy cáº­p há»‡ thá»‘ng.
  </div>

  <div class="container-card">
    <h1>ğŸ§  OCR + Excel + Nháº­p/Äá»c CÃ¢u Há»i</h1>

    <fieldset>
      <legend>1ï¸âƒ£ Chá»n Nguá»“n Dá»¯ Liá»‡u ÄÃ¡p Ãn:</legend>
      <div class="mb-2">
        <label class="me-2"><input type="radio" name="dataSource" value="excel"> ğŸ“‚ File Excel (.xlsx)</label>
        <label class="me-2"><input type="radio" name="dataSource" value="firebase" checked> â˜ï¸ CSDL Tra cá»©u HG</label>
        <label><input type="radio" name="dataSource" value="text"> ğŸ“„ File Text (.txt)</label>
      </div>

      <div id="firebaseDataSourceArea" class="mb-2">
        <select id="subjectSelect" class="form-select w-50 mb-2">
          <option value="">-- Äang táº£i danh sÃ¡ch mÃ´n... --</option>
        </select>
        <button id="loadFirebaseBtn" class="btn btn-sm btn-outline-primary">âš¡ Náº¡p dá»¯ liá»‡u CSDL</button>
        <p id="firebaseStatus" class="mt-2">ChÆ°a náº¡p dá»¯ liá»‡u CSDL.</p>
      </div>

      <div id="excelDataSourceArea" style="display:none;">
        <input type="file" id="excelInput" accept=".xlsx" class="form-control w-50 d-inline-block">
        <a href="template_excel.xlsx" download="Mau_template_Excel.xlsx" class="ms-2">ğŸ“¥ Táº£i file Excel máº«u</a>
        <p id="excelStatus">ChÆ°a táº£i file Excel.</p>
      </div>

      <div id="textDataSourceArea" style="display:none;">
        <input type="file" id="textInput" accept=".txt" class="form-control w-50 d-inline-block">
        <p id="textStatus">ChÆ°a táº£i file Text (.txt).</p>
      </div>
    </fieldset>

    <fieldset>
      <legend>2ï¸âƒ£ Chá»n cÃ¡ch nháº­p cÃ¢u há»i:</legend>
      <div class="mb-2">
        <label class="me-2"><input type="radio" name="inputMode" value="image" checked> ğŸ–¼ï¸ áº¢nh (OCR)</label>
        <label class="me-2"><input type="radio" name="inputMode" value="text"> âœï¸ Nháº­p vÄƒn báº£n</label>
        <label><input type="radio" name="inputMode" value="voice"> ğŸ¤ Äá»c báº±ng giá»ng nÃ³i</label>
      </div>

      <div id="imageInputArea" class="mb-2">
        <input type="file" id="imageInput" accept="image/*" class="form-control w-50">
        <p id="imageStatus" class="mt-2">ChÆ°a chá»n áº£nh.</p>
      </div>

      <div id="textInputArea" style="display:none;">
        <textarea id="manualText" placeholder="Nháº­p cÃ¢u há»i táº¡i Ä‘Ã¢y..."></textarea>
        <button id="searchTextBtn" class="btn btn-sm">ğŸ” Tra Ä‘Ã¡p Ã¡n</button>
      </div>

      <div id="voiceInputArea" style="display:none;">
        <button id="startVoice" class="btn btn-sm">ğŸ™ï¸ Báº¯t Ä‘áº§u nÃ³i</button>
        <p id="voiceStatus" class="mt-2">ChÆ°a nÃ³i gÃ¬...</p>
      </div>
    </fieldset>

    <fieldset>
      <legend>ğŸ“‹ CÃ¢u há»i nháº­n Ä‘Æ°á»£c:</legend>
      <div id="output">ChÆ°a nháº­n dáº¡ng.</div>
    </fieldset>

    <fieldset>
      <legend>ğŸ’¡ ÄÃ¡p Ã¡n tÃ¬m Ä‘Æ°á»£c:</legend>
      <div id="answer">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>
      <div id="similarityBar"><div id="similarityFill"></div></div>
      <button id="speakBtn" disabled>ğŸ”Š Äá»c Ä‘Ã¡p Ã¡n</button>
    </fieldset>
  </div>

  <!-- JS: toÃ n bá»™ logic Ä‘áº·t sau DOM ready -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // tráº¡ng thÃ¡i / dá»¯ liá»‡u
      let excelData = [];
      const output = document.getElementById("output");
      const answer = document.getElementById("answer");
      const imageStatus = document.getElementById("imageStatus");
      const excelStatus = document.getElementById("excelStatus");
      const firebaseStatus = document.getElementById("firebaseStatus");
      const textStatus = document.getElementById("textStatus");
      const similarityFill = document.getElementById("similarityFill");

      // --- Firebase init (v8 compat) ---
      const firebaseConfig = {
        apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92M",
        authDomain: "tracuu-d3ee9.firebaseapp.com",
        projectId: "tracuu-d3ee9",
        storageBucket: "tracuu-d3ee9.appspot.com",
        messagingSenderId: "593568604435",
        appId: "1:593568604435:web:9a5145457a8ee734143ae6",
        measurementId: "G-R0M6Y502NP"
      };
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (err) {
        console.warn("Firebase init warning (already initialized?)", err);
      }
      const db = firebase.firestore();
      const rtdb = firebase.database();

      // --- Realtime DB online counter (compat) ---
      (function initOnlineCounter() {
        const onlineCounterEl = document.getElementById('online-counter');
        if (!onlineCounterEl) return;
        try {
          const connectionsRef = rtdb.ref('connections');
          const myConnectionRef = connectionsRef.push(true);
          // onDisconnect remove
          myConnectionRef.onDisconnect().remove();
          // update onValue
          connectionsRef.on('value', snapshot => {
            const val = snapshot.val();
            let count = 0;
            if (!snapshot.exists()) count = 0;
            else if (val && typeof val === 'object') count = Object.keys(val).length;
            else count = 1;
            onlineCounterEl.textContent = count;
          }, err => console.error('connections.on error', err));
        } catch (err) {
          console.error('Realtime DB init error', err);
        }
      })();

      // --- UI: toggle data source areas ---
      document.querySelectorAll('input[name="dataSource"]').forEach(r => {
        r.addEventListener('change', () => {
          const val = r.value;
          document.getElementById("firebaseDataSourceArea").style.display = val === "firebase" ? "block" : "none";
          document.getElementById("excelDataSourceArea").style.display = val === "excel" ? "block" : "none";
          document.getElementById("textDataSourceArea").style.display = val === "text" ? "block" : "none";
          // reset status when switching
          excelData = [];
          firebaseStatus.textContent = "ChÆ°a náº¡p dá»¯ liá»‡u CSDL.";
          excelStatus.textContent = "ChÆ°a táº£i file Excel.";
          textStatus.textContent = "ChÆ°a táº£i file Text (.txt).";
          answer.textContent = "ChÆ°a cÃ³ dá»¯ liá»‡u.";
          similarityFill.style.width = "0%";
        });
      });

      // --- UI: toggle input mode areas ---
      document.querySelectorAll('input[name="inputMode"]').forEach(r => {
        r.addEventListener('change', () => {
          document.getElementById("imageInputArea").style.display = r.value === "image" ? "block" : "none";
          document.getElementById("textInputArea").style.display = r.value === "text" ? "block" : "none";
          document.getElementById("voiceInputArea").style.display = r.value === "voice" ? "block" : "none";
        });
      });

      // --- Load subjects from Firestore into select ---
      function loadSubjects() {
        const subjectSelect = document.getElementById("subjectSelect");
        subjectSelect.innerHTML = '<option value="">-- Äang táº£i danh sÃ¡ch mÃ´n... --</option>';
        db.collection("mon_hoc").get()
          .then(snapshot => {
            if (!snapshot.empty) {
              subjectSelect.innerHTML = '<option value="">-- Chá»n mÃ´n há»c --</option>';
              snapshot.forEach(doc => {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.textContent = doc.data().ten_mon || doc.id;
                subjectSelect.appendChild(opt);
              });
            } else {
              subjectSelect.innerHTML = '<option value="">-- KhÃ´ng tÃ¬m tháº¥y mÃ´n há»c --</option>';
            }
          })
          .catch(err => {
            console.error('Lá»—i táº£i danh sÃ¡ch mÃ´n há»c:', err);
            subjectSelect.innerHTML = '<option value="">-- Lá»—i táº£i CSDL --</option>';
          });
      }
      loadSubjects();

      // --- Load questions from Firestore for selected subject ---
      document.getElementById("loadFirebaseBtn").addEventListener("click", () => {
        const subjectKey = document.getElementById("subjectSelect").value;
        if (!subjectKey) {
          firebaseStatus.textContent = "âš ï¸ Vui lÃ²ng chá»n má»™t mÃ´n há»c.";
          return;
        }
        firebaseStatus.textContent = "ğŸ”„ Äang táº£i dá»¯ liá»‡u...";
        excelData = [];
        db.collection("cau_hoi").where("mon_hoc_id", "==", subjectKey).get()
          .then(snapshot => {
            if (!snapshot.empty) {
              snapshot.forEach(doc => {
                const d = doc.data();
                const q = d.noi_dung || "";
                let ans = "KhÃ´ng cÃ³ Ä‘Ã¡p Ã¡n";
                if (d.lua_chon && d.dap_an_dung !== undefined && d.dap_an_dung !== null) {
                  const key = String(d.dap_an_dung);
                  if (key in d.lua_chon) ans = d.lua_chon[key];
                }
                excelData.push({ question: q, answer: ans });
              });
              firebaseStatus.textContent = `âœ… ÄÃ£ náº¡p ${excelData.length} cÃ¢u há»i tá»« CSDL.`;
            } else {
              firebaseStatus.textContent = "âš ï¸ KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i nÃ o cho mÃ´n nÃ y.";
            }
          })
          .catch(err => {
            console.error('Lá»—i táº£i cÃ¢u há»i:', err);
            firebaseStatus.textContent = "âŒ Lá»—i khi táº£i dá»¯ liá»‡u CSDL.";
          });
      });

      // --- Read Excel file ---
      document.getElementById("excelInput").addEventListener("change", e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          try {
            const data = evt.target.result;
            const wb = XLSX.read(data, { type: "binary" });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const arr = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            // Normalize to expected shape: {question, answer}
            excelData = arr.map(row => {
              // try common column names
              const question = row.question || row.Question || row["CÃ¢u há»i"] || row["noi_dung"] || "";
              const answerVal = row.answer || row.Answer || row["ÄÃ¡p Ã¡n"] || row["dap_an"] || row["dap_an_dung"] || "";
              return { question: question + "", answer: answerVal + "" };
            }).filter(r => r.question);
            excelStatus.textContent = `âœ… ÄÃ£ náº¡p ${excelData.length} cÃ¢u há»i tá»« Excel.`;
          } catch (err) {
            console.error('Lá»—i Ä‘á»c Excel:', err);
            excelStatus.textContent = "âŒ Lá»—i khi Ä‘á»c file Excel.";
          }
        };
        // Using binary string for compatibility; alternative is readAsArrayBuffer
        reader.readAsBinaryString(file);
      });

      // --- Read Text file (.txt): parseTextData expects format with "CÃ¢u há»i:" and "ÄÃ¡p Ã¡n Ä‘Ãºng:" ---
      function parseTextData(text) {
        const parts = text.split(/CÃ¢u há»i[:ï¼š\s]/i);
        const results = [];
        for (let i = 1; i < parts.length; i++) {
          const chunk = parts[i].trim();
          const answerSplit = chunk.split(/ÄÃ¡p Ã¡n Ä‘Ãºng[:ï¼š]/i);
          if (answerSplit.length >= 2) {
            const q = answerSplit[0].trim().replace(/\s+/g, ' ');
            let a = answerSplit[1].trim();
            // stop at next "CÃ¢u há»i" if present
            const nextQ = a.split(/CÃ¢u há»i[:ï¼š\s]/i)[0].trim();
            a = nextQ.replace(/\s+/g, ' ');
            if (q && a) results.push({ question: q, answer: a });
          }
        }
        return results;
      }

      document.getElementById("textInput").addEventListener("change", e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        textStatus.textContent = "ğŸ”„ Äang Ä‘á»c file Text...";
        const reader = new FileReader();
        reader.onload = evt => {
          try {
            const txt = evt.target.result;
            const parsed = parseTextData(txt);
            excelData = parsed;
            textStatus.textContent = `âœ… ÄÃ£ náº¡p ${parsed.length} cÃ¢u há»i tá»« Text.`;
          } catch (err) {
            console.error('Lá»—i Ä‘á»c text:', err);
            textStatus.textContent = "âŒ Lá»—i khi Ä‘á»c file .txt";
          }
        };
        reader.onerror = () => { textStatus.textContent = "âŒ Lá»—i khi Ä‘á»c file .txt"; };
        reader.readAsText(file, "UTF-8");
      });

      // --- OCR image using Tesseract ---
      document.getElementById("imageInput").addEventListener("change", async e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        imageStatus.textContent = "ğŸ” Äang nháº­n dáº¡ng áº£nh...";
        output.textContent = "";
        answer.textContent = "";
        similarityFill.style.width = "0%";

        try {
          const result = await Tesseract.recognize(file, 'vie+eng', {
            logger: m => {
              if (m.status === 'recognizing text') {
                imageStatus.textContent = `ğŸ§  OCR: ${Math.round(m.progress * 100)}%`;
              }
            }
          });
          const text = (result && result.data && result.data.text) ? result.data.text.trim() : '';
          output.textContent = text || "(KhÃ´ng nháº­n Ä‘Æ°á»£c chá»¯)";
          imageStatus.textContent = "âœ… HoÃ n táº¥t OCR.";
          if (text) findAnswer(text);
        } catch (err) {
          console.error('Tesseract error', err);
          imageStatus.textContent = "âŒ Lá»—i khi OCR áº£nh.";
        }
      });

      // --- Manual text search ---
      document.getElementById("searchTextBtn").addEventListener("click", () => {
        const txt = document.getElementById("manualText").value.trim();
        if (!txt) return alert("Nháº­p cÃ¢u há»i trÆ°á»›c!");
        output.textContent = txt;
        findAnswer(txt);
      });

      // --- Voice recognition (webkit or standard) ---
      let recognition;
      const startVoiceBtn = document.getElementById("startVoice");
      if (window.SpeechRecognition || window.webkitSpeechRecognition) {
        const RecClass = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new RecClass();
        recognition.lang = "vi-VN";
        recognition.interimResults = false;
        recognition.continuous = false;
        recognition.onresult = (ev) => {
          const text = ev.results[0][0].transcript;
          document.getElementById("voiceStatus").textContent = "âœ… Nghe Ä‘Æ°á»£c: " + text;
          output.textContent = text;
          findAnswer(text);
        };
        recognition.onend = () => { document.getElementById("voiceStatus").textContent = "â¹ï¸ ÄÃ£ dá»«ng ghi Ã¢m."; };
        startVoiceBtn.addEventListener("click", () => {
          try {
            recognition.start();
            document.getElementById("voiceStatus").textContent = "ğŸ™ï¸ Äang nghe...";
          } catch (err) { console.error('recognition start error', err); }
        });
      } else {
        document.getElementById("voiceStatus").textContent = "âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ giá»ng nÃ³i.";
        startVoiceBtn.disabled = true;
      }

      // --- Answer matching logic ---
      function normalize(s) {
        return (s || "").toLowerCase().replace(/\s+/g, " ").trim();
      }

      function findAnswer(questionText) {
        if (!excelData || excelData.length === 0) {
          answer.textContent = "âš ï¸ Vui lÃ²ng táº£i file Excel hoáº·c náº¡p dá»¯ liá»‡u CSDL trÆ°á»›c.";
          similarityFill.style.width = "0%";
          document.getElementById("speakBtn").disabled = true;
          return;
        }
        const qNorm = normalize(questionText);
        let best = { score: 0, ans: "" };

        for (const row of excelData) {
          const dbQ = normalize(row.question || "");
          if (!dbQ) continue;
          if (qNorm.includes(dbQ) || dbQ.includes(qNorm)) {
            // score by matched length
            const score = dbQ.length;
            if (score > best.score) {
              best = { score, ans: row.answer || "" };
            }
          } else {
            // fallback: token overlap scoring
            const qTokens = new Set(qNorm.split(/\s+/));
            const dbTokens = (dbQ.split(/\s+/));
            let overlap = 0;
            for (const t of dbTokens) if (qTokens.has(t)) overlap++;
            if (overlap > best.score) {
              best = { score: overlap, ans: row.answer || "" };
            }
          }
        }

        if (best.score > 0 && best.ans) {
          answer.textContent = `âœ… Khá»›p â†’ ${best.ans}`;
          // normalize a 0-100% like display (cap)
          const perc = Math.min(100, Math.round((best.score / 50) * 100));
          similarityFill.style.width = perc + "%";
          similarityFill.style.background = "#28a745";
          document.getElementById("speakBtn").disabled = false;
        } else {
          answer.textContent = "âŒ KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i khá»›p trong CSDL.";
          similarityFill.style.width = "0%";
          similarityFill.style.background = "#dc3545";
          document.getElementById("speakBtn").disabled = true;
        }
      }

      // --- Speak answer ---
      document.getElementById("speakBtn").addEventListener("click", () => {
        const txt = answer.textContent;
        if (!txt) return;
        const u = new SpeechSynthesisUtterance(txt.replace(/^âœ… Khá»›p â†’\s*/, ""));
        u.lang = "vi-VN";
        speechSynthesis.speak(u);
      });

      // --- Optional: fetch menu.html into header if exists ---
      fetch('menu.html').then(r => r.text()).then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
      }).catch(() => {/* ignore */});
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
