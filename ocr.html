<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ğŸ§  OCR + Excel + Nháº­p/Äá»c CÃ¢u Há»i</title>
  
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f5f7fb; margin: 0; padding: 20px; }
    .container { background: white; border-radius: 14px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 25px; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #0078d7; margin-bottom: 30px; }
    h2 { margin-top: 25px; color: #333; }
    fieldset { border: 2px solid #0078d7; border-radius: 10px; margin-top: 15px; padding: 15px; }
    legend { color: #0078d7; font-weight: bold; padding: 0 10px; }
    input[type="file"], textarea, button, select { margin-top: 10px; font-size: 15px; }
    textarea { width: 100%; height: 90px; border-radius: 8px; border: 1px solid #ccc; padding: 10px; }
    select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #0078d7; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #005fa3; }
    #output, #answer { background: #f1f1f1; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 50px; white-space: pre-wrap; }
    #similarityBar { height: 12px; background: #ccc; border-radius: 10px; overflow: hidden; margin-top: 10px; }
    #similarityFill { height: 100%; width: 0%; background: #0078d7; transition: width 0.4s; }
  </style>
</head>
  <body class="bg-light">
<header id="navbar-placeholder"></header>
<body>
  <div class="container">
    <h1>ğŸ§  OCR + Excel + Nháº­p/Äá»c CÃ¢u Há»i</h1>

    <fieldset>
      <legend>1ï¸âƒ£ Chá»n cÃ¡ch nháº­p cÃ¢u há»i:</legend>
      <label><input type="radio" name="inputMode" value="image" checked> ğŸ–¼ï¸ áº¢nh (OCR)</label>
      <label><input type="radio" name="inputMode" value="text"> âœï¸ Nháº­p vÄƒn báº£n</label>
      <label><input type="radio" name="inputMode" value="voice"> ğŸ¤ Äá»c báº±ng giá»ng nÃ³i</label>

      <div id="imageInputArea">
        <input type="file" id="imageInput" accept="image/*">
        <p id="imageStatus">ChÆ°a chá»n áº£nh.</p>
      </div>

      <div id="textInputArea" style="display:none;">
        <textarea id="manualText" placeholder="Nháº­p cÃ¢u há»i táº¡i Ä‘Ã¢y..."></textarea>
        <button id="searchTextBtn">ğŸ” Tra Ä‘Ã¡p Ã¡n</button>
      </div>

      <div id="voiceInputArea" style="display:none;">
        <button id="startVoice">ğŸ™ï¸ Báº¯t Ä‘áº§u nÃ³i</button>
        <p id="voiceStatus">ChÆ°a nÃ³i gÃ¬...</p>
      </div>
    </fieldset>

    <fieldset>
      <legend>2ï¸âƒ£ Chá»n Nguá»“n Dá»¯ Liá»‡u ÄÃ¡p Ãn:</legend>
      <label><input type="radio" name="dataSource" value="excel" checked> ğŸ“‚ File Excel (.xlsx)</label>
      <label><input type="radio" name="dataSource" value="firebase"> â˜ï¸ CSDL Tra cá»©u HG</label>

      <div id="excelDataSourceArea">
        <input type="file" id="excelInput" accept=".xlsx">
        <p id="excelStatus">ChÆ°a táº£i file Excel.</p>
      </div>

      <div id="firebaseDataSourceArea" style="display:none;">
        <select id="subjectSelect">
          <option value="">-- Äang táº£i danh sÃ¡ch mÃ´n... --</option>
        </select>
        <button id="loadFirebaseBtn">âš¡ Náº¡p dá»¯ liá»‡u CSDL</button>
        <p id="firebaseStatus">ChÆ°a náº¡p dá»¯ liá»‡u CSDL.</p>
      </div>
    </fieldset>
    
    <fieldset>
      <legend>ğŸ“‹ CÃ¢u há»i nháº­n Ä‘Æ°á»£c:</legend>
      <div id="output">ChÆ°a nháº­n dáº¡ng.</div>
    </fieldset>

    <fieldset>
      <legend>ğŸ’¡ ÄÃ¡p Ã¡n tÃ¬m Ä‘Æ°á»£c:</legend>
      <div id="answer">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>
      <div id="similarityBar"><div id="similarityFill"></div></div>
      <button id="speakBtn" disabled>ğŸ”Š Äá»c Ä‘Ã¡p Ã¡n</button>
    </fieldset>
  </div>

  <script>
    let excelData = []; // Biáº¿n nÃ y sáº½ chá»©a dá»¯ liá»‡u tá»« Excel HOáº¶C Firebase
    const output = document.getElementById("output");
    const answer = document.getElementById("answer");
    const imageStatus = document.getElementById("imageStatus");
    const excelStatus = document.getElementById("excelStatus");
    const similarityFill = document.getElementById("similarityFill");

    // *** Má»šI: Khá»Ÿi táº¡o Firebase ***
    const firebaseConfig = {
      apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92M",
      authDomain: "tracuu-d3ee9.firebaseapp.com",
      projectId: "tracuu-d3ee9",
      storageBucket: "tracuu-d3ee9.appspot.com",
      messagingSenderId: "593568604435",
      appId: "1:593568604435:web:9a5145457a8ee734143ae6",
      measurementId: "G-R0M6Y502NP"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- Chuyá»ƒn Ä‘á»•i khu vá»±c nháº­p (Giá»¯ nguyÃªn) ---
    document.querySelectorAll('input[name="inputMode"]').forEach(r => {
      r.addEventListener('change', () => {
        document.getElementById("imageInputArea").style.display = r.value === "image" ? "block" : "none";
        document.getElementById("textInputArea").style.display = r.value === "text" ? "block" : "none";
        document.getElementById("voiceInputArea").style.display = r.value === "voice" ? "block" : "none";
      });
    });

    // *** Má»šI: Chuyá»ƒn Ä‘á»•i NGUá»’N Dá»® LIá»†U (Excel/Firebase) ***
    document.querySelectorAll('input[name="dataSource"]').forEach(r => {
      r.addEventListener('change', () => {
        const isExcel = r.value === "excel";
        document.getElementById("excelDataSourceArea").style.display = isExcel ? "block" : "none";
        document.getElementById("firebaseDataSourceArea").style.display = isExcel ? "none" : "block";
        
        // Reset dá»¯ liá»‡u khi chuyá»ƒn Ä‘á»•i
        excelData = [];
        excelStatus.textContent = "ChÆ°a táº£i file Excel.";
        document.getElementById("firebaseStatus").textContent = "ChÆ°a náº¡p dá»¯ liá»‡u CSDL.";
        answer.textContent = "ChÆ°a cÃ³ dá»¯ liá»‡u.";
      });
    });

    // *** Má»šI: Táº£i danh sÃ¡ch mÃ´n há»c tá»« Firebase ***
    function loadSubjects() {
      const subjectSelect = document.getElementById("subjectSelect");
      // Giáº£ Ä‘á»‹nh: cÃ¡c mÃ´n há»c náº±m trong node 'subjects'
      const subjectsRef = database.ref('subjects'); 
      
      subjectsRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
          subjectSelect.innerHTML = '<option value="">-- Chá»n mÃ´n há»c --</option>'; // XÃ³a text "Ä‘ang táº£i"
          snapshot.forEach(childSnapshot => {
            const subjectKey = childSnapshot.key;
            // Giáº£ Ä‘á»‹nh: tÃªn mÃ´n há»c náº±m trong childSnapshot.val().tenMonHoc
            // Náº¿u tÃªn mÃ´n há»c chÃ­nh lÃ  key, dÃ¹ng: const subjectName = subjectKey;
            const subjectName = childSnapshot.val().tenMonHoc || subjectKey; // Æ¯u tiÃªn 'tenMonHoc', náº¿u khÃ´ng cÃ³ thÃ¬ dÃ¹ng key
            
            const option = document.createElement('option');
            option.value = subjectKey; // LÆ°u key (vÃ­ dá»¥: 'Toan')
            option.textContent = subjectName; // Hiá»ƒn thá»‹ tÃªn (vÃ­ dá»¥: 'ToÃ¡n há»c')
            subjectSelect.appendChild(option);
          });
        } else {
          subjectSelect.innerHTML = '<option value="">-- KhÃ´ng tÃ¬m tháº¥y mÃ´n há»c --</option>';
        }
      }).catch(error => {
        console.error("Lá»—i táº£i danh sÃ¡ch mÃ´n há»c:", error);
        subjectSelect.innerHTML = '<option value="">-- Lá»—i táº£i CSDL --</option>';
      });
    }
    // Gá»i hÃ m táº£i mÃ´n há»c ngay khi trang Ä‘Æ°á»£c táº£i
    document.addEventListener('DOMContentLoaded', loadSubjects);


    // *** Má»šI: NÃºt Náº¡p dá»¯ liá»‡u tá»« Firebase ***
    document.getElementById("loadFirebaseBtn").addEventListener("click", () => {
      const subjectKey = document.getElementById("subjectSelect").value;
      const firebaseStatus = document.getElementById("firebaseStatus");

      if (!subjectKey) {
        firebaseStatus.textContent = "âš ï¸ Vui lÃ²ng chá»n má»™t mÃ´n há»c.";
        return;
      }
      
      firebaseStatus.textContent = "ğŸ”„ Äang táº£i dá»¯ liá»‡u...";
      excelData = []; // XÃ³a dá»¯ liá»‡u cÅ©

      // Giáº£ Ä‘á»‹nh: CÃ¢u há»i náº±m trong 'subjects/KEY_MON_HOC/questions'
      const questionsRef = database.ref(`subjects/${subjectKey}/questions`);
      
      questionsRef.once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
          // Chuyá»ƒn Ä‘á»•i object tá»« Firebase thÃ nh máº£ng (giá»‘ng há»‡t cáº¥u trÃºc Excel)
          excelData = Object.values(data);
          firebaseStatus.textContent = `âœ… ÄÃ£ náº¡p ${excelData.length} cÃ¢u há»i tá»« CSDL.`;
        } else {
          firebaseStatus.textContent = "âš ï¸ KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i nÃ o cho mÃ´n nÃ y.";
        }
      }).catch(error => {
        console.error("Lá»—i táº£i cÃ¢u há»i:", error);
        firebaseStatus.textContent = "âŒ Lá»—i khi táº£i dá»¯ liá»‡u CSDL.";
      });
    });


    // --- Äá»c Excel (Giá»¯ nguyÃªn) ---
    document.getElementById("excelInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, { type: "binary" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        excelData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        excelStatus.textContent = `âœ… ÄÃ£ náº¡p ${excelData.length} cÃ¢u há»i tá»« Excel.`;
      };
      reader.readAsBinaryString(file);
    });

    // --- OCR áº¢nh (Giá»¯ nguyÃªn) ---
    document.getElementById("imageInput").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      imageStatus.textContent = "ğŸ” Äang nháº­n dáº¡ng áº£nh...";
      output.textContent = "";
      answer.textContent = "";

      const result = await Tesseract.recognize(file, "vie+eng", {
        logger: m => { if (m.status === "recognizing text") imageStatus.textContent = `ğŸ§  OCR: ${Math.round(m.progress * 100)}%`; }
      });

      const text = result.data.text.trim();
      output.textContent = text || "(KhÃ´ng nháº­n Ä‘Æ°á»£c chá»¯)";
      imageStatus.textContent = "âœ… HoÃ n táº¥t OCR.";
      if (text) findAnswer(text);
    });

    // --- Tra theo text (Giá»¯ nguyÃªn) ---
    document.getElementById("searchTextBtn").addEventListener("click", () => {
      const text = document.getElementById("manualText").value.trim();
      if (!text) return alert("Nháº­p cÃ¢u há»i trÆ°á»›c!");
      output.textContent = text;
      findAnswer(text);
    });

    // --- Voice Recognition (Giá»¯ nguyÃªn) ---
    let recognition;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "vi-VN";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = e => {
        const text = e.results[0][0].transcript;
        document.getElementById("voiceStatus").textContent = "âœ… Nghe Ä‘Æ°á»£c: " + text;
        output.textContent = text;
        findAnswer(text);
      };
      recognition.onend = () => document.getElementById("voiceStatus").textContent = "â¹ï¸ ÄÃ£ dá»«ng ghi Ã¢m.";
    } else {
      document.getElementById("voiceStatus").textContent = "âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ giá»ng nÃ³i.";
      document.getElementById("startVoice").disabled = true;
    }

    document.getElementById("startVoice").onclick = () => {
      recognition.start();
      document.getElementById("voiceStatus").textContent = "ğŸ™ï¸ Äang nghe...";
    };

    // --- HÃ m tÃ¬m Ä‘Ã¡p Ã¡n (Cáº­p nháº­t thÃ´ng bÃ¡o lá»—i) ---
    function findAnswer(questionText) {
      // *** Cáº¬P NHáº¬T: ThÃ´ng bÃ¡o lá»—i chung chung hÆ¡n ***
      if (!excelData.length) {
        answer.textContent = "âš ï¸ Vui lÃ²ng táº£i file Excel hoáº·c náº¡p dá»¯ liá»‡u CSDL trÆ°á»›c.";
        return;
      }

      const normalize = s => s.toLowerCase().replace(/\s+/g, " ").trim();

      function similarity(a, b) {
        a = normalize(a); b = normalize(b);
        const al = a.length, bl = b.length;
        if (!al || !bl) return 0;
        const dp = Array.from({ length: bl + 1 }, () => Array(al + 1).fill(0));
        for (let i = 0; i <= bl; i++) dp[i][0] = i;
        for (let j = 0; j <= al; j++) dp[0][j] = j;
        for (let i = 1; i <= bl; i++)
          for (let j = 1; j <= al; j++)
            dp[i][j] = b[i - 1] === a[j - 1]
              ? dp[i - 1][j - 1]
              : 1 + Math.min(dp[i - 1][j - 1], dp[i][j - 1], dp[i - 1][j]);
        const dist = dp[bl][al];
        return 1 - dist / Math.max(al, bl);
      }

      let best = { score: 0, ans: "KhÃ´ng tÃ¬m tháº¥y cÃ¢u tráº£ lá»i." };
      for (let row of excelData) {
        // Há»— trá»£ nhiá»u tÃªn cá»™t (tá»« Excel hoáº·c Firebase)
        const q = row.question || row.Question || row["CÃ¢u há»i"] || "";
        const sim = similarity(questionText, q);
        if (sim > best.score) {
          best = { 
            score: sim, 
            ans: row.answer || row.Answer || row["ÄÃ¡p Ã¡n"] || "" 
          };
        }
      }

      const percent = Math.round(best.score * 100);
      similarityFill.style.width = percent + "%";
      similarityFill.style.background = percent >= 70 ? "#28a745" : (percent >= 50 ? "#ffc107" : "#dc3545");

      if (best.score >= 0.7) {
        answer.textContent = `âœ… Giá»‘ng ${percent}% â†’ ${best.ans}`;
      } else {
        answer.textContent = `âŒ Giá»‘ng ${percent}% â€“ chÆ°a Ä‘á»§ 70% Ä‘á»ƒ xÃ¡c Ä‘á»‹nh.`;
      }
      document.getElementById("speakBtn").disabled = false;
    }

    // --- Äá»c Ä‘Ã¡p Ã¡n (Giá»¯ nguyÃªn) ---
    document.getElementById("speakBtn").onclick = () => {
      const utter = new SpeechSynthesisUtterance(answer.textContent);
      utter.lang = "vi-VN";
      speechSynthesis.speak(utter);
    };
  </script>
    <script>
  // Táº£i ná»™i dung cá»§a file nav.html (Giá»¯ nguyÃªn)
  fetch('/menu.html') 
    .then(response => response.text())
    .then(data => {
      document.getElementById('navbar-placeholder').innerHTML = data;
    });
  </script>
</body>
</html>
