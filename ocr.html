<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>🧠 OCR + Excel + Nhập/Đọc Câu Hỏi</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f5f7fb; margin: 0; padding: 20px; padding-top: 70px; }
    .container { background: white; border-radius: 14px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 25px; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #0078d7; margin-bottom: 30px; }
    fieldset { border: 2px solid #0078d7; border-radius: 10px; margin-top: 15px; padding: 15px; }
    legend { color: #0078d7; font-weight: bold; padding: 0 10px; }
    input[type="file"], textarea, button, select { margin-top: 10px; font-size: 15px; }
    textarea { width: 100%; height: 90px; border-radius: 8px; border: 1px solid #ccc; padding: 10px; }
    select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #0078d7; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #005fa3; }
    #output, #answer { background: #f1f1f1; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 50px; white-space: pre-wrap; }
    #similarityBar { height: 12px; background: #ccc; border-radius: 10px; overflow: hidden; margin-top: 10px; }
    #similarityFill { height: 100%; width: 0%; background: #0078d7; transition: width 0.4s; }
  </style>
</head>
  <body class="bg-light">
<header id="navbar-placeholder"></header>
<body>
  <div class="container">
    <h1>🧠 OCR + Excel + Nhập/Đọc Câu Hỏi</h1>

    <fieldset>
      <legend>1️⃣ Chọn Nguồn Dữ Liệu Đáp Án:</legend>
      <label><input type="radio" name="dataSource" value="excel"> 📂 File Excel (.xlsx)</label>
      <label><input type="radio" name="dataSource" value="firebase" checked> ☁️ CSDL Tra cứu HG</label>
      <label><input type="radio" name="dataSource" value="text"> 📄 File Text (.txt)</label>

      <div id="firebaseDataSourceArea">
        <select id="subjectSelect">
          <option value="">-- Đang tải danh sách môn... --</option>
        </select>
        <button id="loadFirebaseBtn">⚡ Nạp dữ liệu CSDL</button>
        <p id="firebaseStatus">Chưa nạp dữ liệu CSDL.</p>
      </div>

      <div id="excelDataSourceArea" style="display:none;">
        <input type="file" id="excelInput" accept=".xlsx">
        <a href="template_excel.xlsx" download="Mau_template_Excel.xlsx" style="display: inline-block; margin-top: 10px; margin-left: 5px; font-size: 14px;">
          📥 Tải file Excel mẫu
        </a>
        <p id="excelStatus">Chưa tải file Excel.</p>
      </div>

      <div id="textDataSourceArea" style="display:none;">
        <input type="file" id="textInput" accept=".txt">
        <p id="textStatus">Chưa tải file Text (.txt).</p>
      </div>
    </fieldset>

    <fieldset>
      <legend>2️⃣ Chọn cách nhập câu hỏi:</legend>
      <label><input type="radio" name="inputMode" value="image" checked> 🖼️ Ảnh (OCR)</label>
      <label><input type="radio" name="inputMode" value="text"> ✍️ Nhập văn bản</label>
      <label><input type="radio" name="inputMode" value="voice"> 🎤 Đọc bằng giọng nói</label>
      <div id="imageInputArea">
        <input type="file" id="imageInput" accept="image/*">
        <p id="imageStatus">Chưa chọn ảnh.</p>
      </div>
      <div id="textInputArea" style="display:none;">
        <textarea id="manualText" placeholder="Nhập câu hỏi tại đây..."></textarea>
        <button id="searchTextBtn">🔍 Tra đáp án</button>
      </div>
      <div id="voiceInputArea" style="display:none;">
        <button id="startVoice">🎙️ Bắt đầu nói</button>
        <p id="voiceStatus">Chưa nói gì...</p>
      </div>
    </fieldset>
    
    <fieldset>
      <legend>📋 Câu hỏi nhận được:</legend>
      <div id="output">Chưa nhận dạng.</div>
    </fieldset>

    <fieldset>
      <legend>💡 Đáp án tìm được:</legend>
      <div id="answer">Chưa có dữ liệu.</div>
      <div id="similarityBar"><div id="similarityFill"></div></div>
      <button id="speakBtn" disabled>🔊 Đọc đáp án</button>
    </fieldset>
  </div>

  <script>
    let excelData = []; 
    const output = document.getElementById("output");
    const answer = document.getElementById("answer");
    const imageStatus = document.getElementById("imageStatus");
    const excelStatus = document.getElementById("excelStatus");
    // *** MỚI: Thêm status cho Word/Text ***
    const firebaseStatus = document.getElementById("firebaseStatus");
    const textStatus = document.getElementById("textStatus");
    
    const similarityFill = document.getElementById("similarityFill");

    // --- Khởi tạo Firebase (Giữ nguyên) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92M",
      authDomain: "tracuu-d3ee9.firebaseapp.com",
      projectId: "tracuu-d3ee9",
      storageBucket: "tracuu-d3ee9.appspot.com",
      messagingSenderId: "593568604435",
      appId: "1:593568604435:web:9a5145457a8ee734143ae6",
      measurementId: "G-R0M6Y502NP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); 

    // --- Chuyển đổi khu vực nhập (Giữ nguyên) ---
    document.querySelectorAll('input[name="inputMode"]').forEach(r => {
      r.addEventListener('change', () => {
        document.getElementById("imageInputArea").style.display = r.value === "image" ? "block" : "none";
        document.getElementById("textInputArea").style.display = r.value === "text" ? "block" : "none";
        document.getElementById("voiceInputArea").style.display = r.value === "voice" ? "block" : "none";
      });
    });

    // *** MỚI: Cập nhật Chuyển đổi NGUỒN DỮ LIỆU (Thêm Word/Text) ***
    document.querySelectorAll('input[name="dataSource"]').forEach(r => {
      r.addEventListener('change', () => {
        const val = r.value;
        document.getElementById("firebaseDataSourceArea").style.display = val === "firebase" ? "block" : "none";
        document.getElementById("excelDataSourceArea").style.display = val === "excel" ? "block" : "none";
        document.getElementById("textDataSourceArea").style.display = val === "text" ? "block" : "none";
        
        // Reset dữ liệu và status
        excelData = [];
        firebaseStatus.textContent = "Chưa nạp dữ liệu CSDL.";
        excelStatus.textContent = "Chưa tải file Excel.";
        textStatus.textContent = "Chưa tải file Text (.txt).";
        answer.textContent = "Chưa có dữ liệu.";
      });
    });

    // --- Tải danh sách môn học từ FIRESTORE (Giữ nguyên) ---
    function loadSubjects() {
      const subjectSelect = document.getElementById("subjectSelect");
      const subjectsRef = db.collection("mon_hoc"); 
      
      subjectsRef.get().then(snapshot => {
        if (!snapshot.empty) {
          subjectSelect.innerHTML = '<option value="">-- Chọn môn học --</option>';
          snapshot.forEach(doc => {
            const subjectKey = doc.id;
            const subjectName = doc.data().ten_mon; 
            if (subjectName) {
              const option = document.createElement('option');
              option.value = subjectKey; 
              option.textContent = subjectName; 
              subjectSelect.appendChild(option);
            }
          });
        } else {
          subjectSelect.innerHTML = '<option value="">-- Không tìm thấy môn học --</option>';
        }
      }).catch(error => {
        console.error("Lỗi tải danh sách môn học:", error);
        subjectSelect.innerHTML = '<option value="">-- Lỗi tải CSDL --</option>';
      });
    }
    // Tải môn học ngay khi trang load, và đặt Firebase là nguồn mặc định
    document.addEventListener('DOMContentLoaded', () => {
        loadSubjects();
        document.querySelector('input[name="dataSource"][value="firebase"]').checked = true;
        document.getElementById("firebaseDataSourceArea").style.display = "block";
    });


    // --- Nút Nạp dữ liệu từ FIRESTORE (Giữ nguyên) ---
    document.getElementById("loadFirebaseBtn").addEventListener("click", () => {
      const subjectKey = document.getElementById("subjectSelect").value; 
      if (!subjectKey) {
        firebaseStatus.textContent = "⚠️ Vui lòng chọn một môn học.";
        return;
      }
      firebaseStatus.textContent = "🔄 Đang tải dữ liệu...";
      excelData = []; 
      const questionsRef = db.collection("cau_hoi").where("mon_hoc_id", "==", subjectKey);
      
      questionsRef.get().then(snapshot => {
        if (!snapshot.empty) {
          snapshot.forEach(doc => {
            const data = doc.data();
            const question = data.noi_dung; 
            const correctKey = data.dap_an_dung; 
            const choices = data.lua_chon; 
            let answerText = "Không có đáp án"; 
            if (choices && correctKey && choices[correctKey]) {
              answerText = choices[correctKey];
            }
            excelData.push({ question: question || "", answer: answerText });
          });
          firebaseStatus.textContent = `✅ Đã nạp ${excelData.length} câu hỏi từ CSDL.`;
        } else {
          firebaseStatus.textContent = "⚠️ Không tìm thấy câu hỏi nào cho môn này.";
        }
      }).catch(error => {
        console.error("Lỗi tải câu hỏi:", error);
        firebaseStatus.textContent = "❌ Lỗi khi tải dữ liệu CSDL.";
      });
    });


    // --- Đọc Excel (Giữ nguyên) ---
    document.getElementById("excelInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, { type: "binary" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        excelData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        excelStatus.textContent = `✅ Đã nạp ${excelData.length} câu hỏi từ Excel.`;
      };
      reader.readAsBinaryString(file);
    });

    // *** MỚI: Hàm chung để phân tích Text và Word ***
    // (Dựa trên định dạng file .txt bạn đã cung cấp (Source 1-32))
    function parseTextData(text) {
        excelData = []; // Xóa dữ liệu cũ
        let count = 0;
        // Tách file dựa trên "Câu hỏi:"
        const parts = text.split("Câu hỏi:");
        
        // Bỏ qua phần tử đầu tiên (có thể là tiêu đề)
        for (let i = 1; i < parts.length; i++) {
            const chunk = parts[i];
            // Tách câu hỏi và câu trả lời
            const answerSplit = chunk.split("Đáp án đúng:");
            
            if (answerSplit.length === 2) {
                // Lấy câu hỏi, xóa khoảng trắng thừa
                const question = answerSplit[0].trim().replace(/\s+/g, ' ');
                
                // Lấy câu trả lời, xóa khoảng trắng thừa
                let answer = answerSplit[1].trim();
                
                // Giữ lại nội dung trước dấu xuống dòng đầu tiên
                const firstNewline = answer.indexOf('\n');
                if (firstNewline !== -1) {
                    answer = answer.substring(0, firstNewline).trim();
                }
                
                if (question && answer) {
                    excelData.push({ question, answer });
                    count++;
                }
            }
        }
        return count;
    }

    // *** MỚI: Đọc File Text (.txt) ***
    document.getElementById("textInput").addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        
        textStatus.textContent = "🔄 Đang đọc file Text...";
        const reader = new FileReader();
        reader.onload = evt => {
            const text = evt.target.result;
            const count = parseTextData(text);
            textStatus.textContent = `✅ Đã nạp ${count} câu hỏi từ Text.`;
        };
        reader.onerror = () => {
             textStatus.textContent = "❌ Lỗi khi đọc file .txt";
        };
        reader.readAsText(file);
    });

    // --- OCR Ảnh (Giữ nguyên) ---
    document.getElementById("imageInput").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      imageStatus.textContent = "🔍 Đang nhận dạng ảnh...";
      output.textContent = "";
      answer.textContent = "";

      const result = await Tesseract.recognize(file, "vie+eng", {
        logger: m => { if (m.status === "recognizing text") imageStatus.textContent = `🧠 OCR: ${Math.round(m.progress * 100)}%`; }
      });

      const text = result.data.text.trim();
      output.textContent = text || "(Không nhận được chữ)";
      imageStatus.textContent = "✅ Hoàn tất OCR.";
      if (text) findAnswer(text);
    });

    // --- Tra theo text (Giữ nguyên) ---
    document.getElementById("searchTextBtn").addEventListener("click", () => {
      const text = document.getElementById("manualText").value.trim();
      if (!text) return alert("Nhập câu hỏi trước!");
      output.textContent = text;
      findAnswer(text);
    });

    // --- Voice Recognition (Giữ nguyên) ---
    let recognition;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "vi-VN";
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = e => {
        const text = e.results[0][0].transcript;
        document.getElementById("voiceStatus").textContent = "✅ Nghe được: " + text;
        output.textContent = text;
        findAnswer(text);
      };
      recognition.onend = () => document.getElementById("voiceStatus").textContent = "⏹️ Đã dừng ghi âm.";
    } else {
      document.getElementById("voiceStatus").textContent = "⚠️ Trình duyệt không hỗ trợ giọng nói.";
      document.getElementById("startVoice").disabled = true;
    }
    document.getElementById("startVoice").onclick = () => {
      recognition.start();
      document.getElementById("voiceStatus").textContent = "🎙️ Đang nghe...";
    };

    // --- Hàm tìm đáp án (Giữ nguyên logic .includes()) ---
    function findAnswer(questionText) {
      if (!excelData.length) {
        answer.textContent = "⚠️ Vui lòng tải file Excel hoặc nạp dữ liệu CSDL trước.";
        return;
      }
      const normalize = s => s.toLowerCase().replace(/\s+/g, " ").trim();
      const normalizedOcrText = normalize(questionText);

      let best = { score: 0, ans: "Không tìm thấy câu trả lời." };

      for (let row of excelData) {
        const q = row.question || row.Question || row["Câu hỏi"] || "";
        if (!q) continue; 
        const normalizedDbQuestion = normalize(q);

        if (normalizedDbQuestion.length > 5 && normalizedOcrText.includes(normalizedDbQuestion)) {
          if (normalizedDbQuestion.length > best.score) {
            best = {
              score: normalizedDbQuestion.length,
              ans: row.answer || row.Answer || row["Đáp án"] || ""
            };
          }
        }
      }

      if (best.score > 0) {
        answer.textContent = `✅ Khớp → ${best.ans}`;
        similarityFill.style.width = "100%"; 
        similarityFill.style.background = "#28a745";
      } else {
        answer.textContent = `❌ Không tìm thấy câu hỏi khớp trong CSDL.`;
        similarityFill.style.width = "0%";
        similarityFill.style.background = "#dc3545";
      }
      document.getElementById("speakBtn").disabled = best.score === 0;
    }

// --- Đọc đáp án (Giữ nguyên) ---
document.getElementById("speakBtn").onclick = () => {
  const utter = new SpeechSynthesisUtterance(answer.textContent);
  utter.lang = "vi-VN"; // 👈 Bạn đã yêu cầu giọng "vi-VN"
  speechSynthesis.speak(utter);
};
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
  // Tải menu (Đường dẫn tương đối)
  fetch('menu.html') 
    .then(response => response.text())
    .then(data => {
      document.getElementById('navbar-placeholder').innerHTML = data;
    });
  </script>
</body>
</html>
