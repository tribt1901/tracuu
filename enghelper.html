<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý học tiếng Anh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        @keyframes pulse-bg {
            0%, 100% { background-color: theme('colors.blue.50'); }
            50% { background-color: theme('colors.blue.100'); }
        }
        .loading-pulse {
            animation: pulse-bg 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
<div class="container mx-auto p-4 md:p-8 max-w-7xl">
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 text-center">Trợ lý học tiếng Anh</h1>
        <p class="text-center text-gray-600 mt-2">Tải lên file MP3, tạo transcript và hỏi đáp AI dựa trên nội dung.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-6">
            <div class="rounded-lg border border-gray-200 p-4 bg-white shadow-sm">
                <label for="audio-upload" class="block text-sm font-medium text-gray-700 mb-2">1. Tải lên tệp âm thanh (MP3)</label>
                <input type="file" id="audio-upload" accept="audio/mp3, audio/mpeg"
                       class="w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-lg file:border-0
                       file:text-sm file:font-semibold
                       file:bg-blue-50 file:text-blue-700
                       hover:file:bg-blue-100 cursor-pointer">
                <audio id="audio-player" controls class="w-full mt-4 rounded-lg hidden"></audio>
            </div>

            <div class="rounded-lg border border-gray-200 p-4 bg-white shadow-sm">
                <label class="block text-sm font-medium text-gray-700 mb-2">2. Tạo Transcript (Dùng Backend)</label>
                <button id="generate-transcript-btn"
                        class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-150">
                    Tạo Transcript từ MP3
                </button>
                //<p class="text-xs text-gray-500 mt-2 italic">Hệ thống sẽ gửi file MP3 đến Vercel backend (`/api/process-audio`) để xử lý.</p>
            </div>

            <div class="rounded-lg border border-gray-200 p-4 bg-white shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Nội dung Transcript (Từ MP3)</h3>
                <div id="transcript-display" class="w-full h-48 bg-gray-50 rounded-lg p-3 overflow-y-auto text-gray-600 text-sm border border-gray-200">
                    Vui lòng nhấn nút "Tạo Transcript từ MP3" sau khi tải file...
                </div>
            </div>
        </div>

        <!-- Các cột khác giữ nguyên, không thay đổi -->

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let transcriptContent = "";
    let audioFile = null;

    const audioUpload = document.getElementById('audio-upload');
    const audioPlayer = document.getElementById('audio-player');
    const generateTranscriptBtn = document.getElementById('generate-transcript-btn');
    const transcriptDisplay = document.getElementById('transcript-display');
    const status = document.getElementById('status');

    audioUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            audioFile = file;
            audioPlayer.src = URL.createObjectURL(file);
            audioPlayer.classList.remove('hidden');
            status.textContent = `Đã tải: ${file.name}. Sẵn sàng tạo transcript.`;
        }
    });

    generateTranscriptBtn.addEventListener('click', async () => {
        if (!audioFile) {
            status.textContent = "Lỗi: Vui lòng chọn một tệp MP3 trước.";
            return;
        }

        status.textContent = "Đang gửi file MP3 đến backend...";
        transcriptDisplay.innerHTML = `<div class="flex justify-center items-center h-full">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"></div>
        </div>`;
        transcriptDisplay.classList.add('loading-pulse');

        const formData = new FormData();
        formData.append('audio', audioFile);

        try {
            const response = await fetch('/api/process-audio', {
                method: 'POST',
                body: formData
            });

            transcriptDisplay.classList.remove('loading-pulse');

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.details || response.statusText || "Lỗi không xác định từ backend");
            }

            const data = await response.json();
            transcriptContent = data.transcript || "";
            if (!transcriptContent) throw new Error("Backend trả về transcript trống.");
            transcriptDisplay.textContent = transcriptContent;
            status.textContent = "Tạo transcript thành công. Sẵn sàng hỏi-đáp.";

        } catch (error) {
            console.error("Lỗi khi gọi /api/process-audio:", error);
            status.textContent = `Lỗi: ${error.message}`;
            transcriptDisplay.textContent = "Đã xảy ra lỗi khi tạo transcript.";
        }
    });
});
</script>
</body>
</html>
