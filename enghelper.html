<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• H·ªó tr·ª£ H·ªçc ti·∫øng Anh</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Tesseract.js (Th∆∞ vi·ªán OCR) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
    <style>
        /* S·ª≠ d·ª•ng font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ·∫®n c√°c tab input m·∫∑c ƒë·ªãnh */
        .input-tab-content {
            display: none;
        }
        /* Hi·ªÉn th·ªã tab ƒëang ho·∫°t ƒë·ªông */
        .input-tab-content.active {
            display: block;
        }
        /* Ki·ªÉu cho n√∫t tab ƒëang ho·∫°t ƒë·ªông */
        .tab-btn.active {
            border-bottom-color: #3B82F6; /* blue-500 */
            color: #3B82F6;
            font-weight: 600;
        }
        /* Ki·ªÉu cho b·ªô ƒë·∫øm online */
        .online-counter-box {
            text-align: center;
            padding: 8px;
            background-color: #f0fdf4; /* green-50 */
            color: #166534; /* green-800 */
            font-weight: 500;
            border-bottom: 1px solid #dcfce7; /* green-100 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen"> <!-- Thay ƒë·ªïi class body -->

    <!-- Placeholder cho thanh ƒëi·ªÅu h∆∞·ªõng -->
    <header id="navbar-placeholder"></header>

    <!-- B·ªô ƒë·∫øm ng∆∞·ªùi d√πng online -->
    <div class="online-counter-box">
        üü¢ Hi·ªán c√≥ B·∫°n v√† <span id="online-counter">0</span> ng∆∞·ªùi n·ªØa ƒëang truy c·∫≠p h·ªá th·ªëng.
    </div>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden my-4 md:my-8">
        <header class="bg-blue-600 p-6">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                C√¥ng c·ª• H·ªó tr·ª£ H·ªçc ti·∫øng Anh
            </h1>
            <p class="text-blue-100 mt-1">
                T·∫£i l√™n t·ªáp √¢m thanh, sau ƒë√≥ ƒë·∫∑t c√¢u h·ªèi ƒë·ªÉ t√¨m ki·∫øm.
            </p>
        </header>

        <main class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- C·ªôt 1: T·∫£i l√™n v√† Hi·ªÉn th·ªã -->
            <div class="space-y-6">
                <!-- T·∫£i l√™n t·ªáp √¢m thanh -->
                <div class="rounded-lg border border-gray-200 p-4">
                    <label for="audio-upload" class="block text-sm font-medium text-gray-700 mb-2">
                        1. T·∫£i l√™n t·ªáp √¢m thanh (MP3)
                    </label>
                    <input type="file" id="audio-upload" accept="audio/mp3" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer">
                    <audio id="audio-player" controls class="w-full mt-4 rounded-lg hidden"></audio>
                </div>
                
                <!-- Hi·ªÉn th·ªã n·ªôi dung -->
                <div class="rounded-lg border border-gray-200 p-4">
                     <h3 class="text-lg font-semibold text-gray-800 mb-2">N·ªôi dung vƒÉn b·∫£n (Tr√≠ch xu·∫•t t·ª´ MP3)</h3>
                     <div id="transcript-display" class="w-full h-48 bg-gray-50 rounded-lg p-3 overflow-y-auto text-gray-600 text-sm border border-gray-200">
                        Vui l√≤ng t·∫£i l√™n m·ªôt t·ªáp MP3. N·ªôi dung tr√≠ch xu·∫•t s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...
                     </div>
                </div>
            </div>

            <!-- C·ªôt 2: Nh·∫≠p c√¢u h·ªèi v√† K·∫øt qu·∫£ -->
            <div class="space-y-6">
                <!-- Tab nh·∫≠p c√¢u h·ªèi -->
                <div class="rounded-lg border border-gray-200 p-4">
                    <!-- Thay ƒë·ªïi th√†nh B∆∞·ªõc 2 -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">2. Nh·∫≠p c√¢u h·ªèi</h3>
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex space-x-4" aria-label="Tabs">
                            <button class="tab-btn active" data-tab="text">
                                <span class="material-icons-outlined text-sm mr-1">edit</span>G√µ tay
                            </button>
                            <button class="tab-btn" data-tab="image">
                                <span class="material-icons-outlined text-sm mr-1">image</span>Qu√©t ·∫£nh
                            </button>
                            <button class="tab-btn" data-tab="voice">
                                <span class="material-icons-outlined text-sm mr-1">mic</span>Gi·ªçng n√≥i
                            </button>
                        </nav>
                    </div>

                    <!-- N·ªôi dung c√°c tab -->
                    <div>
                        <!-- Tab G√µ tay -->
                        <div id="tab-text" class="input-tab-content active">
                            <textarea id="text-input" class="w-full h-24 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>
                        </div>
                        <!-- Tab Qu√©t ·∫£nh (OCR) -->
                        <div id="tab-image" class="input-tab-content">
                            <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-indigo-50 file:text-indigo-700
                                hover:file:bg-indigo-100 cursor-pointer">
                        </div>
                        <!-- Tab Gi·ªçng n√≥i -->
                        <div id="tab-voice" class="input-tab-content">
                            <button id="voice-input-btn" class="w-full flex items-center justify-center py-3 px-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150">
                                <span class="material-icons-outlined mr-2">mic</span>
                                Nh·∫•n ƒë·ªÉ n√≥i
                            </button>
                        </div>
                    </div>
                     <!-- N√∫t t√¨m ki·∫øm -->
                    <button id="search-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-150 mt-4">
                        T√¨m ki·∫øm trong n·ªôi dung
                    </button>
                </div>

                <!-- K·∫øt qu·∫£ -->
                <div class="rounded-lg border border-gray-200 p-4">
                    <!-- Thay ƒë·ªïi th√†nh B∆∞·ªõc 3 -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">3. K·∫øt qu·∫£ t√¨m ki·∫øm</h3>
                    <div id="status" class="text-sm text-gray-500 mb-2 italic">Tr·∫°ng th√°i: S·∫µn s√†ng...</div>
                    <div id="answer-display" class="w-full min-h-[5rem] bg-gray-50 rounded-lg p-3 text-gray-700 border border-gray-200">
                        K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- T·∫£i bi·ªÉu t∆∞·ª£ng Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase (v10+) v√† logic b·ªô ƒë·∫øm -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        // Import Firestore n·∫øu c·∫ßn, nh∆∞ng m√£ b·∫°n cung c·∫•p ch·ªâ d√πng Realtime DB
        // import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getDatabase, ref, push, onValue, onDisconnect, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        document.addEventListener('DOMContentLoaded', () => {
            // Firebase config with databaseURL
            const firebaseConfig = {
                apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92c",
                authDomain: "tracuu-d3ee9.firebaseapp.com",
                databaseURL: "https://tracuu-d3ee9-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "tracuu-d3ee9",
                storageBucket: "tracuu-d3ee9.appspot.com",
                messagingSenderId: "593568604435",
                appId: "1:593568604435:web:9a5145457a8ee734143ae6"
            };

            // Initialize app once
            const app = initializeApp(firebaseConfig);
            // const db = getFirestore(app); // Firestore (n·∫øu c·∫ßn)
            const rtdb = getDatabase(app, firebaseConfig.databaseURL); // Realtime DB

            // --- Online counter (Realtime DB modular) ---
            (function initOnlineCounter() {
                const onlineCounterEl = document.getElementById('online-counter');
                if (!onlineCounterEl) return;
                try {
                    const connectionsRef = ref(rtdb, 'connections');
                    const myConnectionRef = push(connectionsRef);
                    onDisconnect(myConnectionRef).remove().catch(() => {});
                    set(myConnectionRef, true).catch(() => {});
                    
                    onValue(connectionsRef, snapshot => {
                        let count = 0;
                        try {
                            if (snapshot.exists()) {
                                const v = snapshot.val();
                                if (v && typeof v === 'object') {
                                    count = Object.keys(v).length;
                                } else {
                                    count = 1; // Fallback n·∫øu c·∫•u tr√∫c kh√¥ng nh∆∞ mong ƒë·ª£i
                                }
                            }
                            // Tr·ª´ 1 ƒë·ªÉ kh√¥ng t√≠nh ch√≠nh m√¨nh ("...v√† X ng∆∞·ªùi n·ªØa")
                            onlineCounterEl.textContent = Math.max(0, count - 1); 
                        } catch (e) {
                            console.error("L·ªói ƒë·∫øm snapshot: ", e);
                            count = 0;
                            onlineCounterEl.textContent = count;
                        }
                    }, err => {
                        console.error("L·ªói onValue connections: ", err);
                    });
                } catch (err) {
                    console.error("L·ªói kh·ªüi t·∫°o b·ªô ƒë·∫øm Realtime: ", err);
                }
            })();

            // Optional: load menu.html into header
            fetch('menu.html').then(r => {
                if(r.ok) return r.text();
                throw new Error('Kh√¥ng t√¨m th·∫•y menu.html');
            }).then(html => {
                document.getElementById('navbar-placeholder').innerHTML = html;
            }).catch((err) => {
                console.warn(err.message);
            });
        });
    </script>

    <!-- Script logic ch√≠nh c·ªßa trang -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const audioUpload = document.getElementById('audio-upload');
            const audioPlayer = document.getElementById('audio-player');
            // ƒê√£ lo·∫°i b·ªè transcriptUpload
            const transcriptDisplay = document.getElementById('transcript-display');
            const imageUpload = document.getElementById('image-upload');
            const textInput = document.getElementById('text-input');
            const voiceInputBtn = document.getElementById('voice-input-btn');
            const searchBtn = document.getElementById('search-btn');
            const answerDisplay = document.getElementById('answer-display');
            const status = document.getElementById('status');
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.input-tab-content');

            let transcriptContent = ""; // Bi·∫øn l∆∞u tr·ªØ n·ªôi dung vƒÉn b·∫£n
            let currentInputMode = 'text'; // 'text', 'image', 'voice'

            // --- X·ª≠ l√Ω T·∫£i t·ªáp ---

            // 1. T·∫£i t·ªáp √¢m thanh
            audioUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const objectUrl = URL.createObjectURL(file);
                    audioPlayer.src = objectUrl;
                    audioPlayer.classList.remove('hidden');
                    
                    // Th√¥ng b√°o cho ng∆∞·ªùi d√πng r·∫±ng t√≠nh nƒÉng tr√≠ch xu·∫•t t·ª± ƒë·ªông ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£
                    transcriptContent = ""; // ƒê·∫∑t l·∫°i n·ªôi dung
                    status.textContent = `ƒê√£ t·∫£i: ${file.name}. (L∆∞u √Ω: T·ª± ƒë·ªông tr√≠ch xu·∫•t n·ªôi dung CH∆ØA ƒë∆∞·ª£c h·ªó tr·ª£.)`;
                    transcriptDisplay.textContent = "T√≠nh nƒÉng t·ª± ƒë·ªông tr√≠ch xu·∫•t n·ªôi dung t·ª´ MP3 ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£ trong phi√™n b·∫£n n√†y.";
                }
            });

            // ƒê√£ lo·∫°i b·ªè EventListener c·ªßa transcriptUpload

            // --- X·ª≠ l√Ω Chuy·ªÉn Tab ---
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');

                    // B·ªè active t·∫•t c·∫£
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Active tab ƒë∆∞·ª£c ch·ªçn
                    tab.classList.add('active');
                    document.getElementById(`tab-${targetTab}`).classList.add('active');
                    currentInputMode = targetTab;
                    textInput.value = ""; // X√≥a n·ªôi dung khi chuy·ªÉn tab
                    status.textContent = "S·∫µn s√†ng...";
                });
            });

            // --- X·ª≠ l√Ω c√°c ph∆∞∆°ng th·ª©c nh·∫≠p ---

            // 3a. Qu√©t ·∫£nh (OCR)
            imageUpload.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                status.textContent = "ƒêang nh·∫≠n di·ªán h√¨nh ·∫£nh (OCR)... (C√≥ th·ªÉ m·∫•t m·ªôt l√∫c)";
                try {
                    // 1. T·∫°o worker Tesseract
                    const worker = await Tesseract.createWorker('eng', 1, {
                        logger: m => console.log(m) // Xem log ti·∫øn tr√¨nh trong console
                    });
                    
                    // 2. Nh·∫≠n di·ªán vƒÉn b·∫£n
                    const { data: { text } } = await worker.recognize(file);
                    
                    // 3. Hi·ªÉn th·ªã k·∫øt qu·∫£ trong √¥ text-input
                    textInput.value = text.trim();
                    status.textContent = "Nh·∫≠n di·ªán ·∫£nh th√†nh c√¥ng. Nh·∫•n 'T√¨m ki·∫øm'.";
                    
                    // 4. Chuy·ªÉn sang tab "G√µ tay" ƒë·ªÉ xem k·∫øt qu·∫£ OCR
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.querySelector('.tab-btn[data-tab="text"]').classList.add('active');
                    document.getElementById('tab-text').classList.add('active');
                    currentInputMode = 'text';

                    // 5. Gi·∫£i ph√≥ng worker
                    await worker.terminate();

                } catch (error) {
                    console.error(error);
                    status.textContent = "L·ªói khi nh·∫≠n di·ªán ·∫£nh.";
                }
            });

            // 3b. Nh·∫≠n di·ªán gi·ªçng n√≥i
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US'; // Nh·∫≠n di·ªán ti·∫øng Anh
                recognition.interimResults = false;

                voiceInputBtn.addEventListener('click', () => {
                    status.textContent = "ƒêang nghe... Vui l√≤ng n√≥i (ti·∫øng Anh).";
                    voiceInputBtn.classList.add('animate-pulse', 'bg-red-800');
                    recognition.start();
                });

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    textInput.value = speechResult;
                    status.textContent = "ƒê√£ nh·∫≠n di·ªán gi·ªçng n√≥i. Nh·∫•n 'T√¨m ki·∫øm'.";
                    
                    // Chuy·ªÉn sang tab "G√µ tay" ƒë·ªÉ xem k·∫øt qu·∫£
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.querySelector('.tab-btn[data-tab="text"]').classList.add('active');
                    document.getElementById('tab-text').classList.add('active');
                    currentInputMode = 'text';
                };

                recognition.onend = () => {
                    voiceInputBtn.classList.remove('animate-pulse', 'bg-red-800');
                };

                recognition.onerror = (event) => {
                    console.error('L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i:', event.error);
                    status.textContent = `L·ªói: ${event.error}`;
                };

            } else {
                voiceInputBtn.disabled = true;
                voiceInputBtn.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªóGtr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i";
                voiceInputBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
            
            // --- X·ª≠ l√Ω T√¨m ki·∫øm ---
            searchBtn.addEventListener('click', () => {
                const question = textInput.value.trim().toLowerCase();
                
                if (!question) {
                    status.textContent = "Vui l√≤ng nh·∫≠p c√¢u h·ªèi.";
                    return;
                }
                // Thay ƒë·ªïi ƒëi·ªÅu ki·ªán ki·ªÉm tra
                if (!transcriptContent) {
                    status.textContent = "L·ªói: Ch∆∞a c√≥ n·ªôi dung (transcript) ƒë·ªÉ t√¨m ki·∫øm. T√≠nh nƒÉng t·ª± ƒë·ªông tr√≠ch xu·∫•t MP3 ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£.";
                    return;
                }

                status.textContent = "ƒêang t√¨m ki·∫øm...";
                answerDisplay.innerHTML = "";
                // ƒê·∫£m b·∫£o transcriptDisplay ƒë∆∞·ª£c reset ƒë√∫ng c√°ch
                transcriptDisplay.innerHTML = transcriptContent.replace(/\n/g, '<br>'); 

                const transcriptLower = transcriptContent.toLowerCase();
                const questionIndex = transcriptLower.indexOf(question);

                if (questionIndex === -1) {
                    status.textContent = "Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi trong n·ªôi dung.";
                    answerDisplay.textContent = "Kh√¥ng t√¨m th·∫•y.";
                } else {
                    // T√¨m th·∫•y c√¢u h·ªèi
                    status.textContent = "ƒê√£ t√¨m th·∫•y!";
                    
                    // L·∫•y c√¢u h·ªèi g·ªëc (ƒë√∫ng
                    const originalQuestion = transcriptContent.substring(questionIndex, questionIndex + question.length);

                    // Tr√≠ch xu·∫•t "c√¢u tr·∫£ l·ªùi" (v√≠ d·ª•: 150 k√Ω t·ª± ti·∫øp theo)
                    const answerLength = 150; 
                    let answerSnippet = transcriptContent.substring(questionIndex + question.length, questionIndex + question.length + answerLength);
                    
                    // C·∫Øt t·∫°i d·∫•u ch·∫•m ho·∫∑c xu·ªëng d√≤ng g·∫ßn nh·∫•t
                    const sentenceEnd = Math.min(
                        (answerSnippet.indexOf('.') > 0 ? answerSnippet.indexOf('.') : answerLength),
                        (answerSnippet.indexOf('\n') > 0 ? answerSnippet.indexOf('\n') : answerLength)
                    );
                    
                    answerSnippet = answerSnippet.substring(0, sentenceEnd + 1) + "...";

                    // Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi
                    answerDisplay.innerHTML = `<mark class="bg-yellow-200 font-semibold">${originalQuestion}</mark> ${answerSnippet}`;

                    // ƒê√°nh d·∫•u tr√™n m√†n h√¨nh n·ªôi dung
                    const highlightedTranscript = transcriptContent.substring(0, questionIndex) +
                        `<mark class="bg-yellow-200 font-semibold">${originalQuestion}</mark>` +
                        `<mark class="bg-green-200">${answerSnippet.replace('...', '')}</mark>` +
                        transcriptContent.substring(questionIndex + question.length + (answerSnippet.length - 3));

                    transcriptDisplay.innerHTML = highlightedTranscript.replace(/\n/g, '<br>');

                    // Cu·ªôn ƒë·∫øn v·ªã tr√≠ t√¨m th·∫•y
                    const markElement = transcriptDisplay.querySelector('mark');
                    if (markElement) {
                        markElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        });
    </script>
    
    <!-- T·∫£i Bootstrap JS (theo y√™u c·∫ßu) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

