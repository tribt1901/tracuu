<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF‑8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công cụ Tra cứu Nội dung Âm thanh — Offline trên trình duyệt</title>
  <style>
    body { font-family: Arial, sans‑serif; margin: 20px; }
    input, button, textarea { width: 100%; margin-top: 10px; }
    textarea { height: 200px; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Tra cứu Nội dung Âm thanh</h1>
  <p>Upload file âm thanh (MP3/WAV) và nhận văn bản chuyển đổi trực tiếp trên trình duyệt.</p>

  <input type="file" id="audio-upload" accept="audio/*">
  <div id="status">Chưa chọn file.</div>
  <textarea id="transcript" placeholder="Kết quả chuyển đổi sẽ hiện ở đây…" readonly></textarea>

  <script src="https://cdn.jsdelivr.net/npm/vosk-browser@0.0.8/dist/vosk.js"></script>
  <script>
    let model, recognizer;

    async function initModel() {
      document.getElementById('status').innerText = 'Đang tải model...';
      // Bạn cần tải model nhỏ phù hợp sao cho người dùng tải được nhanh
      model = await Vosk.createModel('models/vosk-model-small-en-us-0.15.tar.gz'); 
      document.getElementById('status').innerText = 'Model sẵn sàng.';
    }

    async function processAudioFile(file) {
      const statusEl = document.getElementById('status');
      const transcriptEl = document.getElementById('transcript');
      statusEl.innerText = 'Đang đọc file...';

      const arrayBuffer = await file.arrayBuffer();
      const audioContext = new AudioContext();
      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
      statusEl.innerText = 'Đang tạo recognizer...';

      recognizer = new model.KaldiRecognizer(audioBuffer.sampleRate);
      // Gộp dữ liệu audio để kí nhận
      recognizer.acceptWaveform(audioBuffer.getChannelData(0));

      const result = recognizer.finalResult();
      transcriptEl.value = result.text;
      statusEl.innerText = 'Hoàn tất chuyển đổi.';
    }

    document.getElementById('audio-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      processAudioFile(file).catch(err => {
        console.error(err);
        document.getElementById('status').innerText = 'Lỗi: ' + err.message;
      });
    });

    window.onload = initModel;
  </script>
</body>
</html>
