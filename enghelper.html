<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>English Helper - Whisper WASM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    h1 { color: #333; }
    input[type=file] { margin-bottom: 1rem; }
    textarea { width: 100%; height: 300px; margin-top: 1rem; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>English Helper - Whisper WASM</h1>
  <p>Upload an MP3 file and get the transcription below:</p>
  <input type="file" id="fileInput" accept=".mp3,.wav"/>
  <div id="status">Waiting for file...</div>
  <textarea id="transcript" placeholder="Transcription will appear here..." readonly></textarea>

  <script>
    let Module;

    async function loadWhisper() {
      document.getElementById('status').innerText = 'Loading Whisper WASM...';
      
      // Load whisper.wasm script
      Module = await new Promise((resolve) => {
        const script = document.createElement('script');
        script.src = './whisper.js'; // nếu bạn có whisper.js kèm với whisper.wasm
        script.onload = () => {
          // Module là object global từ whisper.js
          resolve(window.Module);
        };
        document.body.appendChild(script);
      });

      document.getElementById('status').innerText = 'Whisper WASM loaded. Ready to transcribe.';
    }

    async function transcribeFile(file) {
      const status = document.getElementById('status');
      const transcriptBox = document.getElementById('transcript');

      status.innerText = 'Reading file...';
      const arrayBuffer = await file.arrayBuffer();
      const audioData = new Uint8Array(arrayBuffer);

      status.innerText = 'Transcribing... (this may take a while)';

      // Ghi file vào FS ảo Emscripten
      const filename = '/input_audio.' + file.name.split('.').pop();
      Module.FS_writeFile(filename, audioData);

      // Gọi hàm Whisper (giả sử whisper.js expose function `whisper_transcribe`)
      // Tùy Whisper WASM version, bạn sẽ gọi API hơi khác
      // Đây là ví dụ chung:
      try {
        const result = Module.whisper_transcribe(filename, 'small', 'en');
        transcriptBox.value = result;
        status.innerText = 'Transcription complete!';
      } catch (e) {
        status.innerText = 'Error: ' + e.message;
        console.error(e);
      }
    }

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      transcribeFile(file);
    });

    loadWhisper();
  </script>
</body>
</html>
