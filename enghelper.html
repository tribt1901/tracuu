<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình tạo Transcript từ MP3</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Progress bar cho model */
        progress {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            border: none;
        }
        progress::-webkit-progress-bar {
            background-color: theme('colors.gray.200');
        }
        progress::-webkit-progress-value {
            background-color: theme('colors.green.500');
            transition: width 0.3s ease;
        }
        progress::-moz-progress-bar {
            background-color: theme('colors.green.500');
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8 max-w-2xl"> <!-- Thay đổi max-width -->
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 text-center">Trình tạo Transcript từ MP3</h1>
            <p class="text-center text-gray-600 mt-2">Xử lý file MP3 (tiếng Anh) ngay trên trình duyệt của bạn (Client-side).</p>
        </header>

        <!-- Main Content -->
        <div class="space-y-6">

            <!-- Cột 1: Tải file & Tạo Transcript (Client-side) -->
            <div class="space-y-6">
                <!-- Tải lên tệp âm thanh -->
                <div class="rounded-lg border border-gray-200 p-4 bg-white shadow-sm">
                    <label for="audio-upload" class="block text-sm font-medium text-gray-700 mb-2">
                        1. Tải lên tệp âm thanh (MP3)
                    </label>
                    <input type="file" id="audio-upload" accept="audio/mp3, audio/mpeg" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer">
                    <audio id="audio-player" controls class="w-full mt-4 rounded-lg" style="display: none;"></audio>
                </div>

                <!-- Nút Tạo Transcript (Client-side) -->
                <div class="rounded-lg border border-gray-200 p-4 bg-white shadow-sm">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        2. Tạo Transcript (Trên Trình duyệt)
                    </label>
                    <button id="generate-transcript-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-150">
                        Tạo Transcript từ MP3
                    </button>
                    <p class="text-xs text-gray-500 mt-2 italic">Dùng AI (Whisper) chạy ngay trên trình duyệt. Lần đầu sẽ mất thời gian tải mô hình.</p>
                </div>

                <!-- Hiển thị nội dung Transcript -->
                <div class="rounded-lg border border-gray-200 p-4 bg-white shadow-sm">
                     <h3 class="text-lg font-semibold text-gray-800 mb-2">Nội dung Transcript (Từ MP3)</h3>
                     <div id="transcript-status" class="text-sm text-gray-500 mb-2"></div>
                     <progress id="transcript-progress" class="hidden" max="100" value="0"></progress>
                     <div id="transcript-display" class="w-full h-96 bg-gray-50 rounded-lg p-3 overflow-y-auto text-gray-600 text-sm border border-gray-200">
                        Vui lòng nhấn nút "Tạo Transcript từ MP3" sau khi tải file...
                     </div>
                </div>
            </div>

            <!-- CỘT 2 VÀ 3 (HỎI ĐÁP) ĐÃ BỊ XÓA BỎ -->

        </div>
    </div>

    <script type="module">
        // --- Lớp quản lý mô hình AI (Whisper) ---
        // Đảm bảo chúng ta chỉ tải mô hình một lần duy nhất
        class SpeechRecognitionPipeline {
            static task = 'automatic-speech-recognition';
            static model = 'Xenova/whisper-tiny.en'; // Model nhỏ cho tiếng Anh (khoảng 70MB)
            static instance = null;

            static async getInstance(progress_callback = null) {
                if (this.instance === null) {
                    try {
                        // SỬA LỖI: Import thư viện Transformers CHỈ KHI CẦN
                        const { env, pipeline } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1');

                        // SỬA LỖI 404: Ép thư viện tải mô hình từ xa (Hugging Face)
                        env.allowLocalModels = false;
                        env.allowRemoteModels = true;

                        this.instance = await pipeline(this.task, this.model, { 
                            progress_callback,
                            chunk_length_s: 30,
                            stride_length_s: 5
                        });
                    } catch (error) {
                        console.error("Không thể tải mô hình AI:", error);
                        throw error; // Ném lỗi ra ngoài để hàm click xử lý
                    }
                }
                return this.instance;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Biến toàn cục
            let audioFileUrl = null; // Lưu URL của file MP3

            // Cột 1: Tải file & Tạo Transcript
            const audioUpload = document.getElementById('audio-upload');
            const audioPlayer = document.getElementById('audio-player');
            const generateTranscriptBtn = document.getElementById('generate-transcript-btn');
            const transcriptDisplay = document.getElementById('transcript-display');
            const transcriptStatus = document.getElementById('transcript-status');
            const transcriptProgress = document.getElementById('transcript-progress');
            
            // --- Xử lý Cột 1: Tải MP3 ---
            audioUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (audioFileUrl) {
                        URL.revokeObjectURL(audioFileUrl); // Thu hồi URL cũ
                    }
                    audioFileUrl = URL.createObjectURL(file); // Tạo URL mới
                    audioPlayer.src = audioFileUrl;
                    audioPlayer.style.display = 'block'; // SỬA LỖI: Hiển thị audio player
                    transcriptDisplay.textContent = "Sẵn sàng tạo transcript...";
                    transcriptStatus.textContent = `Đã tải: ${file.name}.`;
                }
            });

            // --- Xử lý Cột 1: Nút Tạo Transcript (Client-side) ---
            generateTranscriptBtn.addEventListener('click', async () => {
                if (!audioFileUrl) {
                    transcriptStatus.textContent = "Lỗi: Vui lòng chọn một tệp MP3 trước.";
                    return;
                }

                transcriptStatus.textContent = "Đang khởi tạo mô hình AI...";
                transcriptDisplay.textContent = "";
                transcriptProgress.classList.remove('hidden');
                transcriptProgress.value = 0;
                generateTranscriptBtn.disabled = true;
                generateTranscriptBtn.textContent = "Đang xử lý...";

                try {
                    // 1. Tải mô hình (chỉ tải lần đầu)
                    const transcriber = await SpeechRecognitionPipeline.getInstance((progress) => {
                        if (progress.status === 'download' || progress.status === 'progress') {
                            // SỬA LỖI: Đảm bảo progress.total > 0
                            const percentage = progress.total > 0 ? (progress.loaded / progress.total) * 100 : 0;
                            transcriptStatus.textContent = `Đang tải mô hình: ${progress.file} (${percentage.toFixed(0)}%)`;
                            transcriptProgress.value = percentage;
                        } else {
                            transcriptStatus.textContent = `Trạng thái: ${progress.status}`;
                        }
                    });

                    // 2. Xử lý âm thanh
                    transcriptStatus.textContent = "Đang xử lý âm thanh... (Việc này có thể mất vài phút)";
                    transcriptProgress.value = 0; // Reset
                    
                    const output = await transcriber(audioFileUrl, {
                        // Callback cho quá trình xử lý (tính toán)
                        progress_callback: (progress) => {
                            if (progress.status === 'transcribing') {
                                // SỬA LỖI: Đảm bảo progress.total_chunks > 0
                                const percentage = progress.total_chunks > 0 ? (progress.processed_chunks / progress.total_chunks) * 100 : 0;
                                transcriptProgress.value = percentage;
                                transcriptStatus.textContent = `Đang xử lý... (${percentage.toFixed(0)}%)`;
                            }
                        }
                    });

                    // 3. Hiển thị kết quả
                    transcriptDisplay.textContent = output.text; // Hiển thị transcript
                    transcriptStatus.textContent = "Hoàn thành!";
                    transcriptProgress.classList.add('hidden');

                } catch (error) {
                    console.error("Lỗi khi xử lý âm thanh (client-side):", error);
                    transcriptDisplay.textContent = `Đã xảy ra lỗi khi tạo transcript. Chi tiết: ${error.message}.`;
                    transcriptStatus.textContent = "Xử lý thất bại.";
                    transcriptProgress.classList.add('hidden');
                } finally {
                    generateTranscriptBtn.disabled = false;
                    generateTranscriptBtn.textContent = "Tạo Transcript từ MP3";
                }
            });

            // --- TẤT CẢ CODE CHO CỘT 2 VÀ 3 ĐÃ BỊ XÓA BỎ ---
        });
    </script>
</body>
</html>

