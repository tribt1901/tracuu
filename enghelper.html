<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>C√¥ng c·ª• H·ªçc ti·∫øng Anh ‚Äî Offline Transcription (WASM)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, sans-serif; }
    .input-tab-content { display: none; }
    .input-tab-content.active { display: block; }
    .tab-btn.active { border-bottom-color: #3B82F6; color:#3B82F6; font-weight:600 }
    .online-counter-box { text-align:center; padding:8px; background:#f0fdf4; color:#166534; font-weight:500; border-bottom:1px solid #dcfce7; }
    .muted { color:#6b7280; font-size:0.9rem }
  </style>
</head>

<body class="bg-light">
  <!-- Navbar s·∫Ω load t·ª´ file menu.html -->
  <header id="navbar-placeholder"></header>

  <!-- B·ªô ƒë·∫øm ng∆∞·ªùi online -->
  <div class="online-counter-box">
    üü¢ Hi·ªán c√≥ B·∫°n v√† <span id="online-counter">0</span> ng∆∞·ªùi n·ªØa ƒëang truy c·∫≠p h·ªá th·ªëng.
  </div>

  <!-- Main app -->
  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden my-6">
    <header class="bg-blue-600 p-6">
      <h1 class="text-2xl text-white font-bold">C√¥ng c·ª• H·ªçc ti·∫øng Anh ‚Äî Offline Transcription</h1>
      <p class="text-blue-100 mt-1">Ch·∫°y ho√†n to√†n tr√™n tr√¨nh duy·ªát (WASM + model l∆∞u trong repo). Kh√¥ng g·ªçi API b√™n ngo√†i.</p>
    </header>

    <main class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- C·ªôt 1: Upload + transcript -->
      <div class="space-y-6">
        <div class="rounded-lg border p-4">
          <label class="block font-medium mb-2">1. Ch·ªçn file √¢m thanh (MP3)</label>
          <input id="audio-upload" type="file" accept="audio/*" class="w-full" />
          <audio id="audio-player" controls class="w-full mt-3 hidden"></audio>
          <div id="worker-status" class="mt-2 muted">Worker: ch∆∞a kh·ªüi t·∫°o</div>
          <div id="transcription-progress" class="mt-2 muted"></div>
        </div>

        <div class="rounded-lg border p-4">
          <h3 class="font-semibold mb-2">N·ªôi dung vƒÉn b·∫£n (Tr√≠ch xu·∫•t t·ª´ MP3)</h3>
          <div id="transcript-display" class="w-full h-48 bg-gray-50 rounded p-3 overflow-y-auto text-sm text-gray-700 border">
            Vui l√≤ng t·∫£i MP3 l√™n. K·∫øt qu·∫£ tr√≠ch xu·∫•t s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y.
          </div>
        </div>
      </div>

      <!-- C·ªôt 2: Nh·∫≠p c√¢u h·ªèi + t√¨m ki·∫øm -->
      <div class="space-y-6">
        <div class="rounded-lg border p-4">
          <h3 class="font-semibold mb-3">2. Nh·∫≠p c√¢u h·ªèi</h3>
          <div class="border-b mb-4">
            <nav class="flex space-x-4" aria-label="Tabs">
              <button class="tab-btn active" data-tab="text">G√µ tay</button>
              <button class="tab-btn" data-tab="image">Qu√©t ·∫£nh</button>
              <button class="tab-btn" data-tab="voice">Gi·ªçng n√≥i</button>
            </nav>
          </div>

          <div>
            <div id="tab-text" class="input-tab-content active">
              <textarea id="text-input" class="w-full h-24 p-2 border rounded" placeholder="Nh·∫≠p c√¢u h·ªèi..."></textarea>
            </div>
            <div id="tab-image" class="input-tab-content">
              <input id="image-upload" type="file" accept="image/*" />
            </div>
            <div id="tab-voice" class="input-tab-content">
              <button id="voice-input-btn" class="w-full py-3 bg-red-600 text-white rounded">Nh·∫•n ƒë·ªÉ n√≥i</button>
            </div>
          </div>

          <button id="search-btn" class="w-full mt-4 py-3 bg-blue-600 text-white rounded">T√¨m ki·∫øm trong n·ªôi dung</button>
        </div>

        <div class="rounded-lg border p-4">
          <h3 class="font-semibold mb-2">3. K·∫øt qu·∫£</h3>
          <div id="status" class="text-sm italic text-gray-500 mb-2">S·∫µn s√†ng</div>
          <div id="answer-display" class="min-h-[5rem] bg-gray-50 p-3 border text-gray-700">K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</div>
        </div>
      </div>
    </main>
  </div>

  <!-- ---------- Script ch√≠nh ---------- -->
  <script>
    const WORKER_PATH = '/whisper_worker.js';
    const DEFAULT_MODEL_URL = '/whisper/ggml-small.en.bin';

    const audioUpload = document.getElementById('audio-upload');
    const audioPlayer = document.getElementById('audio-player');
    const transcriptDisplay = document.getElementById('transcript-display');
    const workerStatusEl = document.getElementById('worker-status');
    const transcriptionProgress = document.getElementById('transcription-progress');
    const textInput = document.getElementById('text-input');
    const searchBtn = document.getElementById('search-btn');
    const statusEl = document.getElementById('status');
    const answerDisplay = document.getElementById('answer-display');
    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.input-tab-content');
    const voiceInputBtn = document.getElementById('voice-input-btn');

    let transcriptContent = '';
    let worker = null;
    let workerReady = false;

    function initWorker() {
      if (worker) return;
      try {
        worker = new Worker(WORKER_PATH);
      } catch (e) {
        workerStatusEl.textContent = 'Kh√¥ng th·ªÉ t·∫°o worker: ' + e.message;
        return;
      }
      worker.onmessage = (ev) => {
        const m = ev.data;
        if (!m) return;
        if (m.type === 'ready') {
          workerReady = true;
          workerStatusEl.textContent = `Worker: s·∫µn s√†ng. Engine: ${m.engine || 'unknown'}`;
        } else if (m.type === 'progress') {
          transcriptionProgress.textContent = m.message;
        } else if (m.type === 'result') {
          transcriptContent = m.text || '';
          transcriptDisplay.textContent = transcriptContent;
          transcriptionProgress.textContent = '';
          statusEl.textContent = 'ƒê√£ tr√≠ch xu·∫•t th√†nh c√¥ng.';
        } else if (m.type === 'error') {
          transcriptionProgress.textContent = '';
          statusEl.textContent = 'L·ªói: ' + m.message;
        }
      };
      worker.postMessage({ cmd: 'init', modelUrl: DEFAULT_MODEL_URL });
    }

    async function decodeAudioFileToFloat32(file) {
      const arrayBuffer = await file.arrayBuffer();
      const ctx = new AudioContext();
      const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
      const channel = audioBuffer.numberOfChannels > 1
        ? audioBuffer.getChannelData(0).map((v, i) =>
            (v + audioBuffer.getChannelData(1)[i]) / 2
          )
        : audioBuffer.getChannelData(0);
      return { samples: channel, sampleRate: audioBuffer.sampleRate };
    }

    function floatTo16BitPCM(float32Array) {
      const buffer = new Int16Array(float32Array.length);
      for (let i = 0; i < float32Array.length; i++) {
        let s = Math.max(-1, Math.min(1, float32Array[i]));
        buffer[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      return buffer;
    }

    audioUpload.addEventListener('change', async (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      initWorker();
      audioPlayer.src = URL.createObjectURL(file);
      audioPlayer.classList.remove('hidden');
      transcriptionProgress.textContent = 'ƒêang gi·∫£i m√£...';
      try {
        const { samples, sampleRate } = await decodeAudioFileToFloat32(file);
        const int16 = floatTo16BitPCM(samples);
        worker.postMessage({ cmd: 'transcribe', audioBuffer: int16.buffer, sampleRate }, [int16.buffer]);
        statusEl.textContent = 'ƒêang x·ª≠ l√Ω audio...';
      } catch (err) {
        statusEl.textContent = 'L·ªói: ' + err.message;
      }
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const t = tab.dataset.tab;
        tabs.forEach(x => x.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + t).classList.add('active');
      });
    });

    searchBtn.addEventListener('click', () => {
      const q = textInput.value.trim().toLowerCase();
      if (!q) { statusEl.textContent = 'Nh·∫≠p c√¢u h·ªèi.'; return; }
      if (!transcriptContent) { statusEl.textContent = 'Ch∆∞a c√≥ transcript.'; return; }
      const idx = transcriptContent.toLowerCase().indexOf(q);
      if (idx === -1) {
        statusEl.textContent = 'Kh√¥ng t√¨m th·∫•y.';
        answerDisplay.textContent = 'Kh√¥ng t√¨m th·∫•y.';
        return;
      }
      const before = Math.max(0, idx - 80);
      const after = Math.min(transcriptContent.length, idx + 220);
      const snippet = transcriptContent.substring(before, after);
      answerDisplay.innerHTML = snippet.replace(new RegExp(q, 'gi'), m => `<mark style="background:yellow">${m}</mark>`);
      statusEl.textContent = 'ƒê√£ t√¨m th·∫•y.';
    });

    initWorker();
  </script>

  <!-- ---------- Firebase & Online Counter ---------- -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getDatabase, ref, push, onValue, onDisconnect, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92c",
        authDomain: "tracuu-d3ee9.firebaseapp.com",
        databaseURL: "https://tracuu-d3ee9-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tracuu-d3ee9",
        storageBucket: "tracuu-d3ee9.appspot.com",
        messagingSenderId: "593568604435",
        appId: "1:593568604435:web:9a5145457a8ee734143ae6"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const rtdb = getDatabase(app, firebaseConfig.databaseURL);

      // ƒê·∫øm s·ªë ng∆∞·ªùi online
      (function initOnlineCounter() {
        const onlineCounterEl = document.getElementById('online-counter');
        const connectionsRef = ref(rtdb, 'connections');
        const myRef = push(connectionsRef);
        onDisconnect(myRef).remove().catch(()=>{});
        set(myRef, true);
        onValue(connectionsRef, snap => {
          let count = 0;
          if (snap.exists()) {
            const val = snap.val();
            count = typeof val === 'object' ? Object.keys(val).length : 1;
          }
          onlineCounterEl.textContent = count;
        });
      })();

      // Load menu
      fetch('/menu.html')
        .then(r => r.text())
        .then(html => {
          document.getElementById('navbar-placeholder').innerHTML = html;
        })
        .catch(()=>{});
    });
  </script>
</body>
</html>
