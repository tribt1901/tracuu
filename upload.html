<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="utf-8"/>
Â  <title>Upload Dá»¯ Liá»‡u</title>
Â  <meta content="width=device-width, initial-scale=1" name="viewport"/>
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
Â  <style>
Â  Â  .mode-section { display: none; }
Â  Â  body { padding-top: 70px; }
Â  Â  #importHtmlResultContainer { max-height: 350px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 5px; padding: 12px;}
Â  Â  .img-preview, .img-preview-ans { max-width: 120px; max-height: 70px; display: inline-block; margin-top: 6px; vertical-align: middle;}
Â  Â  .img-preview-ans { max-width: 70px; max-height: 40px; }
Â  Â  .img-upload-btn { margin-top: 3px; }
Â  Â  .remove-img-btn { margin-left: 6px; color: red; border: none; background: none; }
Â  Â  .subject-scroll-select { max-height: 240px !important; overflow-y: auto !important; }
Â  Â  .security-section {max-width: 360px; margin-bottom: 16px;}
Â  Â  @media (max-width: 600px) {
Â  Â  Â  #importHtmlResultContainer { max-height: 210px;}
Â  Â  }
Â  Â  .import-duplicate .import-question-title,
Â  Â  .import-duplicate .import-answer,
Â  Â  .import-duplicate .import-duplicate-message {
Â  Â  Â  color: #c00!important;
Â  Â  }
Â  Â  .import-duplicate .import-answer-correct {
Â  Â  Â  color: #c00!important;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .import-question-title {
Â  Â  Â  font-weight: 500;
Â  Â  Â  color: #0d6efd;
Â  Â  }
Â  Â  .import-answer-correct {
Â  Â  Â  color: #198754;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .import-answer {
Â  Â  Â  margin-left: 2em;
Â  Â  }
Â  Â  .import-duplicate-message {
Â  Â  Â  color: #c00;
Â  Â  Â  font-style: italic;
Â  Â  }
Â  Â  .image-warning-text { color: #d35400; font-weight: 500; }
Â  </style>
Â  <link rel="icon" href="data:,">
Â  <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark shadow-sm fixed-top" style="background-color: #3B5C94;">
Â  <div class="container-fluid">
Â  Â  <a class="navbar-brand text-white" href="/">ğŸ“¥ Upload Dá»¯ Liá»‡u</a>
Â  Â  <button class="navbar-toggler" data-bs-target="#navbarNav" data-bs-toggle="collapse" type="button">
Â  Â  Â  <span class="navbar-toggler-icon"></span>
Â  Â  </button>
Â  Â  <div class="collapse navbar-collapse" id="navbarNav">
Â  Â  Â  <ul class="navbar-nav ms-auto">
Â  Â  Â  Â  <li class="nav-item"><a class="nav-link text-white" href="/">Trang Chá»§</a></li>
Â  Â  Â  Â  <li class="nav-item"><a class="nav-link text-white" href="/upload">Upload</a></li>
Â  Â  Â  Â  <li class="nav-item"><a class="nav-link text-white" href="/subjects">MÃ´n há»c</a></li>
Â  Â  Â  Â  <li class="nav-item"><a class="nav-link text-white" href="/export">Äá» CÆ°Æ¡ng</a></li>
Â  Â  Â  Â  <li class="nav-item"><a class="nav-link text-white" href="/outline">Äá» cÆ°Æ¡ng ÄÃ³ng gÃ³p</a></li>
Â  Â  Â  Â  <li class="nav-item"><a class="nav-link text-white" href="/wifi-qrcode">Táº¡o QR Code Wifi</a></li>
Â  Â  Â  </ul>
Â  Â  </div>
Â  </div>
</nav>
<div class="online-counter-box text-center" style="background-color: #e8f5e9; color: #2e7d32; border-left: 5px solid #4caf50; padding: 10px 16px; margin: 20px auto 10px; border-radius: 6px; max-width: 600px; font-weight: 500;">
Â  ğŸŸ¢ Hiá»‡n cÃ³ Báº¡n vÃ  <span id="online-counter">0</span> ngÆ°á»i ná»¯a Ä‘ang truy cáº­p há»‡ thá»‘ng.
</div>
<div class="container py-4">
Â  <h3 class="mb-4">Chá»n loáº¡i upload:</h3>
Â  <select class="form-select mb-4 subject-scroll-select" id="uploadTypeSelect" style="max-width:360px;">
Â  Â  <option value="question">Upload CÃ¢u há»i</option>
Â  Â  <option value="syllabus">Upload Äá» cÆ°Æ¡ng</option>
Â  </select>
Â  <div class="mode-section" id="uploadQuestionSection">
Â  Â  <div id="questionUploadChoice" style="max-width:360px;">
Â  Â  Â  <button class="btn btn-primary me-2" id="questionImportHtmlBtn">Nháº­p tá»« file HTML Moodle</button>
Â  Â  Â  <button class="btn btn-success" id="questionManualBtn">ThÃªm thá»§ cÃ´ng</button>
Â  Â  </div>
Â  Â  <div id="importHtmlSection" style="display:none;">
Â  Â  Â  <h5 class="mt-3">Nháº­p cÃ¢u há»i tá»« file HTML Moodle</h5>
Â  Â  Â  <select class="form-select mb-2 subject-scroll-select" id="subjectDropdownImport" style="max-width:350px;">
Â  Â  Â  Â  <option value="">-- Chá»n mÃ´n há»c Ä‘á»ƒ lÆ°u --</option>
Â  Â  Â  </select>
Â  Â  Â  <input type="file" id="importHtmlInput" accept=".html,.htm" class="form-control mb-2" style="max-width:350px;" disabled>
Â  Â  Â  <div id="importHtmlResultContainer">
Â  Â  Â  Â  <div id="importHtmlResult" class="mt-3"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="security-section" style="margin-top:10px;">
Â  Â  Â  Â  <input type="password" class="form-control mb-1" id="questionSecurityCodeImport" placeholder="Nháº­p mÃ£ báº£o máº­t Ä‘á»ƒ lÆ°u">
Â  Â  Â  Â  <div id="questionSecurityCodeStatusImport" style="font-size:0.95em;" class="mb-2"></div>
Â  Â  Â  </div>
Â  Â  Â  <button class="btn btn-success mt-2" id="saveImportBtn" style="display:none;" disabled>ğŸ’¾ LÆ°u vÃ o CSDL</button>
Â  Â  Â  <button class="btn btn-secondary mt-2" id="backToQuestionChoiceBtn">â† Quay láº¡i</button>
Â  Â  </div>
Â  Â  <div id="manualQuestionSection" style="display:none;">
Â  Â  Â  <h5 class="mt-3">ThÃªm cÃ¢u há»i thá»§ cÃ´ng</h5>
Â  Â  Â  <form id="manualQuestionForm" autocomplete="off">
Â  Â  Â  Â  <select class="form-select mb-2 subject-scroll-select" id="subjectDropdownManual" required></select>
Â  Â  Â  Â  <textarea class="form-control mb-2" id="manualQuestionText" placeholder="Ná»™i dung cÃ¢u há»i (há»— trá»£ MathJax)" required rows="3"></textarea>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <input type="file" accept="image/*" id="manualQuestionImageInput" class="form-control form-control-sm img-upload-btn" style="max-width:260px;">
Â  Â  Â  Â  Â  <img id="manualQuestionImgPreview" class="img-preview" style="display:none"/>
Â  Â  Â  Â  Â  <button type="button" class="remove-img-btn" id="manualRemoveQuestionImgBtn" style="display:none;">âœ–</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="answer-input-group mb-2">
Â  Â  Â  Â  Â  <label for="manualAnswerA" class="form-label mb-1">ÄÃ¡p Ã¡n a</label>
Â  Â  Â  Â  Â  <input class="form-control" id="manualAnswerA" placeholder="ÄÃ¡p Ã¡n a" required type="text"/>
Â  Â  Â  Â  Â  <input type="file" accept="image/*" id="manualAnswerAImgInput" class="form-control form-control-sm img-upload-btn" style="max-width:220px;">
Â  Â  Â  Â  Â  <img id="manualAnswerAImgPreview" class="img-preview-ans" style="display:none"/>
Â  Â  Â  Â  Â  <button type="button" class="remove-img-btn" id="manualRemoveAImgBtn" style="display:none;">âœ–</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="answer-input-group mb-2">
Â  Â  Â  Â  Â  <label for="manualAnswerB" class="form-label mb-1">ÄÃ¡p Ã¡n b</label>
Â  Â  Â  Â  Â  <input class="form-control" id="manualAnswerB" placeholder="ÄÃ¡p Ã¡n b" required type="text"/>
Â  Â  Â  Â  Â  <input type="file" accept="image/*" id="manualAnswerBImgInput" class="form-control form-control-sm img-upload-btn" style="max-width:220px;">
Â  Â  Â  Â  Â  <img id="manualAnswerBImgPreview" class="img-preview-ans" style="display:none"/>
Â  Â  Â  Â  Â  <button type="button" class="remove-img-btn" id="manualRemoveBImgBtn" style="display:none;">âœ–</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="answer-input-group mb-2">
Â  Â  Â  Â  Â  <label for="manualAnswerC" class="form-label mb-1">ÄÃ¡p Ã¡n c</label>
Â  Â  Â  Â  Â  <input class="form-control" id="manualAnswerC" placeholder="ÄÃ¡p Ã¡n c" required type="text"/>
Â  Â  Â  Â  Â  <input type="file" accept="image/*" id="manualAnswerCImgInput" class="form-control form-control-sm img-upload-btn" style="max-width:220px;">
Â  Â  Â  Â  Â  <img id="manualAnswerCImgPreview" class="img-preview-ans" style="display:none"/>
Â  Â  Â  Â  Â  <button type="button" class="remove-img-btn" id="manualRemoveCImgBtn" style="display:none;">âœ–</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="answer-input-group mb-2">
Â  Â  Â  Â  Â  <label for="manualAnswerD" class="form-label mb-1">ÄÃ¡p Ã¡n d</label>
Â  Â  Â  Â  Â  <input class="form-control" id="manualAnswerD" placeholder="ÄÃ¡p Ã¡n d" required type="text"/>
Â  Â  Â  Â  Â  <input type="file" accept="image/*" id="manualAnswerDImgInput" class="form-control form-control-sm img-upload-btn" style="max-width:220px;">
Â  Â  Â  Â  Â  <img id="manualAnswerDImgPreview" class="img-preview-ans" style="display:none"/>
Â  Â  Â  Â  Â  <button type="button" class="remove-img-btn" id="manualRemoveDImgBtn" style="display:none;">âœ–</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <select class="form-select mb-2" id="manualCorrectAnswerDropdown" required>
Â  Â  Â  Â  Â  <option value="">Chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng</option>
Â  Â  Â  Â  Â  <option value="a">a</option>
Â  Â  Â  Â  Â  <option value="b">b</option>
Â  Â  Â  Â  Â  <option value="c">c</option>
Â  Â  Â  Â  Â  <option value="d">d</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <div class="security-section" style="margin-top:10px;">
Â  Â  Â  Â  Â  <input type="password" class="form-control mb-1" id="questionSecurityCodeManual" placeholder="Nháº­p mÃ£ báº£o máº­t Ä‘á»ƒ lÆ°u">
Â  Â  Â  Â  Â  <div id="questionSecurityCodeStatusManual" style="font-size:0.95em;" class="mb-2"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button type="submit" class="btn btn-success" id="manualSubmitQuestionBtn" disabled>ThÃªm cÃ¢u há»i</button>
Â  Â  Â  Â  <button type="button" class="btn btn-secondary mt-2" id="backToQuestionChoiceBtn2">â† Quay láº¡i</button>
Â  Â  Â  </form>
Â  Â  </div>
Â  </div>
Â  <div class="mode-section" id="uploadSyllabusSection">
Â  Â  <form id="syllabusForm" autocomplete="off">
Â  Â  Â  <select class="form-select mb-2 subject-scroll-select" id="syllabusSubjectDropdown" required></select>
Â  Â  Â  <input type="text" class="form-control mb-2" id="syllabusOwner" placeholder="TÃ i liá»‡u nÃ y cá»§a ai? (KhÃ´ng báº¯t buá»™c)">
Â  Â  Â  <input type="url" class="form-control mb-2" id="syllabusFileUrlInput" placeholder="Nháº­p Ä‘Æ°á»ng link Ä‘á» cÆ°Æ¡ng (Google Drive, OneDrive, v.v.)" required>
Â  Â  Â  <div class="security-section" style="margin-top:10px;">
Â  Â  Â  Â  <input type="password" class="form-control mb-1" id="syllabusSecurityCode" placeholder="Nháº­p mÃ£ báº£o máº­t Ä‘á»ƒ lÆ°u">
Â  Â  Â  Â  <div id="syllabusSecurityCodeStatus" style="font-size:0.95em;" class="mb-2"></div>
Â  Â  Â  </div>
Â  Â  Â  <button type="submit" class="btn btn-success" id="syllabusSubmitBtn" disabled>Upload Äá» cÆ°Æ¡ng</button>
Â  Â  </form>
Â  </div>
</div>
<script type="module">
import { getDatabase, ref, onValue, onDisconnect, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
// Sá»¬A Äá»”I 1: ThÃªm getDoc vÃ  doc Ä‘á»ƒ tá»‘i Æ°u hÃ³a
import { getFirestore, collection, addDoc, getDocs, query, where, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", () => {
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92c",
Â  Â  authDomain: "tracuu-d3ee9.firebaseapp.com",
Â  Â  projectId: "tracuu-d3ee9",
Â  Â  storageBucket: "tracuu-d3ee9.appspot.com",
Â  Â  messagingSenderId: "593568604435",
Â  Â  appId: "1:593568604435:web:9a5145457a8ee734143ae6",
Â  Â  measurementId: "G-R0M6Y502NP"
Â  };
Â  const app = initializeApp(firebaseConfig);
Â  const db = getFirestore(app);
Â  const rtdb = getDatabase(app, "https://tracuu-d3ee9-default-rtdb.asia-southeast1.firebasedatabase.app");
Â Â 
Â  const onlineCounterEl = document.getElementById('online-counter');
Â  const connectionsRef = ref(rtdb, 'connections');
Â  const myConnectionRef = push(connectionsRef);
Â  onDisconnect(myConnectionRef).remove();
Â  set(myConnectionRef, true);
Â  onValue(connectionsRef, (snapshot) => {
Â  Â  let count = 0;
Â  Â  if (snapshot.exists() && typeof snapshot.val() === 'object') {
Â  Â  Â  count = Object.keys(snapshot.val()).length;
Â  Â  }
Â  Â  onlineCounterEl.textContent = count;
Â  });

Â  // ... (CÃ¡c háº±ng sá»‘ DOM element khÃ´ng thay Ä‘á»•i)
  const manualQuestionImgPreview = document.getElementById("manualQuestionImgPreview");
Â  const manualRemoveQuestionImgBtn = document.getElementById("manualRemoveQuestionImgBtn");
Â  const manualAnswerAImgPreview = document.getElementById("manualAnswerAImgPreview");
Â  const manualRemoveAImgBtn = document.getElementById("manualRemoveAImgBtn");
Â  const manualAnswerBImgPreview = document.getElementById("manualAnswerBImgPreview");
Â  const manualRemoveBImgBtn = document.getElementById("manualRemoveBImgBtn");
Â  const manualAnswerCImgPreview = document.getElementById("manualAnswerCImgPreview");
Â  const manualRemoveCImgBtn = document.getElementById("manualRemoveCImgBtn");
Â  const manualAnswerDImgPreview = document.getElementById("manualAnswerDImgPreview");
Â  const manualRemoveDImgBtn = document.getElementById("manualRemoveDImgBtn");
Â  const manualQuestionImageInput = document.getElementById("manualQuestionImageInput");
Â  const manualAnswerAImgInput = document.getElementById("manualAnswerAImgInput");
Â  const manualAnswerBImgInput = document.getElementById("manualAnswerBImgInput");
Â  const manualAnswerCImgInput = document.getElementById("manualAnswerCImgInput");
Â  const manualAnswerDImgInput = document.getElementById("manualAnswerDImgInput");
Â  const manualSubmitQuestionBtn = document.getElementById("manualSubmitQuestionBtn");
Â  const uploadTypeSelect = document.getElementById("uploadTypeSelect");
Â  const uploadQuestionSection = document.getElementById("uploadQuestionSection");
Â  const uploadSyllabusSection = document.getElementById("uploadSyllabusSection");
Â  // ... (HÃ m uploadTypeSelect khÃ´ng thay Ä‘á»•i)
  uploadTypeSelect.addEventListener("change", () => {
Â  Â  document.querySelectorAll(".mode-section").forEach(el => el.style.display = "none");
Â  Â  if (uploadTypeSelect.value === "question") {
Â  Â  Â  uploadQuestionSection.style.display = "block";
Â  Â  } else if (uploadTypeSelect.value === "syllabus") {
Â  Â  Â  uploadSyllabusSection.style.display = "block";
Â  Â  }
Â  });
Â  uploadTypeSelect.dispatchEvent(new Event("change"));
Â  // ... (HÃ m loadSubjectsToDropdown khÃ´ng thay Ä‘á»•i)
  async function loadSubjectsToDropdown(dropdown, allowEmpty = false) {
Â  Â  dropdown.innerHTML = allowEmpty ? `<option value="">-- Chá»n mÃ´n há»c --</option>` : "";
Â  Â  const snapshot = await getDocs(collection(db, "mon_hoc"));
Â  Â  snapshot.forEach(docSnap => {
Â  Â  Â  const option = document.createElement("option");
Â  Â  Â  option.value = docSnap.id;
Â  Â  Â  option.textContent = docSnap.data().ten_mon;
Â  Â  Â  dropdown.appendChild(option);
Â  Â  });
Â  }
Â  loadSubjectsToDropdown(document.getElementById("subjectDropdownImport"), true);
Â  loadSubjectsToDropdown(document.getElementById("subjectDropdownManual"));
Â  loadSubjectsToDropdown(document.getElementById("syllabusSubjectDropdown"));
Â  // ... (HÃ m uploadToDrive khÃ´ng thay Ä‘á»•i)
  async function uploadToDrive(file) {
Â  Â  const formData = new FormData();
Â  Â  formData.append('file', file);
Â  Â  const response = await fetch('https://tracuu-app.hugo.io.vn/api/upload', { method: 'POST', body: formData });
Â  Â  if (!response.ok) throw new Error('Upload áº£nh/file tháº¥t báº¡i!');
Â  Â  const result = await response.json();
Â  Â  return result.url;
Â  }
Â  // ... (CÃ¡c biáº¿n vÃ  hÃ m xá»­ lÃ½ áº£nh khÃ´ng thay Ä‘á»•i)
  let manualQImgFile = null, manualAImgFiles = [null, null, null, null];
Â  let manualQImgUrl = "", manualAImgUrls = ["","","",""];
Â  function handleImgInput(input, preview, removeBtn, setFile, setUrl) {
Â  Â  input.addEventListener("change", function() {
Â  Â  Â  if(this.files && this.files[0]) {
Â  Â  Â  Â  setFile(this.files[0]);
Â  Â  Â  Â  preview.src = URL.createObjectURL(this.files[0]);
Â  Â  Â  Â  preview.style.display = "";
Â  Â  Â  Â  removeBtn.style.display = "";
Â  Â  Â  Â  setUrl("");
Â  Â  Â  }
Â  Â  });
Â  Â  removeBtn.addEventListener("click", function() {
Â  Â  Â  setFile(null);
Â  Â  Â  preview.src = "";
Â  Â  Â  preview.style.display = "none";
Â  Â  Â  removeBtn.style.display = "none";
Â  Â  Â  input.value = "";
Â  Â  Â  setUrl("");
Â  Â  });
Â  }
Â  handleImgInput(manualQuestionImageInput, manualQuestionImgPreview, manualRemoveQuestionImgBtn, f=>manualQImgFile=f, url=>manualQImgUrl=url);
Â  handleImgInput(manualAnswerAImgInput, manualAnswerAImgPreview, manualRemoveAImgBtn, f=>manualAImgFiles[0]=f, url=>manualAImgUrls[0]=url);
Â  handleImgInput(manualAnswerBImgInput, manualAnswerBImgPreview, manualRemoveBImgBtn, f=>manualAImgFiles[1]=f, url=>manualAImgUrls[1]=url);
Â  handleImgInput(manualAnswerCImgInput, manualAnswerCImgPreview, manualRemoveCImgBtn, f=>manualAImgFiles[2]=f, url=>manualAImgUrls[2]=url);
Â  handleImgInput(manualAnswerDImgInput, manualAnswerDImgPreview, manualRemoveDImgBtn, f=>manualAImgFiles[3]=f, url=>manualAImgUrls[3]=url);
Â Â 
Â  // ... (CÃ¡c biáº¿n vÃ  hÃ m xá»­ lÃ½ logic trÃ¹ng láº·p khÃ´ng thay Ä‘á»•i)
  let importedQuestions = [];
Â  let allQuestionsForSubject = [];
Â  let imagesFoundCount = 0;Â 
Â  function normalizeCompareString(str) {
Â  Â  return (str || "").replace(/\\\([^\)]*\\\)/g, '').replace(/\[HÃŒNH áº¢NH\]/g, '').replace(/<.*?>/g, '').replace(/[\s\r\n]+/g, ' ').trim().toLowerCase();
Â  }
Â  function getNormalizedAnswers(lua_chon) {
Â  Â  return ['a','b','c','d'].map(k => normalizeCompareString(lua_chon?.[k])).filter(x => x);
Â  }
Â  function isDuplicateInSet(question, existSet) {
Â  Â  const content = normalizeCompareString(question.noi_dung);
Â  Â  const answers = getNormalizedAnswers(question.lua_chon).sort();
Â  Â  const correctContent = normalizeCompareString(question.lua_chon?.[question.dap_an_dung]);
Â  Â  for (const q of existSet) {
Â  Â  Â  const qContent = normalizeCompareString(q.noi_dung);
Â  Â  Â  const qAnswers = getNormalizedAnswers(q.lua_chon).sort();
Â  Â  Â  const qCorrectContent = normalizeCompareString(q.lua_chon?.[q.dap_an_dung]);
Â  Â  Â  if (content !== qContent) continue;
Â  Â  Â  if (answers.length !== qAnswers.length) continue;
Â  Â  Â  let allAnswersMatch = answers.every((val, index) => val === qAnswers[index]);
Â  Â  Â  if (!allAnswersMatch) continue;
Â  Â  Â  if (correctContent === qCorrectContent) return true;
Â  Â  }
Â  Â  return false;
Â  }
Â  async function loadQuestionsForSubject(mon_hoc_id) {
Â  Â  const qs = [];
Â  Â  if(!mon_hoc_id) return [];
Â  Â  const snapshot = await getDocs(query(collection(db, "cau_hoi"), where("mon_hoc_id", "==", mon_hoc_id)));
Â  Â  snapshot.forEach(docSnap => {
Â  Â  Â  qs.push(docSnap.data());
Â  Â  });
Â  Â  return qs;
Â  }
Â Â 
Â  // ... (CÃ¡c háº±ng sá»‘ DOM element vÃ  hÃ m chuyá»ƒn Ä‘á»•i giao diá»‡n khÃ´ng thay Ä‘á»•i)
  const backToQuestionChoiceBtn = document.getElementById("backToQuestionChoiceBtn");
Â  const backToQuestionChoiceBtn2 = document.getElementById("backToQuestionChoiceBtn2");
Â  const importHtmlSection = document.getElementById("importHtmlSection");
Â  const manualQuestionSection = document.getElementById("manualQuestionSection");
Â  const importHtmlResult = document.getElementById("importHtmlResult");
Â  const importHtmlInput = document.getElementById("importHtmlInput");
Â  const saveImportBtn = document.getElementById("saveImportBtn");
Â  const subjectDropdownImport = document.getElementById("subjectDropdownImport");
Â  const manualQuestionForm = document.getElementById("manualQuestionForm");

Â  document.getElementById("questionImportHtmlBtn").onclick = () => {
Â  Â  document.getElementById("questionUploadChoice").style.display = "none";
Â  Â  importHtmlSection.style.display = "block";
Â  Â  manualQuestionSection.style.display = "none";
Â  };
Â  document.getElementById("questionManualBtn").onclick = () => {
Â  Â  document.getElementById("questionUploadChoice").style.display = "none";
Â  Â  importHtmlSection.style.display = "none";
Â  Â  manualQuestionSection.style.display = "block";
Â  };
Â  backToQuestionChoiceBtn.onclick = backToQuestionChoiceBtn2.onclick = () => {
Â  Â  document.getElementById("questionUploadChoice").style.display = "block";
Â  Â  importHtmlSection.style.display = "none";
Â  Â  manualQuestionSection.style.display = "none";
Â  };

Â  // Sá»¬A Äá»”I 2.1: Tá»‘i Æ°u hÃ³a kiá»ƒm tra mÃ£ cho Import
Â  let questionSecOKImport = false;
Â  document.getElementById("questionSecurityCodeImport").addEventListener("input", async function() {
Â  Â  const val = this.value.trim();
Â  Â  const statusEl = document.getElementById("questionSecurityCodeStatusImport");
Â  Â  statusEl.textContent = val ? "Äang kiá»ƒm tra..." : "";
Â  Â  questionSecOKImport = false;
Â  Â  saveImportBtn.disabled = true;
Â  Â  if (!val) { statusEl.textContent = ""; return; }
    // Thay tháº¿ query báº±ng getDoc Ä‘á»ƒ báº£o máº­t vÃ  hiá»‡u quáº£ hÆ¡n
Â  Â  const docRef = doc(db, "config", "security_code");
    const snap = await getDoc(docRef);
Â  Â  if (snap.exists() && snap.data().code === val) {
Â  Â  Â  questionSecOKImport = true;
Â  Â  Â  statusEl.innerHTML = '<span class="text-success">MÃ£ há»£p lá»‡!</span>';
Â  Â  Â  if(importedQuestions.length > 0) saveImportBtn.disabled = false;
Â  Â  } else {
Â  Â  Â  statusEl.innerHTML = '<span class="text-danger">MÃ£ khÃ´ng há»£p lá»‡!</span>';
Â  Â  }
Â  });

Â  // Sá»¬A Äá»”I 2.2: Tá»‘i Æ°u hÃ³a kiá»ƒm tra mÃ£ cho Manual
Â  let questionSecOKManual = false;
Â  document.getElementById("questionSecurityCodeManual").addEventListener("input", async function() {
Â  Â  const val = this.value.trim();
Â  Â  const statusEl = document.getElementById("questionSecurityCodeStatusManual");
Â  Â  statusEl.textContent = val ? "Äang kiá»ƒm tra..." : "";
Â  Â  questionSecOKManual = false;
Â  Â  manualSubmitQuestionBtn.disabled = true;
Â  Â  if (!val) { statusEl.textContent = ""; return; }
    // Thay tháº¿ query báº±ng getDoc Ä‘á»ƒ báº£o máº­t vÃ  hiá»‡u quáº£ hÆ¡n
Â  Â  const docRef = doc(db, "config", "security_code");
    const snap = await getDoc(docRef);
Â  Â  if (snap.exists() && snap.data().code === val) {
Â  Â  Â  questionSecOKManual = true;
Â  Â  Â  statusEl.innerHTML = '<span class="text-success">MÃ£ há»£p lá»‡!</span>';
Â  Â  Â  manualSubmitQuestionBtn.disabled = false;
Â  Â  } else {
Â  Â  Â  statusEl.innerHTML = '<span class="text-danger">MÃ£ khÃ´ng há»£p lá»‡!</span>';
Â  Â  }
Â  });

Â  // Sá»¬A Äá»”I 2.3: Tá»‘i Æ°u hÃ³a kiá»ƒm tra mÃ£ cho Syllabus
Â  const syllabusSubmitBtn = document.getElementById("syllabusSubmitBtn");
Â  document.getElementById("syllabusSecurityCode").addEventListener("input", async function() {
Â  Â  const val = this.value.trim();
Â  Â  const statusEl = document.getElementById("syllabusSecurityCodeStatus");
Â  Â  statusEl.textContent = val ? "Äang kiá»ƒm tra..." : "";
Â  Â  syllabusSubmitBtn.disabled = true;
Â  Â  if (!val) { statusEl.textContent = ""; return; }
    // Thay tháº¿ query báº±ng getDoc Ä‘á»ƒ báº£o máº­t vÃ  hiá»‡u quáº£ hÆ¡n
Â  Â  const docRef = doc(db, "config", "security_code");
    const snap = await getDoc(docRef);
Â  Â  if (snap.exists() && snap.data().code === val) {
Â  Â  Â  statusEl.innerHTML = '<span class="text-success">MÃ£ há»£p lá»‡!</span>';
Â  Â  Â  syllabusSubmitBtn.disabled = false;
Â  Â  } else {
Â  Â  Â  statusEl.innerHTML = '<span class="text-danger">MÃ£ khÃ´ng há»£p lá»‡!</span>';
Â  Â  }
Â  });
  // ... (Pháº§n code xá»­ lÃ½ import HTML khÃ´ng thay Ä‘á»•i)
  subjectDropdownImport.addEventListener("change", async function() {
Â  Â  importHtmlInput.value = "";
Â  Â  importHtmlResult.innerHTML = "";
Â  Â  saveImportBtn.style.display = "none";
Â  Â  importHtmlInput.disabled = !this.value;
Â  Â  allQuestionsForSubject = this.value ? await loadQuestionsForSubject(this.value) : [];
Â  });

Â  function extractTextAndLaTeX(node) {
Â  Â  let result = "";
Â  Â  if (!node) return result;
Â  Â  node.childNodes.forEach(child => {
Â  Â  Â  if (child.nodeType === Node.TEXT_NODE) {
Â  Â  Â  Â  result += child.textContent;
Â  Â  Â  } else if (child.nodeType === Node.ELEMENT_NODE) {
Â  Â  Â  Â  if (child.tagName === 'SCRIPT' && child.type && child.type.startsWith('math/tex')) {
Â  Â  Â  Â  Â  result += `\\(${child.textContent.trim()}\\)`;
Â  Â  Â  Â  } else if (child.tagName === 'SPAN' && (child.classList.contains('MathJax_Preview') || child.classList.contains('MathJax'))) {
Â  Â  Â  Â  Â  // Bá» qua node nÃ y Ä‘á»ƒ trÃ¡nh lá»—i láº·p
Â  Â  Â  Â  } else if (child.tagName === 'IMG' && child.src) {
Â  Â  Â  Â  Â  imagesFoundCount++;
Â  Â  Â  Â  Â  result += `<span class="image-warning-text">[HÃŒNH áº¢NH]</span>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  result += extractTextAndLaTeX(child);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  Â  return result.replace(/\s+/g, ' ').trim();
Â  }
Â Â 
Â  importHtmlInput.addEventListener("change", async function(e) {
Â  Â  const file = e.target.files[0];
Â  Â  if (!file) return;
Â  Â  const mon_hoc_id = subjectDropdownImport.value;
Â  Â  if (!mon_hoc_id) {
Â  Â  Â  alert("Vui lÃ²ng chá»n mÃ´n há»c Ä‘á»ƒ kiá»ƒm tra trÃ¹ng láº·p!");
Â  Â  Â  return;
Â  Â  }
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = async function(event) {
Â  Â  Â  imagesFoundCount = 0;Â 
Â  Â  Â  const html = event.target.result;
Â  Â  Â  const parser = new DOMParser();
Â  Â  Â  const docx = parser.parseFromString(html, "text/html");
Â  Â  Â  importedQuestions = [];
Â  Â  Â  let rawQuestions = [];
Â  Â  Â  docx.querySelectorAll('.que').forEach(q => {
Â  Â  Â  Â  let qtextNode = q.querySelector('.qtext');
Â  Â  Â  Â  let questionText = qtextNode ? extractTextAndLaTeX(qtextNode) : '';
Â  Â  Â  Â  const answerNodes = Array.from(q.querySelectorAll('.answer > div'));
Â  Â  Â  Â  const answers = answerNodes.map(ansNode => extractTextAndLaTeX(ansNode.querySelector('.flex-fill, div.ml-1, .specificfeedback') || ansNode));
Â  Â  Â  Â  let correctIdx = -1;
Â  Â  Â  Â  const rightAnswerText = q.querySelector('.rightanswer')?.innerText || '';
Â  Â  Â  Â  const match = rightAnswerText.match(/(?:The correct answer is:|CÃ¢u tráº£ lá»i Ä‘Ãºng lÃ :)\s*(.+)$/);

Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  const correctValue = match[1].trim();
Â  Â  Â  Â  Â  correctIdx = answers.findIndex(a => normalizeCompareString(a) === normalizeCompareString(correctValue));
Â  Â  Â  Â  }
Â  Â  Â  Â  if (correctIdx === -1) {
Â  Â  Â  Â  Â  correctIdx = answerNodes.findIndex(node => node.classList.contains('correct'));
Â  Â  Â  Â  }
Â  Â  Â  Â  const correctKey = correctIdx !== -1 ? ['a','b','c','d'][correctIdx] : '';

Â  Â  Â  Â  if (questionText && answers.length >= 2 && correctKey) {
Â  Â  Â  Â  Â  rawQuestions.push({
Â  Â  Â  Â  Â  Â  questionText, answers, correctIdx, correctKey,
Â  Â  Â  Â  Â  Â  lua_chon: { a: answers[0]||"", b: answers[1]||"", c: answers[2]||"", d: answers[3]||"" }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  const tempExistSet = [...allQuestionsForSubject];
Â  Â  Â  importedQuestions = rawQuestions.map(q => {
Â  Â  Â  Â  const isDup = isDuplicateInSet({ noi_dung: q.questionText, dap_an_dung: q.correctKey, lua_chon: q.lua_chon }, tempExistSet);
Â  Â  Â  Â  if(!isDup) tempExistSet.push({ noi_dung: q.questionText, dap_an_dung: q.correctKey, lua_chon: q.lua_chon });
Â  Â  Â  Â  return { ...q, duplicate: isDup };
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  const duplicateCount = importedQuestions.filter(q => q.duplicate).length;
Â  Â  Â  let summaryMessage = `<div class="p-2 bg-light border rounded mb-2">
Â  Â  Â  Â  <b>Tá»•ng quan:</b><br/>
Â  Â  Â  Â  - TrÃ­ch xuáº¥t: <b>${importedQuestions.length}</b> cÃ¢u há»i.<br/>
Â  Â  Â  Â  - PhÃ¡t hiá»‡n: <b>${imagesFoundCount}</b> hÃ¬nh áº£nh (cáº§n thÃªm thá»§ cÃ´ng).<br/>
Â  Â  Â  Â  - TrÃ¹ng láº·p: <b>${duplicateCount}</b> cÃ¢u há»i (sáº½ Ä‘Æ°á»£c bá» qua).
Â  Â  Â  Â  </div>`;
Â  Â  Â  if (imagesFoundCount > 0) {
Â  Â  Â  Â  summaryMessage += `<div class="alert alert-warning small p-2"><b>LÆ°u Ã½:</b> CÃ¡c cÃ¢u há»i chá»©a <span class="image-warning-text">[HÃŒNH áº¢NH]</span> sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u kÃ¨m áº£nh. Vui lÃ²ng chá»‰nh sá»­a vÃ  thÃªm áº£nh thá»§ cÃ´ng sau.</div>`;
Â  Â  Â  }
Â  Â  Â  let htmlResult = summaryMessage;
Â  Â  Â  importedQuestions.forEach((q) => {
Â  Â  Â  Â  htmlResult += `<div class="import-question${q.duplicate ? ' import-duplicate' : ''} border-bottom pb-2 mb-2">
Â  Â  Â  Â  Â  <span class="import-question-title">${q.questionText}</span><br>`;
Â  Â  Â  Â  q.answers.forEach((a,i) => {
Â  Â  Â  Â  Â  htmlResult += `<div class="import-answer${i===q.correctIdx?' import-answer-correct':''}">
Â  Â  Â  Â  Â  Â  ${String.fromCharCode(97+i)}. ${a} ${i===q.correctIdx?'<span class="small"> (ÄÃ¡p Ã¡n Ä‘Ãºng)</span>':''}
Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  if(q.duplicate)
Â  Â  Â  Â  Â  htmlResult += `<div class="import-duplicate-message">[TrÃ¹ng] CÃ¢u há»i nÃ y Ä‘Ã£ cÃ³ trong CSDL vÃ  sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u.</div>`;
Â  Â  Â  Â  htmlResult += `</div>`;
Â  Â  Â  });
Â  Â  Â  importHtmlResult.innerHTML = htmlResult;
Â  Â  Â  if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise();
Â  Â  Â  saveImportBtn.style.display = importedQuestions.length > 0 ? "inline-block" : "none";
Â  Â  Â  if (questionSecOKImport) saveImportBtn.disabled = false;
Â  Â  };
Â  Â  reader.readAsText(file);
Â  });

Â  // Sá»¬A Äá»”I 3: Gá»­i kÃ¨m security_code khi lÆ°u tá»« Import
Â  saveImportBtn.onclick = async function() {
Â  Â  if (!questionSecOKImport) { alert("ChÆ°a xÃ¡c thá»±c mÃ£ báº£o máº­t!"); return; }
Â  Â  const mon_hoc_id = subjectDropdownImport.value;
Â  Â  const questionsToSave = importedQuestions.filter(q => !q.duplicate);
Â  Â  if(questionsToSave.length === 0) {
Â  Â  Â  alert("KhÃ´ng cÃ³ cÃ¢u há»i má»›i nÃ o Ä‘á»ƒ lÆ°u (táº¥t cáº£ Ä‘á»u bá»‹ trÃ¹ng).");
Â  Â  Â  return;
Â  Â  }
Â  Â  saveImportBtn.disabled = true;
Â  Â  saveImportBtn.textContent = "Äang lÆ°u...";
    // Láº¥y mÃ£ báº£o máº­t tá»« Ã´ input
    const securityCode = document.getElementById("questionSecurityCodeImport").value;
Â  Â  let success = 0, fail = 0;
Â  Â  for (const q of questionsToSave) {
Â  Â  Â  try {
Â  Â  Â  Â  await addDoc(collection(db, "cau_hoi"), {
Â  Â  Â  Â  Â  Â  mon_hoc_id,
Â  Â  Â  Â  Â  Â  noi_dung: q.questionText,
Â  Â  Â  Â  Â  Â  noi_dung_img: "",
Â  Â  Â  Â  Â  Â  lua_chon: q.lua_chon,
Â  Â  Â  Â  Â  Â  dap_an_dung: q.correctKey,
            security_code: securityCode // ThÃªm trÆ°á»ng nÃ y
Â  Â  Â  Â  });
Â  Â  Â  Â  success++;
Â  Â  Â  } catch(e) {
Â  Â  Â  Â  fail++;
Â  Â  Â  }
Â  Â  }
Â  Â  alert(`ÄÃ£ lÆ°u ${success} cÃ¢u há»i má»›i, bá» qua ${importedQuestions.length - success} cÃ¢u trÃ¹ng.${fail > 0 ? ` Lá»—i ${fail} cÃ¢u.` : ''}`);
Â  Â  window.location.reload();
Â  };

Â  // Sá»¬A Äá»”I 4: Gá»­i kÃ¨m security_code khi lÆ°u tá»« Manual
Â  manualQuestionForm.addEventListener("submit", async function(e) {
Â  Â  e.preventDefault();
Â  Â  if (!questionSecOKManual) { alert("ChÆ°a xÃ¡c thá»±c mÃ£ báº£o máº­t!"); return; }
Â  Â  const subjectId = document.getElementById("subjectDropdownManual").value;
Â  Â  const qText = document.getElementById("manualQuestionText").value.trim();
Â  Â  const a = document.getElementById("manualAnswerA").value.trim();
Â  Â  const b = document.getElementById("manualAnswerB").value.trim();
Â  Â  const c = document.getElementById("manualAnswerC").value.trim();
Â  Â  const d = document.getElementById("manualAnswerD").value.trim();
Â  Â  const correct = document.getElementById("manualCorrectAnswerDropdown").value;
Â  Â  if (!subjectId || !qText || !a || !b || !c || !d || !correct) { alert("Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin."); return; }

Â  Â  manualSubmitQuestionBtn.disabled = true;
Â  Â  manualSubmitQuestionBtn.textContent = "Äang xá»­ lÃ½...";
Â  Â Â 
Â  Â  let noi_dung_img = '', lua_chon = {a, b, c, d};
Â  Â  try {
Â  Â  Â  Â  if (manualQImgFile) noi_dung_img = await uploadToDrive(manualQImgFile);
Â  Â  Â  Â  if (manualAImgFiles[0]) lua_chon.aImg = await uploadToDrive(manualAImgFiles[0]);
Â  Â  Â  Â  if (manualAImgFiles[1]) lua_chon.bImg = await uploadToDrive(manualAImgFiles[1]);
Â  Â  Â  Â  if (manualAImgFiles[2]) lua_chon.cImg = await uploadToDrive(manualAImgFiles[2]);
Â  Â  Â  Â  if (manualAImgFiles[3]) lua_chon.dImg = await uploadToDrive(manualAImgFiles[3]);
Â  Â  } catch (err) {
Â  Â  Â  Â  alert("Lá»—i upload hÃ¬nh áº£nh: " + err.message);
Â  Â  Â  Â  manualSubmitQuestionBtn.disabled = false;
Â  Â  Â  Â  manualSubmitQuestionBtn.textContent = "ThÃªm cÃ¢u há»i";
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const existSet = await loadQuestionsForSubject(subjectId);
Â  Â  if (isDuplicateInSet({noi_dung: qText, dap_an_dung: correct, lua_chon}, existSet)) {
Â  Â  Â  alert("CÃ¢u há»i nÃ y Ä‘Ã£ tá»“n táº¡i trong mÃ´n há»c vá»›i Ä‘Ã¡p Ã¡n Ä‘Ãºng giá»‘ng nhau!");
Â  Â  Â  manualSubmitQuestionBtn.disabled = false;
Â  Â  Â  manualSubmitQuestionBtn.textContent = "ThÃªm cÃ¢u há»i";
Â  Â  Â  return;
Â  Â  }
    // Láº¥y mÃ£ báº£o máº­t tá»« Ã´ input
    const securityCode = document.getElementById("questionSecurityCodeManual").value;
Â  Â  await addDoc(collection(db, "cau_hoi"), {
Â  Â  Â  mon_hoc_id: subjectId,
Â  Â  Â  noi_dung: qText,
Â  Â  Â  noi_dung_img: noi_dung_img,
Â  Â  Â  lua_chon,
Â  Â  Â  dap_an_dung: correct,
      security_code: securityCode // ThÃªm trÆ°á»ng nÃ y
Â  Â  });
Â  Â  alert("ÄÃ£ thÃªm cÃ¢u há»i!");
Â  Â  window.location.reload();
Â  });

Â  // Sá»¬A Äá»”I 5: Gá»­i kÃ¨m security_code khi lÆ°u Syllabus
Â  document.getElementById("syllabusForm").addEventListener("submit", async function(e) {
Â  Â  e.preventDefault();
Â  Â  if (syllabusSubmitBtn.disabled) { alert("ChÆ°a xÃ¡c thá»±c mÃ£ báº£o máº­t!"); return; }
Â  Â  const subjectId = document.getElementById("syllabusSubjectDropdown").value;
Â  Â  const owner = document.getElementById("syllabusOwner").value.trim();
Â  Â  const fileUrl = document.getElementById("syllabusFileUrlInput").value.trim();
Â  Â  if (!subjectId || !fileUrl) { alert("Äiá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin vÃ  nháº­p Ä‘Æ°á»ng link!"); return; }
Â  Â  syllabusSubmitBtn.disabled = true;
    // Láº¥y mÃ£ báº£o máº­t tá»« Ã´ input
    const securityCode = document.getElementById("syllabusSecurityCode").value;
Â  Â  try {
Â  Â  Â  await addDoc(collection(db, "syllabus"), {
Â  Â  Â  Â  mon_hoc_id: subjectId,
Â  Â  Â  Â  owner: owner,
Â  Â  Â  Â  file_url: fileUrl,
Â  Â  Â  Â  uploaded_at: (new Date()).toISOString(),
        security_code: securityCode // ThÃªm trÆ°á»ng nÃ y
Â  Â  Â  });
Â  Â  Â  alert("ÄÃ£ lÆ°u Ä‘á» cÆ°Æ¡ng!");
Â  Â  Â  window.location.reload();
Â  Â  } catch (e) {
Â  Â  Â  alert("LÆ°u tháº¥t báº¡i: " + e.message);
Â  Â  Â  syllabusSubmitBtn.disabled = false;
Â  Â  }
Â  });
});
</script>
</body>
</html>
