<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒê·ªÅ c∆∞∆°ng m√¥n h·ªçc</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{padding-top:70px;font-family:Roboto,Arial,sans-serif}
    .online-counter-box {
      background-color: #e8f5e9;
      color: #2e7d32;
      border-left: 5px solid #4caf50;
      padding: 10px 16px;
      margin: 20px auto 10px;
      border-radius: 6px;
      max-width: 600px;
      font-weight: 500;
    }
    .subject-btns .btn{margin-right:6px}
    .nav-link,.navbar-brand{font-family:Roboto,Arial,sans-serif}
    .subject-title-icon{font-size:1.15em;margin-right:6px}
    .syllabus-list{margin-top:10px}
    .syllabus-item{padding:7px 0;border-bottom:1px dashed #eee}
    .syllabus-link{font-weight:500;color:#06c;text-decoration:underline}
    .syllabus-owner{font-size:.95em;color:#333}
  </style>
</head>
<body class="bg-light">
  <header id="navbar-placeholder"></header>

  <div class="online-counter-box text-center">
    üü¢ Hi·ªán c√≥ B·∫°n v√† <span id="online-counter">0</span> ng∆∞·ªùi n·ªØa ƒëang truy c·∫≠p h·ªá th·ªëng.
  </div>

  <div class="container py-4">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">üìÇ T·∫£i ƒë·ªÅ c∆∞∆°ng theo m√¥n</h5>
        <div id="subjectList"><div>ƒêang t·∫£i...</div></div>
      </div>
    </div>
  </div>

  <!-- Firebase modular SDK s·∫Ω ƒë∆∞·ª£c import trong script type="module" -->
  <script type="module">
    // S·ª¨ D·ª§NG HO√ÄN TO√ÄN FIREBASE MODULAR SDK (kh√¥ng mix compat + modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getDatabase, ref, onValue, onDisconnect, set, push
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ==== FIREBASE CONFIG ====
    const firebaseConfig = {
      apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92c",
      authDomain: "tracuu-d3ee9.firebaseapp.com",
      projectId: "tracuu-d3ee9",
      storageBucket: "tracuu-d3ee9.appspot.com",
      messagingSenderId: "593568604435",
      appId: "1:593568604435:web:9a5145457a8ee734143ae6"
    };

    // Kh·ªüi t·∫°o app 1 l·∫ßn
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app, "https://tracuu-d3ee9-default-rtdb.asia-southeast1.firebasedatabase.app");

    // ==== Firestore helpers ====
    async function getSubjects() {
      const snap = await getDocs(collection(db, "mon_hoc"));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    async function getAllSyllabus() {
      const snap = await getDocs(collection(db, "syllabus"));
      // Return object with id and data, keep uploaded_at as-is (could be timestamp)
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // ==== Utilities ====
    function formatUploadedAt(value) {
      // value can be Firestore Timestamp, ISO string, or number
      if (!value) return "";
      // Firestore Timestamp has toDate()
      if (value && typeof value.toDate === "function") {
        return value.toDate();
      }
      const date = new Date(value);
      if (!isNaN(date)) return date;
      return null;
    }

    // ==== UI: load subjects and show syllabus list per subject ====
    let allSyllabus = [];
    async function loadSubjectsAndSyllabus() {
      const container = document.getElementById("subjectList");
      container.innerHTML = "<div>ƒêang t·∫£i...</div>";
      try {
        const [subjects, syllabi] = await Promise.all([getSubjects(), getAllSyllabus()]);
        allSyllabus = syllabi || [];
        if (!subjects || subjects.length === 0) {
          container.innerHTML = "<div>Kh√¥ng c√≥ d·ªØ li·ªáu m√¥n h·ªçc.</div>";
          return;
        }
        container.innerHTML = "";
        subjects.forEach(subject => {
          const wrap = document.createElement("div");
          wrap.className = "d-flex align-items-center justify-content-between border-bottom py-2";
          wrap.innerHTML = `
            <div>
              <span class="fw-bold"><span class="subject-title-icon">üìò</span>${subject.ten_mon || subject.id}</span>
            </div>
            <div class="subject-btns">
              <button class="btn btn-sm btn-outline-primary" data-id="${subject.id}" data-name="${subject.ten_mon || ''}">‚¨áÔ∏è Download</button>
            </div>
          `;
          const btn = wrap.querySelector("button");
          btn.addEventListener("click", function () {
            const subjId = this.getAttribute("data-id");
            const subjName = this.getAttribute("data-name") || subjId;
            // Toggle: n·∫øu ƒë√£ hi·ªán danh s√°ch -> remove; n·∫øu ch∆∞a -> render
            const existing = wrap.querySelector(".syllabus-list");
            if (existing) {
              existing.remove();
              return;
            }
            const listEl = document.createElement("div");
            listEl.className = "syllabus-list";
            listEl.innerHTML = "<div>ƒêang t·∫£i ƒë·ªÅ c∆∞∆°ng...</div>";
            wrap.appendChild(listEl);

            // L·ªçc v√† sort syllabus theo uploaded_at (m·ªõi nh·∫•t tr∆∞·ªõc)
            const items = allSyllabus
              .filter(s => String(s.mon_hoc_id) === String(subjId))
              .map(s => {
                const dateObj = formatUploadedAt(s.uploaded_at);
                return { ...s, _uploaded_date: dateObj ? dateObj.getTime() : 0 };
              })
              .sort((a, b) => (b._uploaded_date || 0) - (a._uploaded_date || 0));

            listEl.innerHTML = "";
            if (!items || items.length === 0) {
              listEl.innerHTML = `<div class="text-danger">Ch∆∞a c√≥ ƒë·ªÅ c∆∞∆°ng n√†o cho m√¥n <b>${subjName}</b>.</div>`;
              return;
            }
            items.forEach((s, idx) => {
              const item = document.createElement("div");
              item.className = "syllabus-item";
              const uploadedStr = s._uploaded_date ? new Date(s._uploaded_date).toLocaleString("vi-VN") : "";
              item.innerHTML = `
                <a class="syllabus-link" href="${s.file_url || '#'}" target="_blank" rel="noopener noreferrer">
                  üóÇÔ∏è ${s.file_name || ("ƒê·ªÅ c∆∞∆°ng " + (idx + 1))}
                </a>
                ${s.owner ? `<span class="syllabus-owner"> - ng∆∞·ªùi upload: ${s.owner}</span>` : ""}
                <span style="font-size:0.91em; color:#666; margin-left:6px;">
                  (${uploadedStr})
                </span>
              `;
              listEl.appendChild(item);
            });
          });
          container.appendChild(wrap);
        });
      } catch (err) {
        console.error("L·ªói khi load subjects/ syllabi:", err);
        container.innerHTML = "<div class='text-danger'>L·ªói khi t·∫£i d·ªØ li·ªáu. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.</div>";
      }
    }

    // ==== Realtime DB: online counter ====
    const onlineCounterEl = document.getElementById('online-counter');
    if (onlineCounterEl) {
      try {
        const connectionsRef = ref(rtdb, 'connections');
        const myConnectionRef = push(connectionsRef);
        onDisconnect(myConnectionRef).remove();
        // mark as online
        set(myConnectionRef, true).catch(err => console.error("set connection error", err));
        onValue(connectionsRef, (snapshot) => {
          const val = snapshot.val();
          let count = 0;
          if (!snapshot.exists()) {
            count = 0;
          } else if (val && typeof val === 'object') {
            count = Object.keys(val).length;
          } else {
            // fallback: if value is single primitive, treat as 1
            count = 1;
          }
          onlineCounterEl.textContent = count;
        }, err => {
          console.error("onValue connections error", err);
        });
      } catch (err) {
        console.error("Realtime DB init error", err);
      }
    }

    // ==== INIT ====
    loadSubjectsAndSyllabus();

    // Expose for debug (optional)
    window._debug_app = { app, db, rtdb };

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // T·∫£i n·ªôi dung c·ªßa file menu.html (n·∫øu c√≥)
    fetch('/menu.html')
      .then(response => response.text())
      .then(data => { document.getElementById('navbar-placeholder').innerHTML = data; })
      .catch(err => console.warn('Kh√¥ng th·ªÉ t·∫£i menu.html', err));
  </script>
</body>
</html>
