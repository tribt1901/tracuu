<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Th√¥ng B√°o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Th∆∞ vi·ªán icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- === B·ªî SUNG C√îNG C·ª§ SO·∫†N TH·∫¢O (Quill.js) === -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- === K·∫æT TH√öC B·ªî SUNG === -->

    <style>
        body { font-family: 'Inter', sans-serif; }
        #edit-modal { transition: opacity 0.3s ease-in-out; }
        /* Th√™m style cho b·ªô ƒë·∫øm online */
        .online-counter-box {
            background-color: #e0f2fe; /* light-blue-100 */
            border: 1px solid #7dd3fc; /* light-blue-300 */
            color: #075985; /* cyan-800 */
            font-weight: 500;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        /* Style cho tr√¨nh so·∫°n th·∫£o Quill */
        .ql-editor {
            min-height: 200px;
        }
        .ql-toolbar.ql-snow {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            border-color: #D1D5DB; /* gray-300 */
        }
        .ql-container.ql-snow {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            border-color: #D1D5DB; /* gray-300 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- HEADER ƒê√É ƒê∆Ø·ª¢C THAY TH·∫æ ƒê·ªÇ N·∫†P MENU ƒê·ªòNG -->
    <header id="navbar-placeholder"></header>

    <main class="container mx-auto px-6 py-8">
        
        <!-- B·ªò ƒê·∫æM ONLINE M·ªöI ƒê∆Ø·ª¢C TH√äM V√ÄO -->
        <div class="online-counter-box">
            üü¢ Hi·ªán c√≥ B·∫°n v√† <span id="online-counter">0</span> ng∆∞·ªùi n·ªØa ƒëang truy c·∫≠p h·ªá th·ªëng.
        </div>

        <!-- N·ªòI DUNG TRANG G·ªêC (TRONG GRID) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- C·ªôt th√™m m·ªõi th√¥ng b√°o -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-lg sticky top-8">
                    <h2 class="text-xl font-bold mb-6 text-gray-700">Th√™m Th√¥ng B√°o M·ªõi</h2>
                    <form id="add-announcement-form">
                        <div class="mb-4">
                            <label for="title" class="block text-gray-700 font-medium mb-2">Ti√™u ƒë·ªÅ</label>
                            <input type="text" id="title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        
                        <!-- === THAY TH·∫æ TEXTAREA B·∫∞NG QUIL === -->
                        <div class="mb-4">
                            <label for="editor-add" class="block text-gray-700 font-medium mb-2">N·ªôi dung</label>
                            <div id="editor-add-container" class="bg-white rounded-lg">
                                <div id="editor-add"></div>
                            </div>
                        </div>
                        <!-- === K·∫æT TH√öC THAY TH·∫æ === -->

                        <div class="mb-6">
                            <label for="category" class="block text-gray-700 font-medium mb-2">Danh m·ª•c</label>
                            <select id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option>Th√¥ng Tin Chung</option>
                                <option>Quan Tr·ªçng</option>
                                <option>L·ªãch H·ªçc</option>
                                <option>S·ª± Ki·ªán</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">ƒêƒÉng Th√¥ng B√°o</button>
                    </form>
                </div>
            </div>

            <!-- C·ªôt qu·∫£n l√Ω th√¥ng b√°o ƒë√£ ƒëƒÉng -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-6 text-gray-700">Danh S√°ch Th√¥ng B√°o</h2>
                    <div id="announcements-list" class="space-y-4">
                        <!-- Danh s√°ch th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal ƒë·ªÉ ch·ªânh s·ª≠a th√¥ng b√°o -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg">
            <h2 class="text-xl font-bold mb-6">Ch·ªânh S·ª≠a Th√¥ng B√°o</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="mb-4">
                    <label for="edit-title" class="block text-gray-700 font-medium mb-2">Ti√™u ƒë·ªÅ</label>
                    <input type="text" id="edit-title" class="w-full px-4 py-2 border rounded-lg" required>
                </div>

                <!-- === THAY TH·∫æ TEXTAREA B·∫∞NG QUIL (EDIT) === -->
                <div class="mb-4">
                    <label for="editor-edit" class="block text-gray-700 font-medium mb-2">N·ªôi dung</label>
                    <div id="editor-edit-container" class="bg-white rounded-lg">
                        <div id="editor-edit"></div>
                    </div>
                </div>
                <!-- === K·∫æT TH√öC THAY TH·∫æ === -->

                <div class="mb-6">
                    <label for="edit-category" class="block text-gray-700 font-medium mb-2">Danh m·ª•c</label>
                    <select id="edit-category" class="w-full px-4 py-2 border rounded-lg bg-white">
                        <option>Th√¥ng Tin Chung</option> <option>Quan Tr·ªçng</option> <option>L·ªãch H·ªçc</option> <option>S·ª± Ki·ªán</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-edit" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">L∆∞u Thay ƒê·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS (ƒê√É G·ªòP) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // IMPORT M·ªöI CHO REALTIME DATABASE
        import { getDatabase, ref, push, onDisconnect, set, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // === BI·∫æN TO√ÄN C·ª§C CHO TR√åNH SO·∫†N TH·∫¢O ===
        let quillAdd, quillEdit;

        // === H√ÄM TI·ªÜN √çCH: L·ªåC HTML ƒê·ªÇ XEM TR∆Ø·ªöC ===
        function stripHtml(html) {
            const tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return (tmp.textContent || tmp.innerText || "").replace(/\s+/g, ' ').trim();
        }

        // --- FIREBASE CONFIG (ƒê√É THAY TH·∫æ B·∫∞NG CONFIG M·ªöI) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92c",
            authDomain: "tracuu-d3ee9.firebaseapp.com",
            databaseURL: "https://tracuu-d3ee9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tracuu-d3ee9",
            storageBucket: "tracuu-d3ee9.appspot.com",
            messagingSenderId: "593568604435",
            appId: "1:593568604435:web:9a5145457a8ee734143ae6"
        };

        // --- KH·ªûI T·∫†O (ƒê√É TH√äM RTDB) ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const rtdb = getDatabase(app, firebaseConfig.databaseURL); // KH·ªûI T·∫†O M·ªöI
        const announcementsCol = collection(db, 'announcements');

        // ---- X·ª¨ L√ù X√ÅC TH·ª∞C (GI·ªÆ NGUY√äN) ----
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Chuy·ªÉn h∆∞·ªõng n·∫øu kh√¥ng c√≥ ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p
                // S·ª¨A L·ªñI: Th√™m "./" ƒë·ªÉ t·∫°o URL h·ª£p l·ªá trong m√¥i tr∆∞·ªùng sandboxed
                window.location.href = "./ad.login.html";
            }
        });

        // ---- X·ª¨ L√ù TH√äM M·ªöI (C·∫¨P NH·∫¨T ƒê·ªÇ D√ôNG QUIL) ----
        const addForm = document.getElementById('add-announcement-form');
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = quillAdd.root.innerHTML; // L·∫•y n·ªôi dung HTML t·ª´ Quill
            const title = addForm.title.value;
            const category = addForm.category.value;

            // Ki·ªÉm tra n·ªôi dung r·ªóng (Quill c√≥ th·ªÉ tr·∫£ v·ªÅ "<p><br></p>")
            if (stripHtml(content).length === 0 || title.trim().length === 0) {
                // T·∫°m th·ªùi d√πng alert, nh∆∞ng n√™n thay b·∫±ng modal custom
                console.warn("Vui l√≤ng nh·∫≠p c·∫£ ti√™u ƒë·ªÅ v√† n·ªôi dung."); 
                return;
            }

            try {
                await addDoc(announcementsCol, {
                    title: title,
                    content: content, // L∆∞u n·ªôi dung HTML
                    category: category,
                    createdAt: serverTimestamp()
                });
                
                // X√≥a n·ªôi dung form
                addForm.title.value = '';
                addForm.category.value = 'Th√¥ng Tin Chung';
                quillAdd.setText(''); // X√≥a n·ªôi dung trong Quill

            } catch (error) {
                console.error("L·ªói khi th√™m: ", error);
            }
        });

        // ---- X·ª¨ L√ù HI·ªÇN TH·ªä, S·ª¨A, X√ìA (C·∫¨P NH·∫¨T ƒê·ªÇ HI·ªÇN TH·ªä HTML) ----
        const listContainer = document.getElementById('announcements-list');
        const q = query(announcementsCol, orderBy('createdAt', 'desc'));

        onSnapshot(q, (snapshot) => {
            listContainer.innerHTML = '';
            if (snapshot.empty) {
                listContainer.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ th√¥ng b√°o n√†o.</p>';
                return;
            }
            snapshot.forEach(docSnap => {
                const announcement = docSnap.data();
                const div = document.createElement('div');
                div.className = "border p-4 rounded-lg bg-gray-50 flex justify-between items-start";
                
                // L·ªçc HTML ƒë·ªÉ xem tr∆∞·ªõc v√† c·∫Øt ng·∫Øn
                const plainContent = stripHtml(announcement.content);
                const isTruncated = plainContent.length > 100;
                const shortContent = isTruncated ? plainContent.substring(0, 100) + '...' : plainContent;

                div.innerHTML = `
                    <div class="flex-grow mr-4 overflow-hidden"> <!-- Th√™m overflow-hidden -->
                        <h3 class="font-bold text-lg break-words">${announcement.title}</h3>
                        
                        <!-- short-content hi·ªÉn th·ªã vƒÉn b·∫£n thu·∫ßn -->
                        <p class="text-sm text-gray-600 short-content">${shortContent}</p>
                        
                        <!-- full-content s·∫Ω render n·ªôi dung HTML -->
                        <div class="text-sm text-gray-800 full-content hidden mt-2">${announcement.content}</div>

                        ${isTruncated ? `<button class="toggle-content-btn text-indigo-600 hover:underline text-sm mt-2" data-state="collapsed">Xem th√™m</button>` : ''}
                        
                        <span class="text-xs font-semibold text-indigo-600 mt-4 block">${announcement.category}</span>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0 ml-4">
                        <button data-id="${docSnap.id}" class="edit-btn text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                        <button data-id="${docSnap.id}" class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        });

        // ---- X·ª¨ L√ù S·ª∞ KI·ªÜN CLICK S·ª¨A/X√ìA/XEM TH√äM (C·∫¨P NH·∫¨T CHO QUIL) ----
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const cancelEditBtn = document.getElementById('cancel-edit');
        
        listContainer.addEventListener('click', async (e) => {
            const target = e.target;
            if (!target) return;

            // X·ª≠ l√Ω xem th√™m/thu g·ªçn (Kh√¥ng thay ƒë·ªïi)
            if (target.classList.contains('toggle-content-btn')) {
                const wrapper = target.closest('.flex-grow');
                const shortContent = wrapper.querySelector('.short-content');
                const fullContent = wrapper.querySelector('.full-content');

                if (target.dataset.state === 'collapsed') {
                    shortContent.classList.add('hidden');
                    fullContent.classList.remove('hidden');
                    target.textContent = 'Thu g·ªçn';
                    target.dataset.state = 'expanded';
                } else {
                    shortContent.classList.remove('hidden');
                    fullContent.classList.add('hidden');
                    target.textContent = 'Xem th√™m';
                    target.dataset.state = 'collapsed';
                }
                return;
            }

            // X·ª≠ l√Ω c√°c n√∫t kh√°c (s·ª≠a/x√≥a)
            const button = target.closest('button');
            if (!button) return; 

            const id = button.dataset.id;
            if (!id) return;

            // X·ª≠ l√Ω x√≥a (Kh√¥ng thay ƒë·ªïi)
            if (button.classList.contains('delete-btn')) {
                // V·∫´n d√πng confirm, nh∆∞ng ƒë√£ b·ªè alert() ·ªü c√°c ch·ªó kh√°c
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√¥ng b√°o n√†y?')) {
                    try {
                        await deleteDoc(doc(db, 'announcements', id));
                    } catch (error) {
                        console.error("L·ªói khi x√≥a:", error);
                    }
                }
            }
            
            // X·ª≠ l√Ω s·ª≠a (m·ªü modal) (C·∫¨P NH·∫¨T CHO QUIL)
            if (button.classList.contains('edit-btn')) {
                const docRef = doc(db, 'announcements', id);
                const docSnap = await getDoc(docRef);

                if(docSnap.exists()){
                    const data = docSnap.data();
                    editForm['edit-id'].value = id;
                    editForm['edit-title'].value = data.title;
                    // T·∫£i n·ªôi dung HTML v√†o tr√¨nh so·∫°n th·∫£o Quill
                    quillEdit.root.innerHTML = data.content; 
                    editForm['edit-category'].value = data.category;
                    editModal.classList.remove('hidden');
                } else {
                    console.error("Kh√¥ng t√¨m th·∫•y t√†i li·ªáu ƒë·ªÉ s·ª≠a!");
                }
            }
        });

        // X·ª≠ l√Ω khi submit form s·ª≠a (C·∫¨P NH·∫¨T CHO QUIL)
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editForm['edit-id'].value;
            const content = quillEdit.root.innerHTML; // L·∫•y HTML t·ª´ Quill

            try {
                const docRef = doc(db, 'announcements', id);
                await updateDoc(docRef, {
                    title: editForm['edit-title'].value,
                    content: content, // C·∫≠p nh·∫≠t n·ªôi dung HTML
                    category: editForm['edit-category'].value
                });
                editModal.classList.add('hidden');
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t:", error);
            }
        });
        
        // ƒê√≥ng modal khi nh·∫•n n√∫t H·ªßy (Kh√¥ng thay ƒë·ªïi)
        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // --- CODE M·ªöI ƒê·ªÇ N·∫†P MENU, B·ªò ƒê·∫æM, V√Ä KH·ªûI T·∫†O QUIL ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Kh·ªüi t·∫°o Quill Editors ---
            const quillOptions = {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'indent': '-1'}, { 'indent': '+1' }],
                        ['link'],
                        ['clean']
                    ]
                }
            };
            try {
                quillAdd = new Quill('#editor-add', quillOptions);
                quillEdit = new Quill('#editor-edit', quillOptions);
            } catch(e) {
                console.error("L·ªói kh·ªüi t·∫°o Quill:", e);
            }


            // --- Online counter (Realtime DB modular) ---
            (function initOnlineCounter() {
                const onlineCounterEl = document.getElementById('online-counter');
                if (!onlineCounterEl) return;
                try {
                    const connectionsRef = ref(rtdb, 'connections');
                    const myConnectionRef = push(connectionsRef);
                    onDisconnect(myConnectionRef).remove().catch(() => {});
                    set(myConnectionRef, true).catch(() => {});
                    onValue(connectionsRef, snapshot => {
                        const val = snapshot.val ? snapshot.val() : (snapshot && snapshot.exists ? snapshot.exists() && snapshot.val() : null);
                        let count = 0;
                        try {
                            const v = snapshot.val();
                            if (!snapshot.exists()) count = 0;
                            else if (v && typeof v === 'object') count = Object.keys(v).length;
                            else count = 1; // ƒê·∫øm l√† 1 n·∫øu t·ªìn t·∫°i nh∆∞ng kh√¥ng ph·∫£i object (tr∆∞·ªùng h·ª£p hi·∫øm)
                        } catch (e) {
                            count = 0;
                        }
                        onlineCounterEl.textContent = count;
                    }, err => {
                        console.error("onValue connections error", err);
                    });
                } catch (err) {
                    console.error("Realtime counter init error", err);
                }
            })();

            // --- N·∫°p Menu v√† x·ª≠ l√Ω Logout ---
            // S·ª¨A L·ªñI: Th√™m "./" ƒë·ªÉ tr√¨nh duy·ªát x·ª≠ l√Ω URL t∆∞∆°ng ƒë·ªëi ch√≠nh x√°c
            fetch('./menu.html').then(r => r.text()).then(html => {
                const placeholder = document.getElementById('navbar-placeholder');
                if(placeholder) {
                    placeholder.innerHTML = html;
                }
                
                // LOGIC LOGOUT ƒê∆Ø·ª¢C DI CHUY·ªÇN V√ÄO ƒê√ÇY
                const logoutBtn = document.getElementById("logoutBtn");
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", () => {
                        signOut(auth).then(() => {
                            // S·ª¨A L·ªñI: Th√™m "./" ƒë·ªÉ t·∫°o URL h·ª£p l·ªá
                            window.location.href = "./ad.login";
                        }).catch((error) => {
                            console.error("L·ªói khi ƒëƒÉng xu·∫•t:", error);
                            console.error("ƒê√£ c√≥ l·ªói x·∫£y ra khi ƒëƒÉng xu·∫•t.");
                        });
                    });
                } else {
                    console.warn("Kh√¥ng t√¨m th·∫•y 'logoutBtn' trong menu.html ƒë∆∞·ª£c n·∫°p.");
                }
            }).catch((err) => {
                console.error("L·ªói khi n·∫°p menu.html:", err);
            });
        });

    </script>
</body>
</html>

